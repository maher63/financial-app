<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0f1a" id="theme-color-meta">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="المحفظة">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="manifest" href="manifest.json">
    <title>المحفظة الذكية</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* Dark Theme (Default) */
        :root, [data-theme="dark"] {
            --bg-primary: #0a0f1a;
            --bg-secondary: #111827;
            --bg-card: #1a2332;
            --bg-input: #243044;
            --bg-hover: #2d3a4f;
            --text-primary: #ffffff;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-gold: #f59e0b;
            --accent-purple: #8b5cf6;
            --border-color: #2d3748;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --shadow-color: rgba(0,0,0,0.3);
        }
        
        /* Light Theme */
        [data-theme="light"] {
            --bg-primary: #f1f5f9;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-input: #e2e8f0;
            --bg-hover: #cbd5e1;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border-color: #cbd5e1;
            --shadow-color: rgba(0,0,0,0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding-bottom: 90px;
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* Touch feedback */
        .touch-feedback {
            transition: transform 0.1s ease, opacity 0.1s ease;
        }
        
        .touch-feedback:active {
            transform: scale(0.97);
            opacity: 0.8;
        }
        
        /* Minimum touch target size */
        button, .btn, .toggle-btn, .nav-item, .settings-item, .transaction-item {
            min-height: 48px;
        }
        
        /* SAR Symbol */
        .sar-symbol {
            width: 0.9em;
            height: 0.9em;
            fill: currentColor;
            vertical-align: middle;
            margin-right: 4px;
        }
        
        .sar-symbol-inline {
            width: 0.85em;
            height: 0.85em;
            fill: currentColor;
            vertical-align: middle;
        }
        
        .money-display {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            direction: ltr;
            unicode-bidi: embed;
        }
        
        .money-with-sar {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            direction: ltr;
        }
        
        /* Money Display - Symbol always on LEFT of number */
        .money {
            display: inline-flex;
            flex-direction: row-reverse;
            align-items: center;
            gap: 4px;
            direction: ltr;
        }
        
        .money-value {
            font-variant-numeric: tabular-nums;
        }
        
        .money-currency {
            display: inline-flex;
            align-items: center;
            opacity: 0.85;
        }
        
        /* Header */
        .header {
            background: var(--bg-secondary);
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 50;
        }
        
        .header-title {
            font-size: 1.1rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .header-logo svg {
            width: 20px;
            height: 20px;
            color: white;
        }
        
        .icon-btn {
            width: 40px;
            height: 40px;
            min-width: 40px;
            min-height: 40px;
            border-radius: var(--radius-md);
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            aspect-ratio: 1 / 1;
        }
        
        .icon-btn:active { transform: scale(0.95); }
        .icon-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
        .icon-btn svg { width: 20px; height: 20px; }
        
        .icon-btn.small {
            width: 32px;
            height: 32px;
            min-width: 32px;
            min-height: 32px;
            border-radius: var(--radius-sm);
        }
        .icon-btn.small svg { width: 16px; height: 16px; }
        
        /* Balance Section */
        .balance-section {
            padding: 28px 20px 20px;
            text-align: center;
            background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
        }
        
        .balance-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
            font-weight: 600;
        }
        
        .balance-amount {
            font-size: 2.75rem;
            font-weight: 900;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            direction: ltr;
        }
        
        .balance-amount .sar-symbol {
            width: 28px;
            height: 28px;
        }
        
        .balance-egp {
            font-size: 1.1rem;
            color: var(--accent-green);
            font-weight: 700;
            margin-top: 2px;
        }
        
        .balance-egp-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
            padding: 0 16px;
        }
        
        .action-btn {
            width: 100px;
            height: 90px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            border-radius: var(--radius-lg);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .action-btn:active { transform: scale(0.95); }
        
        .action-btn.income {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
            border: 1px solid rgba(16, 185, 129, 0.25);
        }
        
        .action-btn.expense {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
            border: 1px solid rgba(239, 68, 68, 0.25);
        }
        
        .action-btn.convert {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent-blue);
            border: 1px solid rgba(59, 130, 246, 0.25);
        }
        
        .action-btn-icon {
            width: 42px;
            height: 42px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .action-btn.income .action-btn-icon { background: rgba(16, 185, 129, 0.2); }
        .action-btn.expense .action-btn-icon { background: rgba(239, 68, 68, 0.2); }
        .action-btn.convert .action-btn-icon { background: rgba(59, 130, 246, 0.2); }
        
        .action-btn svg { width: 22px; height: 22px; }
        .action-btn span { font-size: 0.8rem; font-weight: 700; }
        
        /* Section */
        .section {
            padding: 0 16px;
            margin-bottom: 20px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 0 4px;
        }
        
        .section-title {
            font-size: 1rem;
            font-weight: 800;
            color: var(--text-primary);
        }
        
        .section-action {
            font-size: 0.8rem;
            color: var(--accent-blue);
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 700;
            font-family: inherit;
        }
        
        /* Card */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 18px;
            border: 1px solid var(--border-color);
        }
        
        /* NEW: Improved Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .stat-widget {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 16px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            min-height: 85px;
        }
        
        .stat-widget.stat-widget-vertical {
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: 6px;
            padding: 14px 8px;
            min-height: 100px;
        }
        
        .stat-widget.stat-widget-vertical .stat-widget-title {
            font-size: 0.7rem;
            line-height: 1.3;
            order: 2;
        }
        
        .stat-widget.stat-widget-vertical .stat-widget-value {
            font-size: 1rem;
            order: 3;
        }
        
        .stat-widget.stat-widget-vertical .stat-widget-sub {
            font-size: 0.65rem;
            order: 4;
        }
        
        .stat-widget-icon-small {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            order: 1;
        }
        
        .stat-widget-icon-small svg { width: 16px; height: 16px; }
        .stat-widget-icon-small.green { background: rgba(16, 185, 129, 0.15); color: var(--accent-green); }
        .stat-widget-icon-small.red { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); }
        .stat-widget-icon-small.gold { background: rgba(245, 158, 11, 0.15); color: var(--accent-gold); }
        .stat-widget-icon-small.blue { background: rgba(59, 130, 246, 0.15); color: var(--accent-blue); }
        
        .stat-widget-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stat-widget-icon {
            width: 42px;
            height: 42px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .stat-widget-icon svg { width: 20px; height: 20px; }
        .stat-widget-icon.green { background: rgba(16, 185, 129, 0.15); color: var(--accent-green); }
        .stat-widget-icon.red { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); }
        .stat-widget-icon.gold { background: rgba(245, 158, 11, 0.15); color: var(--accent-gold); }
        .stat-widget-icon.blue { background: rgba(59, 130, 246, 0.15); color: var(--accent-blue); }
        
        .stat-widget-title {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--text-secondary);
        }
        
        .stat-widget-left {
            text-align: left;
            direction: ltr;
        }
        
        .stat-widget-value {
            font-size: 1.15rem;
            font-weight: 900;
        }
        
        .stat-widget-value.green { color: var(--accent-green); }
        .stat-widget-value.red { color: var(--accent-red); }
        .stat-widget-value.blue { color: var(--accent-blue); }
        .stat-widget-value.gold { color: var(--accent-gold); }
        
        .stat-widget-sub {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 2px;
        }
        
        /* Budget Widget */
        .budget-widget {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 18px;
            border: 1px solid var(--border-color);
            margin-bottom: 16px;
        }
        
        .budget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .budget-title {
            font-size: 0.95rem;
            font-weight: 800;
            color: var(--text-primary);
        }
        
        .budget-amount-display {
            font-size: 1.3rem;
            font-weight: 900;
            color: var(--text-primary);
        }
        
        .budget-sub-info {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .budget-percent {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
        }
        
        .budget-of-total {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .budget-badge {
            font-size: 0.8rem;
            font-weight: 700;
            padding: 4px 12px;
            border-radius: 20px;
        }
        
        .budget-badge.safe { background: rgba(16, 185, 129, 0.15); color: var(--accent-green); }
        .budget-badge.warning { background: rgba(245, 158, 11, 0.15); color: var(--accent-gold); }
        .budget-badge.danger { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); }
        
        .budget-alert-banner {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: var(--radius-md);
            margin-top: 12px;
            color: var(--accent-gold);
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .smart-alerts-container {
            padding: 0 16px;
            margin-bottom: 8px;
        }
        
        .smart-alert-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: var(--radius-md);
            color: var(--accent-gold);
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .smart-alert-item::before {
            content: '';
            width: 18px;
            height: 18px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23f59e0b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z'/%3E%3C/svg%3E");
            background-size: contain;
            flex-shrink: 0;
        }
        
        .progress-bar {
            height: 10px;
            background: var(--bg-input);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s ease;
        }
        
        /* Summary Cards Row */
        .summary-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .summary-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 14px;
            border: 1px solid var(--border-color);
            text-align: center;
        }
        
        .summary-card-title {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 6px;
            font-weight: 600;
        }
        
        .summary-card-value {
            font-size: 1rem;
            font-weight: 800;
        }
        
        .summary-card-sub {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 2px;
        }
        
        .summary-card-net {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 4px;
            font-weight: 600;
        }
        
        /* Transaction List */
        .transaction-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .transaction-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: var(--bg-input);
            border-radius: var(--radius-lg);
        }
        
        .transaction-icon {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .transaction-icon svg { width: 20px; height: 20px; }
        .transaction-icon.income { background: rgba(16, 185, 129, 0.15); color: var(--accent-green); }
        .transaction-icon.expense { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); }
        
        .transaction-details { flex: 1; min-width: 0; }
        .transaction-name { font-size: 0.9rem; font-weight: 700; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .transaction-date { font-size: 0.75rem; color: var(--text-muted); }
        
        .transaction-amounts { text-align: left; flex-shrink: 0; }
        .transaction-amount { font-size: 0.95rem; font-weight: 800; }
        .transaction-amount.income { color: var(--accent-green); }
        .transaction-amount.expense { color: var(--accent-red); }
        .transaction-converted { font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 10px 8px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            z-index: 100;
        }
        
        .bottom-nav::-webkit-scrollbar { display: none; }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 6px;
            border-radius: var(--radius-md);
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .nav-item svg {
            width: 26px;
            height: 26px;
        }
        
        .nav-item span {
            font-size: 0.7rem;
            font-weight: 700;
            font-family: 'Tajawal', sans-serif;
        }
        
        .nav-item.active {
            color: var(--accent-blue);
        }
        
        .nav-item.active svg {
            color: var(--accent-blue);
        }
        
        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
        }
        
        .modal-overlay.active { display: flex; }
        
        .modal-content {
            background: var(--bg-secondary);
            width: calc(100% - 32px);
            max-width: 420px;
            border-radius: var(--radius-xl);
            max-height: 85vh;
            animation: modalPop 0.3s ease;
            margin: 16px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        @keyframes modalPop {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        
        .modal-body {
            padding: 20px 24px;
            overflow-y: auto;
            flex: 1;
        }
        
        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        
        .modal-footer .btn {
            width: 100%;
        }
        
        .modal-title {
            font-size: 1.2rem;
            font-weight: 800;
        }
        
        .modal-close {
            width: 36px;
            height: 36px;
            min-width: 36px;
            min-height: 36px;
            border-radius: 10px;
            background: var(--bg-input);
            border: none;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            aspect-ratio: 1 / 1;
        }
        
        .modal-close svg { width: 18px; height: 18px; }
        
        /* Form Elements */
        .form-group { margin-bottom: 18px; }
        
        .form-label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-input);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 1rem;
            color: var(--text-primary);
            font-family: 'Tajawal', sans-serif;
            transition: all 0.2s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        
        .form-input::placeholder { color: var(--text-muted); }
        
        .form-select {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-input);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 14px center;
            background-size: 20px;
            padding-left: 44px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 50px;
        }
        
        .form-select:focus {
            outline: none;
            border-color: var(--accent-blue);
            background-color: var(--bg-hover);
        }
        
        .form-select:hover {
            border-color: var(--text-muted);
        }
        
        .form-select option {
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 14px;
            font-weight: 500;
            font-size: 1rem;
        }
        
        .form-select optgroup {
            background: var(--bg-input);
            color: var(--text-muted);
            font-weight: 700;
            font-size: 0.85rem;
        }
        
        .form-select-small {
            padding: 10px 12px;
            font-size: 0.85rem;
            padding-left: 32px;
            background-size: 16px;
            background-position: left 10px center;
            min-height: 42px;
        }
        
        .filter-row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .filter-row .search-box {
            flex: 1;
        }
        
        .filter-row .form-select {
            width: auto;
            min-width: 100px;
        }
        
        .clear-filter-btn {
            width: 42px;
            height: 42px;
            min-width: 42px;
            min-height: 42px;
            max-width: 42px;
            max-height: 42px;
            border-radius: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
            aspect-ratio: 1 / 1;
        }
        
        .clear-filter-btn:hover {
            background: var(--accent-red);
            border-color: var(--accent-red);
            color: white;
        }
        
        .clear-filter-btn:active {
            transform: scale(0.95);
        }
        
        .search-box {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
        }
        
        .search-box:focus-within {
            border-color: var(--accent-blue);
        }
        
        .search-input {
            flex: 1;
            background: transparent;
            border: none;
            font-size: 0.9rem;
            color: var(--text-primary);
            font-family: 'Tajawal', sans-serif;
        }
        
        .search-input:focus {
            outline: none;
        }
        
        .search-input::placeholder {
            color: var(--text-muted);
        }
        
        .amount-input-box {
            background: var(--bg-input);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .amount-input-box:focus-within {
            border-color: var(--accent-blue);
        }
        
        .amount-input-box input {
            background: transparent;
            border: none;
            font-size: 2.5rem;
            font-weight: 900;
            text-align: center;
            width: 100%;
            color: var(--text-primary);
            font-family: 'Tajawal', sans-serif;
        }
        
        .amount-input-box input:focus { outline: none; }
        .amount-input-box input::placeholder { color: var(--text-muted); }
        
        .amount-input-currency {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        /* Category Grid */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .category-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 14px 8px;
            background: var(--bg-input);
            border: 2px solid transparent;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .category-item:active { transform: scale(0.95); }
        .category-item.active { border-color: var(--accent-blue); background: rgba(59, 130, 246, 0.1); }
        
        .category-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .category-icon svg { width: 20px; height: 20px; }
        .category-name { font-size: 0.7rem; color: var(--text-secondary); text-align: center; font-weight: 700; }
        
        /* Buttons */
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 800;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            transition: all 0.2s ease;
        }
        
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--accent-blue); color: white; }
        .btn-success { background: var(--accent-green); color: white; }
        .btn-danger { background: var(--accent-red); color: white; }
        .btn-gold { background: var(--accent-gold); color: #000; }
        .btn-outline { background: transparent; border: 2px solid var(--border-color); color: var(--text-secondary); }
        .btn-small { padding: 8px 16px; font-size: 0.8rem; background: var(--bg-input); color: var(--text-secondary); }
        
        /* Toggle Group */
        .toggle-group {
            display: flex;
            background: var(--bg-input);
            border-radius: var(--radius-md);
            padding: 4px;
            gap: 4px;
        }
        
        .toggle-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: var(--radius-sm);
            background: transparent;
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Tajawal', sans-serif;
        }
        
        .toggle-btn.active { background: var(--accent-blue); color: white; }
        .toggle-btn.active.green { background: var(--accent-green); }
        .toggle-btn.active.red { background: var(--accent-red); }
        
        /* Toggle Checkbox (Switch) */
        .toggle-checkbox {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 26px;
        }
        
        .toggle-checkbox input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-checkbox-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-input);
            border: 2px solid var(--border-color);
            transition: 0.3s;
            border-radius: 26px;
        }
        
        .toggle-checkbox-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: var(--text-muted);
            transition: 0.3s;
            border-radius: 50%;
        }
        
        .toggle-checkbox input:checked + .toggle-checkbox-slider {
            background-color: var(--accent-blue);
            border-color: var(--accent-blue);
        }
        
        .toggle-checkbox input:checked + .toggle-checkbox-slider:before {
            transform: translateX(22px);
            background-color: white;
        }
        
        /* Pages */
        .page { display: none; }
        .page.active { display: block; }
        
        /* Settings */
        .settings-section { margin-bottom: 24px; padding: 0 16px; }
        
        .settings-section-title {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            font-weight: 800;
        }
        
        .settings-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        
        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            gap: 12px;
        }
        
        .settings-item:last-child { border-bottom: none; }
        
        .settings-item-info {
            display: flex;
            align-items: center;
            gap: 14px;
            flex: 1;
        }
        
        .settings-item-icon {
            width: 40px;
            height: 40px;
            min-width: 40px;
            min-height: 40px;
            border-radius: var(--radius-md);
            background: var(--bg-input);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            flex-shrink: 0;
            aspect-ratio: 1 / 1;
        }
        
        .settings-item-icon svg { width: 20px; height: 20px; }
        
        .settings-item-text h4 { font-size: 0.95rem; font-weight: 700; margin-bottom: 2px; }
        .settings-item-text p { font-size: 0.75rem; color: var(--text-muted); }
        
        .settings-input {
            width: 80px;
            padding: 8px 10px;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 700;
        }
        
        /* Currency Toggle Buttons */
        .currency-toggle-group {
            display: flex;
            gap: 8px;
            width: 100%;
        }
        
        .currency-toggle-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-input);
            color: var(--text-secondary);
            font-family: 'Tajawal', sans-serif;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .currency-toggle-btn .currency-symbol {
            font-size: 1.1rem;
            font-weight: 800;
        }
        
        .currency-toggle-btn span:last-child {
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .currency-toggle-btn.active {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.1);
            color: var(--accent-blue);
        }
        
        .currency-toggle-btn:active {
            transform: scale(0.97);
        }
        
        .settings-select {
            padding: 12px 40px 12px 16px;
            font-size: 0.95rem;
            font-weight: 700;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 12px center;
            background-size: 20px;
            min-width: 140px;
            border: 2px solid var(--border-color);
            transition: all 0.2s ease;
        }
        
        .settings-select:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }
        
        .settings-select option {
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 12px;
        }
        
        /* Ramadan Section */
        .ramadan-card {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: var(--radius-lg);
            padding: 16px;
        }
        
        .ramadan-header {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #fbbf24;
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 8px;
        }
        
        .ramadan-desc {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-bottom: 16px;
        }
        
        .ramadan-categories {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .ramadan-cat-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Tajawal', sans-serif;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .ramadan-cat-btn:hover {
            border-color: #fbbf24;
            background: rgba(251, 191, 36, 0.1);
        }
        
        .ramadan-cat-btn .cat-icon {
            width: 28px;
            height: 28px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .ramadan-cat-btn .cat-icon svg {
            width: 16px;
            height: 16px;
        }
        
        .ramadan-summary {
            background: var(--bg-input);
            border-radius: var(--radius-md);
            padding: 12px;
        }
        
        .ramadan-summary-empty {
            text-align: center;
            color: var(--text-muted);
            font-size: 0.8rem;
            padding: 8px;
        }
        
        /* Ramadan Modal */
        .ramadan-modal {
            padding: 0;
            overflow: hidden;
        }
        
        .ramadan-modal-header {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            padding: 24px 20px;
            text-align: center;
            position: relative;
        }
        
        .ramadan-modal-icon {
            width: 56px;
            height: 56px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
        }
        
        .ramadan-modal-icon svg {
            width: 28px;
            height: 28px;
            color: white;
        }
        
        .ramadan-modal-title {
            color: white;
            font-size: 1.2rem;
            font-weight: 800;
            margin: 0;
        }
        
        .ramadan-save-btn {
            width: 100%;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #000;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .ramadan-save-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
        }
        
        /* Checkbox Styling */
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: var(--bg-input);
            border-radius: var(--radius-md);
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .checkbox-item:hover {
            background: var(--bg-hover);
        }
        
        .checkbox-item input[type="checkbox"] {
            display: none;
        }
        
        .checkbox-box {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }
        
        .checkbox-item input:checked + .checkbox-box {
            background: var(--accent-red);
            border-color: var(--accent-red);
        }
        
        .checkbox-box svg {
            width: 14px;
            height: 14px;
            color: white;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .checkbox-item input:checked + .checkbox-box svg {
            opacity: 1;
        }
        
        .checkbox-label {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .add-category-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: var(--radius-md);
            color: var(--accent-blue);
            font-size: 0.75rem;
            font-weight: 700;
            font-family: 'Tajawal', sans-serif;
            cursor: pointer;
        }
        
        .add-category-btn svg {
            width: 14px;
            height: 14px;
        }
        
        .color-picker-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
        }
        
        .color-option {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .color-option.active {
            border-color: white;
            box-shadow: 0 0 0 2px var(--accent-blue);
        }
        
        .custom-category {
            position: relative;
        }
        
        .category-delete-btn {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent-red);
            color: white;
            border: 2px solid var(--bg-card);
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            z-index: 10;
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-green);
            color: white;
            padding: 14px 24px;
            border-radius: var(--radius-lg);
            font-weight: 700;
            font-size: 0.95rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .toast.show {
            opacity: 1;
        }
        
        .toast.error {
            background: var(--accent-red);
        }
        
        /* Welcome Screen */
        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-main);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .welcome-content {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 30px 24px;
            max-width: 360px;
            width: 100%;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        
        .welcome-icon {
            margin-bottom: 20px;
        }
        
        .welcome-title {
            font-size: 1.4rem;
            font-weight: 900;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .welcome-subtitle {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 24px;
        }
        
        .welcome-form {
            text-align: right;
        }
        
        /* Debt Card */
        .debt-card {
            background: var(--bg-input);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 12px;
            border-right: 4px solid;
        }
        
        .debt-card.to-me { border-color: var(--accent-green); }
        .debt-card.from-me { border-color: var(--accent-red); }
        .debt-card.installment-card { border-color: var(--accent-blue); }
        
        .debt-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .debt-person { font-size: 1rem; font-weight: 800; }
        .debt-date { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }
        .debt-footer { display: flex; justify-content: space-between; align-items: center; }
        .debt-amount strong { font-size: 1rem; }
        .debt-amount small { display: block; font-size: 0.7rem; color: var(--text-muted); }
        
        /* Installment Progress */
        .installment-progress {
            margin-bottom: 8px;
        }
        
        .installment-progress-bar {
            height: 8px;
            background: var(--bg-card);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 6px;
        }
        
        .installment-progress-fill {
            height: 100%;
            background: var(--accent-blue);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .installment-progress-text {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: left;
            font-weight: 600;
        }
        
        .btn-small { padding: 10px 18px; font-size: 0.85rem; width: auto; }
        
        .debt-icon-box {
            width: 44px;
            height: 44px;
            background: var(--bg-card);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .btn-pay {
            padding: 8px 16px;
            font-size: 0.85rem;
            font-weight: 700;
            font-family: 'Tajawal', sans-serif;
            background: transparent;
            border: 2px solid var(--accent-blue);
            color: var(--accent-blue);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-pay:hover {
            background: var(--accent-blue);
            color: white;
        }
        
        /* Empty State */
        .empty-state { text-align: center; padding: 40px 20px; }
        
        .empty-state-icon {
            width: 72px;
            height: 72px;
            border-radius: var(--radius-xl);
            background: var(--bg-input);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            color: var(--text-muted);
        }
        
        .empty-state-icon svg { width: 32px; height: 32px; }
        .empty-state h3 { font-size: 1rem; margin-bottom: 4px; color: var(--text-secondary); font-weight: 700; }
        .empty-state p { font-size: 0.85rem; color: var(--text-muted); }
        
        /* Delete Button */
        .delete-btn {
            width: 36px;
            height: 36px;
            min-width: 36px;
            min-height: 36px;
            border-radius: var(--radius-sm);
            background: rgba(239, 68, 68, 0.1);
            border: none;
            color: var(--accent-red);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s ease;
            aspect-ratio: 1 / 1;
        }
        
        .delete-btn:active {
            transform: scale(0.9);
            background: rgba(239, 68, 68, 0.2);
        }
        
        .delete-btn svg { width: 16px; height: 16px; }
        
        /* Action Icon Buttons - Square Icons for Edit/Delete/Pay */
        .action-icon-btn {
            width: 36px;
            height: 36px;
            min-width: 36px;
            min-height: 36px;
            border-radius: 10px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s ease;
            aspect-ratio: 1 / 1;
        }
        
        .action-icon-btn:active {
            transform: scale(0.9);
        }
        
        .action-icon-btn svg { width: 18px; height: 18px; }
        
        .action-icon-btn.edit {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent-blue);
        }
        
        .action-icon-btn.edit:active {
            background: rgba(59, 130, 246, 0.25);
        }
        
        .action-icon-btn.delete {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
        }
        
        .action-icon-btn.delete:active {
            background: rgba(239, 68, 68, 0.25);
        }
        
        .action-icon-btn.pay {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
        }
        
        .action-icon-btn.pay:active {
            background: rgba(16, 185, 129, 0.25);
        }
        
        .action-icon-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        /* List Item Card */
        .list-item-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--bg-hover);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
        }
        
        .list-item-icon {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .list-item-icon svg {
            width: 18px;
            height: 18px;
        }
        
        .list-item-info {
            flex: 1;
            min-width: 0;
        }
        
        .list-item-info h4 {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        
        .list-item-info p {
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        
        .list-item-amount {
            font-size: 0.9rem;
            font-weight: 800;
            padding: 0 8px;
        }
        
        .list-item-amount.income { color: var(--accent-green); }
        .list-item-amount.expense { color: var(--accent-red); }
        
        .list-item-amount-box {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            padding: 0 8px;
        }
        
        .list-item-amount-box .amount-main {
            font-size: 0.85rem;
            font-weight: 800;
        }
        
        .list-item-amount-box .amount-sub {
            font-size: 0.65rem;
            color: var(--text-muted);
            font-weight: 500;
        }
        
        .list-item-amount-box.income .amount-main { color: var(--accent-green); }
        .list-item-amount-box.expense .amount-main { color: var(--accent-red); }
        
        .list-item-actions {
            display: flex;
            gap: 4px;
        }
        
        .icon-btn {
            width: 30px;
            height: 30px;
            border-radius: var(--radius-sm);
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .icon-btn:hover {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }
        
        .icon-btn.danger:hover {
            background: var(--accent-red);
            border-color: var(--accent-red);
        }
        
        .icon-btn svg {
            width: 14px;
            height: 14px;
        }
        
        /* Gold Card */
        .gold-header-card {
            background: linear-gradient(135deg, #92400e 0%, #d97706 100%);
            border-radius: var(--radius-xl);
            padding: 20px;
            margin-bottom: 16px;
            color: white;
        }
        
        .gold-header-title { font-size: 1rem; font-weight: 800; margin-bottom: 14px; }
        
        .gold-prices-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .gold-price-box {
            background: rgba(255,255,255,0.15);
            border-radius: var(--radius-md);
            padding: 12px;
            text-align: center;
        }
        
        .gold-price-label { font-size: 0.7rem; opacity: 0.85; margin-bottom: 4px; }
        .gold-price-value { font-size: 0.95rem; font-weight: 800; }
        
        /* Zakat Card */
        .zakat-header-card {
            background: linear-gradient(135deg, #065f46 0%, #059669 100%);
            border-radius: var(--radius-xl);
            padding: 24px;
            color: white;
            margin-bottom: 16px;
        }
        
        .zakat-label { font-size: 0.85rem; opacity: 0.9; margin-bottom: 6px; }
        .zakat-value { font-size: 1.75rem; font-weight: 900; margin-bottom: 6px; }
        .zakat-note { font-size: 0.8rem; opacity: 0.8; }
        
        /* Reports Date Picker */
        .date-range-picker {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 16px;
            border: 1px solid var(--border-color);
            margin-bottom: 16px;
        }
        
        .date-range-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .date-input-group {
            flex: 1;
        }
        
        .date-input-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 6px;
            font-weight: 700;
        }
        
        .date-input {
            width: 100%;
            padding: 14px 12px;
            background: var(--bg-input);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: 'Tajawal', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .date-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }
        
        .date-input::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
            opacity: 0.7;
        }
        
        .date-input::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }
        
        /* Custom Date Picker */
        .custom-date-picker {
            position: relative;
        }
        
        .date-display {
            width: 100%;
            padding: 14px 12px;
            background: var(--bg-input);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: 'Tajawal', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .date-display:hover {
            border-color: var(--accent-blue);
        }
        
        .date-display svg {
            width: 20px;
            height: 20px;
            color: var(--text-muted);
        }
        
        .calendar-popup {
            display: none;
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 16px;
            z-index: 1000 !important;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            width: calc(100% - 32px);
            max-width: 320px;
        }
        
        .calendar-popup.active {
            display: block !important;
        }
        
        .calendar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        
        .calendar-overlay.active {
            display: block;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            gap: 8px;
        }
        
        .calendar-nav {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            background: var(--bg-hover);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            z-index: 10;
            position: relative;
            -webkit-tap-highlight-color: transparent;
        }
        
        .calendar-nav:hover {
            background: var(--accent-blue);
            color: white;
        }
        
        .calendar-nav:active {
            transform: scale(0.95);
        }
        
        .calendar-nav svg {
            width: 18px;
            height: 18px;
            pointer-events: none;
        }
        
        .calendar-selects {
            display: flex;
            gap: 6px;
            flex: 1;
            justify-content: center;
        }
        
        .calendar-select {
            padding: 6px 8px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: 'Tajawal', sans-serif;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
        }
        
        .calendar-select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        
        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 4px;
        }
        
        .calendar-weekday {
            text-align: center;
            font-size: 0.65rem;
            font-weight: 700;
            color: var(--text-muted);
            padding: 6px 0;
        }
        
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.15s ease;
            background: transparent;
            border: none;
            color: var(--text-primary);
            padding: 0;
            min-width: 32px;
            min-height: 32px;
        }
        
        .calendar-day:hover {
            background: var(--bg-hover);
        }
        
        .calendar-day.other-month {
            color: var(--text-muted);
            opacity: 0.4;
        }
        
        .calendar-day.today {
            border: 2px solid var(--accent-blue);
        }
        
        .calendar-day.selected {
            background: var(--accent-blue);
            color: white;
        }
        
        .calendar-day.selected:hover {
            background: var(--accent-blue);
        }
        
        .calendar-quick-btns {
            display: flex;
            gap: 6px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }
        
        .calendar-quick-btn {
            flex: 1;
            padding: 8px;
            background: var(--bg-input);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
        }
        
        .calendar-quick-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        /* Report Summary Cards */
        .report-summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .report-summary-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 16px;
            border: 1px solid var(--border-color);
            text-align: center;
        }
        
        .report-summary-card.highlight {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.15));
            border-color: var(--accent-blue);
        }
        
        .report-summary-title {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .report-summary-value {
            font-size: 1.1rem;
            font-weight: 900;
        }
        
        .report-summary-sub {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 4px;
        }
        
        /* Chart Bar */
        .chart-bar-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 14px;
        }
        
        .chart-bar-label {
            width: 60px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            flex-shrink: 0;
            font-weight: 600;
        }
        
        .chart-bar-track {
            flex: 1;
            height: 28px;
            background: var(--bg-input);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }
        
        .chart-bar-fill {
            height: 100%;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 0.75rem;
            font-weight: 700;
            color: white;
            min-width: fit-content;
            transition: width 0.5s ease;
        }
        
        /* Pie Chart */
        .chart-container {
            margin-bottom: 20px;
        }
        
        .pie-chart-wrapper {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 16px;
        }
        
        .pie-chart {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            position: relative;
            flex-shrink: 0;
        }
        
        .pie-chart-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70px;
            height: 70px;
            background: var(--bg-card);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .pie-chart-total {
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        
        .pie-chart-value {
            font-size: 0.85rem;
            font-weight: 800;
            color: var(--text-primary);
        }
        
        .pie-legend {
            flex: 1;
        }
        
        .pie-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 0.8rem;
        }
        
        .pie-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            flex-shrink: 0;
        }
        
        .pie-legend-label {
            flex: 1;
            color: var(--text-secondary);
        }
        
        .pie-legend-value {
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .pie-legend-percent {
            font-size: 0.7rem;
            color: var(--text-muted);
            min-width: 35px;
            text-align: left;
        }
        
        /* Larger Pie Chart - Side by Side 50/50 */
        .pie-chart-container {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .pie-section-chart {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 12px;
            background: var(--bg-input);
            border-radius: var(--radius-lg);
        }
        
        .pie-chart-large {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            position: relative;
        }
        
        .pie-chart-center-large {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 65px;
            height: 65px;
            background: var(--bg-input);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .pie-chart-value-large {
            font-size: 0.75rem;
            font-weight: 900;
            color: var(--text-primary);
        }
        
        .pie-section-legend {
            flex: 1;
            background: var(--bg-input);
            border-radius: var(--radius-lg);
            padding: 8px 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow-y: auto;
            max-height: 134px;
        }
        
        .pie-legend-grid-new {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .pie-legend-row {
            display: flex;
            align-items: center;
        }
        
        .pie-legend-color {
            width: 6px;
            height: 6px;
            border-radius: 2px;
            flex-shrink: 0;
            margin-left: 4px;
        }
        
        .pie-legend-name {
            font-size: 0.65rem;
            color: var(--text-secondary);
            font-weight: 600;
        }
        
        .pie-legend-nums {
            font-size: 0.65rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-right: auto;
            padding-right: 4px;
        }
        
        .pie-legend-nums small {
            font-size: 0.5rem;
            color: var(--text-muted);
            font-weight: 500;
        }
        
        .pie-legend-table,
        .pie-chart-wrapper-large,
        .pie-legend-grid {
            display: none;
        }
        
        .smart-analysis {
            padding: 14px 16px;
            border-radius: var(--radius-md);
            font-size: 0.85rem;
            font-weight: 600;
            line-height: 1.6;
            text-align: center;
        }
        
        /* Expense Analysis Row */
        .expense-analysis-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .expense-pie-card {
            flex: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .expense-details-card {
            flex: 1;
            max-height: 220px;
            overflow-y: auto;
        }
        
        .expense-detail-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .expense-detail-item:last-child {
            border-bottom: none;
        }
        
        .expense-detail-color {
            width: 10px;
            height: 10px;
            border-radius: 3px;
            flex-shrink: 0;
        }
        
        .expense-detail-name {
            flex: 1;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .expense-detail-amount {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        .expense-detail-percent {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            min-width: 35px;
            text-align: left;
        }
        
        /* Line Chart */
        .line-chart-container {
            position: relative;
            width: 100%;
            height: 200px;
            padding: 10px 0;
            direction: ltr;
        }
        
        .line-chart-svg {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .line-chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 12px;
            font-size: 0.75rem;
        }
        
        .line-chart-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .line-chart-legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .line-chart-summary {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border-color);
        }
        
        .trend-item {
            font-size: 0.75rem;
            display: flex;
            gap: 4px;
        }
        
        .trend-item span:first-child {
            color: var(--text-muted);
        }
        
        /* Simple Pie Chart Donut */
        .pie-chart-simple {
            display: flex;
            justify-content: center;
            padding: 10px 0;
        }
        
        .pie-chart-donut {
            width: 130px;
            height: 130px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .pie-chart-donut-center {
            width: 75px;
            height: 75px;
            background: var(--bg-card);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .donut-total {
            font-size: 0.8rem;
            font-weight: 800;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 3px;
        }
        
        .donut-total .sar-symbol-inline {
            width: 12px;
            height: 12px;
        }
        
        /* Month Comparison - kept for fallback */
        .month-compare-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .month-compare-label {
            width: 50px;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-align: right;
            flex-shrink: 0;
        }
        
        .month-compare-bars {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .month-compare-bar {
            height: 14px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0 6px;
            min-width: 30px;
            transition: width 0.5s ease;
        }
        
        .month-compare-bar.income {
            background: var(--accent-green);
        }
        
        .month-compare-bar.expense {
            background: var(--accent-red);
        }
        
        .month-compare-bar span {
            font-size: 0.6rem;
            font-weight: 700;
            color: white;
        }
        
        .month-compare-change {
            width: 40px;
            font-size: 0.65rem;
            font-weight: 700;
            text-align: left;
            flex-shrink: 0;
        }
        
        /* Goals Page */
        .goals-header-card {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            border-radius: var(--radius-xl);
            padding: 24px;
            color: white;
            margin-bottom: 16px;
        }
        
        .goals-header-label {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 6px;
        }
        
        .goals-header-value {
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 4px;
        }
        
        .goals-header-sub {
            font-size: 0.75rem;
            opacity: 0.7;
        }
        
        .goals-header-icon {
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.2);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .goals-header-icon svg {
            width: 30px;
            height: 30px;
        }
        
        .goals-header-card.negative {
            background: linear-gradient(135deg, #ef4444 0%, #f97316 100%);
        }
        
        .alert-box {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border-radius: var(--radius-lg);
            margin-bottom: 16px;
        }
        
        .alert-box.red {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--accent-red);
        }
        
        .alert-box svg {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }
        
        .alert-title {
            font-weight: 800;
            font-size: 0.9rem;
            margin-bottom: 2px;
        }
        
        .alert-text {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .goal-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
        }
        
        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .goal-name {
            font-size: 1rem;
            font-weight: 800;
        }
        
        .goal-remaining {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 4px;
        }
        
        .goal-amount-display {
            text-align: left;
        }
        
        .goal-current-amount {
            display: block;
            font-size: 1.3rem;
            font-weight: 900;
            color: var(--accent-blue);
        }
        
        .goal-target-amount {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .goal-progress {
            margin-bottom: 12px;
        }
        
        .goal-progress-bar {
            height: 10px;
            background: var(--bg-hover);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .goal-progress-fill {
            height: 100%;
            border-radius: 5px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
            transition: width 0.5s ease;
        }
        
        .goal-progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
        }
        
        .goal-progress-current {
            font-weight: 700;
            color: var(--accent-blue);
        }
        
        .goal-progress-percent {
            color: var(--text-muted);
        }
        
        .goal-actions {
            display: flex;
            gap: 8px;
        }
        
        .goal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: var(--radius-md);
            font-family: 'Tajawal', sans-serif;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .goal-btn.add {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent-blue);
        }
        
        .goal-btn.withdraw {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent-gold);
        }
        
        .goal-btn.delete {
            background: rgba(239, 68, 68, 0.1);
            color: var(--accent-red);
            flex: 0;
            width: 38px;
            height: 38px;
            padding: 0;
        }
        
        .goal-btn svg {
            width: 16px;
            height: 16px;
        }
        
        /* Income vs Expense Chart */
        .comparison-chart {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .comparison-bar {
            flex: 1;
            background: var(--bg-input);
            border-radius: var(--radius-md);
            padding: 14px;
            text-align: center;
        }
        
        .comparison-bar-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .comparison-bar-value {
            font-size: 1.1rem;
            font-weight: 900;
            margin-bottom: 8px;
        }
        
        .comparison-bar-visual {
            height: 8px;
            background: var(--bg-hover);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .comparison-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .comparison-summary {
            display: flex;
            justify-content: space-around;
            padding: 14px;
            background: var(--bg-input);
            border-radius: var(--radius-md);
            margin-top: 12px;
        }
        
        .comparison-stat {
            text-align: center;
        }
        
        .comparison-stat-label {
            display: block;
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        
        .comparison-stat-value {
            font-size: 1.1rem;
            font-weight: 900;
        }
        
        /* Top Expense Widget */
        .top-expense-card {
            padding: 0;
            overflow: hidden;
        }
        
        .top-expense-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: rgba(239, 68, 68, 0.1);
            border-bottom: 1px solid rgba(239, 68, 68, 0.2);
            color: var(--accent-red);
            font-size: 0.8rem;
            font-weight: 700;
        }
        
        .top-expense-content {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
        }
        
        .top-expense-icon-wrapper {
            width: 52px;
            height: 52px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .top-expense-info {
            flex: 1;
            min-width: 0;
        }
        
        .top-expense-category-name {
            font-size: 1.05rem;
            font-weight: 800;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .top-expense-percent-text {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        
        .top-expense-values {
            text-align: left;
            flex-shrink: 0;
        }
        
        .top-expense-amount {
            font-size: 1.15rem;
            font-weight: 900;
            color: var(--accent-red);
            margin-bottom: 2px;
        }
        
        .top-expense-percent {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 600;
        }
        
        /* Chart Tooltip */
        .chart-tooltip {
            position: absolute;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            pointer-events: none;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            min-width: 80px;
            text-align: center;
        }
        
        .mini-chart-container {
            position: relative;
        }
        
        .chart-point .point-dot {
            transition: r 0.15s ease;
        }
        
        .chart-point:hover .point-dot {
            r: 6;
        }
        
        /* Simple Bar Chart */
        .simple-bar-chart {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            height: 140px;
            padding: 0 8px;
            gap: 8px;
        }
        
        .bar-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
        }
        
        .bars {
            flex: 1;
            display: flex;
            align-items: flex-end;
            gap: 3px;
            width: 100%;
            justify-content: center;
        }
        
        .bar {
            width: 12px;
            min-height: 4px;
            border-radius: 3px 3px 0 0;
            transition: height 0.3s ease;
        }
        
        .income-bar {
            background: var(--accent-green);
        }
        
        .expense-bar {
            background: var(--accent-red);
        }
        
        .bar-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-weight: 700;
            margin-top: 6px;
            text-align: center;
        }
        
        /* Converter */
        .converter-result-box {
            background: linear-gradient(135deg, var(--accent-green) 0%, #059669 100%);
            border-radius: var(--radius-lg);
            padding: 24px;
            text-align: center;
            margin-top: 20px;
        }
        
        .converter-result-label { font-size: 0.85rem; color: rgba(255,255,255,0.85); margin-bottom: 4px; }
        .converter-result-value { font-size: 2rem; font-weight: 900; color: white; }
        
        /* Info Box */
        .info-box {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: var(--radius-md);
            padding: 14px;
            margin-bottom: 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .info-box-icon {
            width: 24px;
            height: 24px;
            color: var(--accent-blue);
            flex-shrink: 0;
        }
        
        .info-box-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 2px; }
        
        /* PIN Lock Screen */
        .pin-lock-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pin-lock-content {
            text-align: center;
            padding: 20px;
            width: 100%;
            max-width: 340px;
        }
        
        .pin-lock-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            color: var(--accent-blue);
        }
        
        .pin-lock-title {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 8px;
        }
        
        .pin-lock-subtitle {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 32px;
        }
        
        .pin-dots {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-bottom: 32px;
        }
        
        .pin-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--bg-input);
            border: 2px solid var(--border-color);
            transition: all 0.2s ease;
        }
        
        .pin-dot.filled {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
        }
        
        .pin-dot.error {
            background: var(--accent-red);
            border-color: var(--accent-red);
            animation: shake 0.3s ease;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }
        
        .pin-keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            max-width: 300px;
            margin: 0 auto;
        }
        
        .pin-key {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            border: none;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 1.8rem;
            font-weight: 700;
            font-family: 'Tajawal', sans-serif;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            transition: all 0.15s ease;
        }
        
        .pin-key:active {
            background: var(--accent-blue);
            transform: scale(0.95);
        }
        
        .pin-key-delete {
            background: transparent;
            color: var(--text-muted);
        }
        
        .pin-key-delete:active {
            background: var(--bg-hover);
            color: var(--accent-red);
        }
        
        /* Alert Toast */
        .alert-toast {
            position: fixed;
            top: 20px;
            left: 16px;
            right: 16px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            box-shadow: 0 10px 40px var(--shadow-color);
            z-index: 9999;
            border-right: 4px solid var(--accent-gold);
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .alert-toast-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(245, 158, 11, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-gold);
            flex-shrink: 0;
        }
        
        .alert-toast-icon svg {
            width: 22px;
            height: 22px;
        }
        
        .alert-toast-content {
            flex: 1;
        }
        
        .alert-toast-title {
            font-size: 0.95rem;
            font-weight: 800;
            margin-bottom: 4px;
        }
        
        .alert-toast-message {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .alert-toast-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
        }
        
        /* Swipe to Delete */
        .swipeable-item {
            position: relative;
            overflow: hidden;
        }
        
        .swipe-delete-bg {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 80px;
            background: var(--accent-red);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            border-radius: var(--radius-lg) 0 0 var(--radius-lg);
        }
        
        .swipe-content {
            position: relative;
            background: var(--bg-input);
            transition: transform 0.2s ease;
            z-index: 1;
        }
        
        /* Pull to Refresh Indicator */
        .pull-indicator {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%) translateY(-100%);
            background: var(--bg-card);
            padding: 12px 20px;
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            z-index: 1000;
            transition: transform 0.2s ease;
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        
        .pull-indicator.visible {
            transform: translateX(-50%) translateY(0);
        }
        
        .pull-indicator svg {
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Sync Status */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--bg-input);
            border-radius: var(--radius-md);
            margin-bottom: 12px;
        }
        
        .sync-status-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sync-status-icon.synced {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
        }
        
        .sync-status-icon.not-synced {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent-gold);
        }
        
        .sync-status-info {
            flex: 1;
        }
        
        .sync-status-info h4 {
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 2px;
        }
        
        .sync-status-info p {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .sync-btn {
            padding: 8px 16px;
            font-size: 0.8rem;
            font-weight: 700;
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
        }
        
        .sync-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .sync-btn.loading {
            position: relative;
        }
        
        .sync-btn.loading::after {
            content: '';
            position: absolute;
            width: 14px;
            height: 14px;
            border: 2px solid transparent;
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
        }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- SAR Symbol Definition -->
    <svg style="display: none;">
        <symbol id="sar-icon" viewBox="0 0 1124.14 1256.39">
            <path d="M699.62,1113.02h0c-20.06,44.48-33.32,92.75-38.4,143.37l424.51-90.24c20.06-44.47,33.31-92.75,38.4-143.37l-424.51,90.24Z"/>
            <path d="M1085.73,895.8c20.06-44.47,33.32-92.75,38.4-143.37l-330.68,70.33v-135.2l292.27-62.11c20.06-44.47,33.32-92.75,38.4-143.37l-330.68,70.27V66.13c-50.67,28.45-95.67,66.32-132.25,110.99v403.35l-132.25,28.11V0c-50.67,28.44-95.67,66.32-132.25,110.99v525.69l-295.91,62.88c-20.06,44.47-33.33,92.75-38.42,143.37l334.33-71.05v170.26l-358.3,76.14c-20.06,44.47-33.32,92.75-38.4,143.37l375.04-79.7c30.53-6.35,56.77-24.4,73.83-49.24l68.78-101.97v-.02c7.14-10.55,11.3-23.27,11.3-36.97v-149.98l132.25-28.11v270.4l424.53-90.28Z"/>
        </symbol>
    </svg>

    <!-- Header -->
    <header class="header">
        <div class="header-title">
            <div class="header-logo">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </div>
            المحفظة الذكية
        </div>
        <button class="icon-btn" onclick="showPage('settings')">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
        </button>
    </header>

    <!-- Home Page -->
    <main id="page-home" class="page active">
        <section class="balance-section">
            <p class="balance-label">الرصيد الإجمالي</p>
            <div class="balance-amount" id="balance-display"></div>
            <div class="balance-egp" id="balance-egp"></div>
            <p class="balance-egp-label" id="balance-egp-label">المعادل بالجنيه المصري</p>
            
            <div class="quick-actions">
                <button class="action-btn income" onclick="openModal('income')">
                    <div class="action-btn-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"></path></svg>
                    </div>
                    <span>دخل</span>
                </button>
                <button class="action-btn expense" onclick="openModal('expense')">
                    <div class="action-btn-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M20 12H4"></path></svg>
                    </div>
                    <span>مصروف</span>
                </button>
                <button class="action-btn convert" onclick="openModal('converter')">
                    <div class="action-btn-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                    </div>
                    <span>تحويل</span>
                </button>
            </div>
        </section>

        <!-- Smart Alerts -->
        <div id="smart-alerts" class="smart-alerts-container" style="display: none;"></div>

        <!-- Active Challenges -->
        <div id="home-challenges" class="section" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">التحديات النشطة</h2>
            </div>
            <div class="challenges-content"></div>
        </div>

        <!-- Monthly Summary -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">ملخص سريع</h2>
            </div>
            <div class="summary-row">
                <div class="summary-card">
                    <p class="summary-card-title">هذا الشهر</p>
                    <p class="summary-card-value" id="summary-this-month">0</p>
                    <p class="summary-card-sub">صافي</p>
                    <p class="summary-card-net" id="summary-this-month-income"></p>
                </div>
                <div class="summary-card">
                    <p class="summary-card-title">الشهر الماضي</p>
                    <p class="summary-card-value" id="summary-last-month">0</p>
                    <p class="summary-card-sub">صافي</p>
                    <p class="summary-card-net" id="summary-last-month-income"></p>
                </div>
                <div class="summary-card">
                    <p class="summary-card-title">هذه السنة</p>
                    <p class="summary-card-value" id="summary-this-year">0</p>
                    <p class="summary-card-sub">وفرت</p>
                </div>
            </div>
        </div>

        <!-- Budget Widget -->
        <div class="section">
            <div class="budget-widget">
                <div class="budget-header">
                    <span class="budget-title">ميزانية الشهر</span>
                    <span class="budget-amount-display" id="budget-spent-header">0</span>
                </div>
                <div class="budget-sub-info">
                    <span class="budget-percent" id="budget-badge">0%</span>
                    <span class="budget-of-total">من <span id="budget-limit">0</span></span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="budget-fill" style="width: 0%; background: var(--accent-green);"></div>
                </div>
            </div>
            <div class="budget-alert-banner" id="budget-alert-banner" style="display: none;"></div>
        </div>

        <!-- Stats Grid -->
        <div class="section">
            <div class="stats-grid">
                <div class="stat-widget stat-widget-vertical">
                    <div class="stat-widget-icon-small green">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
                    </div>
                    <span class="stat-widget-title">لي عند الناس</span>
                    <p class="stat-widget-value green" id="debts-to-me">0</p>
                    <p class="stat-widget-sub" id="debts-to-me-egp"></p>
                </div>
                <div class="stat-widget stat-widget-vertical">
                    <div class="stat-widget-icon-small red">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
                    </div>
                    <span class="stat-widget-title">عليّ للناس</span>
                    <p class="stat-widget-value red" id="debts-from-me">0</p>
                    <p class="stat-widget-sub" id="debts-from-me-egp"></p>
                </div>
                <div class="stat-widget stat-widget-vertical">
                    <div class="stat-widget-icon-small gold">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <span class="stat-widget-title">محفظة الذهب</span>
                    <p class="stat-widget-value gold" id="gold-value">0</p>
                    <p class="stat-widget-sub" id="gold-value-egp"></p>
                </div>
                <div class="stat-widget stat-widget-vertical">
                    <div class="stat-widget-icon-small blue">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                    </div>
                    <span class="stat-widget-title">ربح الذهب</span>
                    <p class="stat-widget-value" id="gold-profit">0</p>
                    <p class="stat-widget-sub" id="gold-profit-egp"></p>
                </div>
            </div>
        </div>

        <!-- Recent Transactions -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">آخر المعاملات</h2>
                <button class="section-action" onclick="showPage('transactions')">عرض الكل</button>
            </div>
            <div class="card">
                <div class="transaction-list" id="recent-transactions"></div>
            </div>
        </div>
    </main>

    <!-- Transactions Page -->
    <main id="page-transactions" class="page">
        <div class="section" style="padding-top: 16px;">
            <!-- Search and Filter Row -->
            <div class="filter-row">
                <div class="search-box">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 16px; height: 16px; color: var(--text-muted);"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <input type="text" id="transaction-search" class="search-input" placeholder="بحث..." oninput="searchTransactions()">
                </div>
                <select id="category-filter" class="form-select form-select-small" onchange="filterByCategory()">
                    <option value="all">الكل</option>
                </select>
                <button class="clear-filter-btn" onclick="clearAllFilters()" title="مسح الفلاتر">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <!-- Date Filter -->
            <div class="date-range-picker" style="margin-bottom: 16px;">
                <div class="date-range-row">
                    <div class="date-input-group">
                        <p class="date-input-label">من</p>
                        <div class="custom-date-picker" id="picker-trans-from">
                            <div class="date-display" onclick="toggleTransCalendar('from')">
                                <span id="trans-date-from-display">كل الفترات</span>
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            </div>
                        </div>
                    </div>
                    <div class="date-input-group">
                        <p class="date-input-label">إلى</p>
                        <div class="custom-date-picker" id="picker-trans-to">
                            <div class="date-display" onclick="toggleTransCalendar('to')">
                                <span id="trans-date-to-display">اليوم</span>
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="toggle-group" style="margin-bottom: 16px;">
                <button class="toggle-btn active" onclick="filterTransactions('all', this)">الكل</button>
                <button class="toggle-btn" onclick="filterTransactions('income', this)">دخل</button>
                <button class="toggle-btn" onclick="filterTransactions('expense', this)">مصروف</button>
            </div>
            <div class="card">
                <div class="transaction-list" id="all-transactions"></div>
            </div>
        </div>
    </main>

    <!-- Debts Page -->
    <main id="page-debts" class="page">
        <div class="section" style="padding-top: 16px;">
            <!-- Summary Cards -->
            <div class="stats-grid" style="margin-bottom: 16px; grid-template-columns: repeat(3, 1fr);">
                <div class="stat-widget stat-widget-vertical">
                    <span class="stat-widget-title">لي عند الناس</span>
                    <p class="stat-widget-value green" id="debts-to-me-2">0</p>
                </div>
                <div class="stat-widget stat-widget-vertical">
                    <span class="stat-widget-title">عليّ للناس</span>
                    <p class="stat-widget-value red" id="debts-from-me-2">0</p>
                </div>
                <div class="stat-widget stat-widget-vertical">
                    <span class="stat-widget-title">أقساط شهرية</span>
                    <p class="stat-widget-value blue" id="monthly-installments">0</p>
                </div>
            </div>
            
            <!-- Add Buttons -->
            <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                <button class="btn btn-primary" style="flex: 1;" onclick="openModal('debt')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 18px; height: 18px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    دين جديد
                </button>
                <button class="btn btn-secondary" style="flex: 1;" onclick="openModal('installment')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 18px; height: 18px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    قسط جديد
                </button>
            </div>
            
            <!-- Filter Tabs -->
            <div class="toggle-group" style="margin-bottom: 16px;">
                <button class="toggle-btn active" id="tab-debts-to-me" onclick="filterDebtsPage('debts_to_me')">ديون لي</button>
                <button class="toggle-btn" id="tab-debts-from-me" onclick="filterDebtsPage('debts_from_me')">ديون عليّ</button>
                <button class="toggle-btn" id="tab-installments" onclick="filterDebtsPage('installments')">الأقساط</button>
            </div>
            
            <!-- List Container -->
            <div id="debts-list"></div>
        </div>
    </main>

    <!-- Gold Page -->
    <main id="page-gold" class="page">
        <div class="section" style="padding-top: 16px;">
            <div class="gold-header-card">
                <p class="gold-header-title">أسعار الذهب الحالية (بالجنيه المصري)</p>
                <div class="gold-prices-row">
                    <div class="gold-price-box">
                        <p class="gold-price-label">عيار 24</p>
                        <p class="gold-price-value" id="price-24-egp">0</p>
                        <p style="font-size: 0.6rem; opacity: 0.7; margin-top: 2px;" id="price-24-sar">≈ 0</p>
                    </div>
                    <div class="gold-price-box">
                        <p class="gold-price-label">عيار 21</p>
                        <p class="gold-price-value" id="price-21-egp">0</p>
                        <p style="font-size: 0.6rem; opacity: 0.7; margin-top: 2px;" id="price-21-sar">≈ 0</p>
                    </div>
                    <div class="gold-price-box">
                        <p class="gold-price-label">عيار 18</p>
                        <p class="gold-price-value" id="price-18-egp">0</p>
                        <p style="font-size: 0.6rem; opacity: 0.7; margin-top: 2px;" id="price-18-sar">≈ 0</p>
                    </div>
                </div>
            </div>
            
            <div class="stats-grid" style="margin-bottom: 16px;">
                <div class="stat-widget stat-widget-vertical">
                    <span class="stat-widget-title">قيمة المحفظة</span>
                    <p class="stat-widget-value gold" id="gold-total-egp">0 ج.م</p>
                    <p class="stat-widget-sub" id="gold-total-sar"></p>
                </div>
                <div class="stat-widget stat-widget-vertical">
                    <span class="stat-widget-title">الربح / الخسارة</span>
                    <p class="stat-widget-value" id="gold-profit-egp">0 ج.م</p>
                    <p class="stat-widget-sub" id="gold-profit-sar"></p>
                </div>
            </div>
            
            <button class="btn btn-gold" style="margin-bottom: 16px;" onclick="openModal('gold')">إضافة ذهب</button>
            
            <div id="gold-holdings"></div>
        </div>
    </main>

    <!-- Zakat Page -->
    <main id="page-zakat" class="page">
        <div class="section" style="padding-top: 16px;">
            <!-- Nisab Info Card -->
            <div class="card" style="margin-bottom: 16px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1)); border-color: rgba(16, 185, 129, 0.3);">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <div style="width: 44px; height: 44px; border-radius: var(--radius-md); background: rgba(16, 185, 129, 0.2); display: flex; align-items: center; justify-content: center; color: var(--accent-green);">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 22px; height: 22px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <div>
                        <h3 style="font-size: 1rem; font-weight: 800; color: var(--accent-green);">ما هو النصاب؟</h3>
                        <p style="font-size: 0.8rem; color: var(--text-muted);">الحد الأدنى للثروة الموجبة للزكاة</p>
                    </div>
                </div>
                <p style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.6;">
                    النصاب = قيمة <strong>85 جرام ذهب عيار 24</strong>. إذا بلغت ثروتك هذا المبلغ ومر عليها سنة هجرية، تجب عليك الزكاة بنسبة 2.5%
                </p>
            </div>
            
            <!-- Nisab Value Widget -->
            <div class="stats-grid" style="margin-bottom: 16px;">
                <div class="stat-widget">
                    <div class="stat-widget-right">
                        <span class="stat-widget-title">قيمة النصاب الحالي</span>
                    </div>
                    <div class="stat-widget-left">
                        <p class="stat-widget-value green" id="nisab-value">0</p>
                        <p class="stat-widget-sub" id="nisab-sub">85 جرام × سعر الجرام</p>
                    </div>
                </div>
                <div class="stat-widget">
                    <div class="stat-widget-right">
                        <span class="stat-widget-title">سعر جرام 24</span>
                    </div>
                    <div class="stat-widget-left">
                        <p class="stat-widget-value" id="gold-24-price">0</p>
                    </div>
                </div>
            </div>
            
            <!-- Wealth Breakdown -->
            <div class="section-header">
                <h2 class="section-title">ثروتك الخاضعة للزكاة</h2>
            </div>
            <div class="stats-grid" style="margin-bottom: 16px; grid-template-columns: repeat(3, 1fr);">
                <div class="stat-widget">
                    <div class="stat-widget-right">
                        <span class="stat-widget-title">النقدي</span>
                    </div>
                    <div class="stat-widget-left">
                        <p class="stat-widget-value" id="zakat-cash">0</p>
                    </div>
                </div>
                <div class="stat-widget">
                    <div class="stat-widget-right">
                        <span class="stat-widget-title">الذهب</span>
                    </div>
                    <div class="stat-widget-left">
                        <p class="stat-widget-value gold" id="zakat-gold">0</p>
                    </div>
                </div>
                <div class="stat-widget" style="border: 1px solid var(--accent-blue);">
                    <div class="stat-widget-right">
                        <span class="stat-widget-title">الإجمالي</span>
                    </div>
                    <div class="stat-widget-left">
                        <p class="stat-widget-value" style="color: var(--accent-blue);" id="zakat-total">0</p>
                    </div>
                </div>
            </div>
            
            <div class="card" id="zakat-status" style="margin-bottom: 16px;"></div>
            
            <button class="btn" style="background: linear-gradient(135deg, #ec4899, #f43f5e); color: white;" onclick="openModal('sadaqa')">صدقة جارية</button>
        </div>
    </main>

    <!-- Reports Page -->
    <main id="page-reports" class="page">
        <div class="section" style="padding-top: 16px;">
            <!-- Date Range Picker -->
            <div class="date-range-picker">
                <div class="date-range-row">
                    <div class="date-input-group">
                        <p class="date-input-label">من تاريخ</p>
                        <div class="custom-date-picker" id="picker-from">
                            <div class="date-display" onclick="toggleCalendar('from')">
                                <span id="date-from-display">اختر التاريخ</span>
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            </div>
                        </div>
                    </div>
                    <div class="date-input-group">
                        <p class="date-input-label">إلى تاريخ</p>
                        <div class="custom-date-picker" id="picker-to">
                            <div class="date-display" onclick="toggleCalendar('to')">
                                <span id="date-to-display">اختر التاريخ</span>
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="toggle-group" style="margin-top: 12px;">
                    <button class="toggle-btn" onclick="setQuickRange('week', this)">أسبوع</button>
                    <button class="toggle-btn active" onclick="setQuickRange('month', this)">شهر</button>
                    <button class="toggle-btn" onclick="setQuickRange('year', this)">سنة</button>
                </div>
            </div>
            
            <!-- Income vs Expense Comparison -->
            <div class="card" style="margin-bottom: 16px;">
                <h3 style="font-size: 1rem; font-weight: 800; margin-bottom: 16px;">مقارنة الدخل والمصروفات</h3>
                <div id="comparison-chart"></div>
            </div>
            
            <!-- Pie Chart + Details Row -->
            <div class="expense-analysis-row">
                <div class="card expense-pie-card">
                    <h3 style="font-size: 0.9rem; font-weight: 800; margin-bottom: 12px; text-align: right;">توزيع المصروفات</h3>
                    <div id="pie-chart"></div>
                </div>
                <div class="card expense-details-card">
                    <h3 style="font-size: 0.9rem; font-weight: 800; margin-bottom: 12px;">التفاصيل</h3>
                    <div id="expense-details-list"></div>
                </div>
            </div>
            
            <!-- Top Expense Category -->
            <div class="card top-expense-card" style="margin-top: 16px;">
                <div class="top-expense-header">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 18px; height: 18px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                    <span>أعلى بند للمصروفات</span>
                </div>
                <div class="top-expense-content">
                    <div class="top-expense-icon-wrapper" id="top-expense-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 24px; height: 24px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <div class="top-expense-info">
                        <p class="top-expense-category-name" id="top-expense-name">لا توجد مصروفات</p>
                        <p class="top-expense-percent-text" id="top-expense-percent-label">-</p>
                    </div>
                    <div class="top-expense-values">
                        <p class="top-expense-amount" id="top-expense-amount">-</p>
                    </div>
                </div>
            </div>
            
            <!-- Period Analysis - Line Chart -->
            <div class="card" style="margin-top: 12px; padding: 12px;">
                <h3 id="period-chart-title" style="font-size: 0.9rem; font-weight: 700; margin-bottom: 8px; text-align: right;">تحليل الفترة</h3>
                <div id="month-comparison" style="width: 100%;"></div>
            </div>
        </div>
    </main>

    <!-- Goals Page -->
    <main id="page-goals" class="page">
        <div class="section" style="padding-top: 16px;">
            <!-- Available Savings Widget -->
            <div class="goals-header-card" id="goals-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <p class="goals-header-label">المدخرات المتاحة للتوزيع</p>
                        <p class="goals-header-value" id="available-savings">0</p>
                        <p class="goals-header-sub">الرصيد الصافي - المخصص للأهداف</p>
                    </div>
                    <div class="goals-header-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                </div>
            </div>
            
            <!-- Overspent Alert -->
            <div class="alert-box red" id="overspent-alert" style="display: none;">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                <div>
                    <p class="alert-title">تنبيه: صرفت من مدخراتك!</p>
                    <p class="alert-text" id="overspent-amount">اختر هدف لخصم المبلغ منه</p>
                </div>
            </div>
            
            <button class="btn btn-primary" style="margin-bottom: 16px;" onclick="openModal('goal')">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px; margin-left: 8px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                إضافة هدف جديد
            </button>
            
            <!-- Goals Summary -->
            <div class="stats-grid" style="margin-bottom: 16px;">
                <div class="stat-widget stat-widget-vertical">
                    <span class="stat-widget-title">إجمالي المخصص</span>
                    <p class="stat-widget-value blue" id="total-allocated">0</p>
                </div>
                <div class="stat-widget stat-widget-vertical">
                    <span class="stat-widget-title">عدد الأهداف</span>
                    <p class="stat-widget-value" id="goals-count">0</p>
                </div>
            </div>
            
            <!-- Goals List -->
            <div class="section-header">
                <h2 class="section-title">أهدافي</h2>
            </div>
            <div id="goals-list"></div>
        </div>
    </main>

    <!-- Settings Page -->
    <main id="page-settings" class="page">
        <div style="padding-top: 16px;">
            <!-- Appearance Settings -->
            <div class="settings-section">
                <p class="settings-section-title">المظهر</p>
                <div class="settings-card">
                    <div class="settings-item" onclick="toggleTheme()">
                        <div class="settings-item-info">
                            <div class="settings-item-icon" id="theme-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                            </div>
                            <div class="settings-item-text">
                                <h4>الوضع</h4>
                                <p id="theme-label">داكن</p>
                            </div>
                        </div>
                        <label class="toggle-checkbox" onclick="event.stopPropagation()">
                            <input type="checkbox" id="theme-toggle" onchange="toggleTheme()">
                            <span class="toggle-checkbox-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Security Settings -->
            <div class="settings-section">
                <p class="settings-section-title">الأمان</p>
                <div class="settings-card">
                    <div class="settings-item" onclick="togglePinSetting()">
                        <div class="settings-item-info">
                            <div class="settings-item-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                            </div>
                            <div class="settings-item-text">
                                <h4>قفل التطبيق برمز PIN</h4>
                                <p id="pin-status">غير مفعّل</p>
                            </div>
                        </div>
                        <label class="toggle-checkbox" onclick="event.stopPropagation()">
                            <input type="checkbox" id="pin-toggle" onchange="togglePinSetting()">
                            <span class="toggle-checkbox-slider"></span>
                        </label>
                    </div>
                    <div class="settings-item" id="change-pin-item" style="display: none;" onclick="openChangePinModal()">
                        <div class="settings-item-info">
                            <div class="settings-item-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path></svg>
                            </div>
                            <div class="settings-item-text">
                                <h4>تغيير رمز PIN</h4>
                                <p>تغيير رمز القفل الحالي</p>
                            </div>
                        </div>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px; color: var(--text-muted);"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </div>
                </div>
            </div>
            
            <!-- Cloud Sync Section -->
            <div class="settings-section">
                <p class="settings-section-title">المزامنة السحابية</p>
                <div class="settings-card">
                    <!-- Sync Status -->
                    <div class="sync-status" id="sync-status-box">
                        <div class="sync-status-icon not-synced" id="sync-status-icon">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                        </div>
                        <div class="sync-status-info">
                            <h4 id="sync-status-title">غير مرتبط</h4>
                            <p id="sync-status-desc">سجّل دخولك لمزامنة بياناتك</p>
                        </div>
                    </div>
                    
                    <!-- Google Sign In Button -->
                    <div class="settings-item" id="google-signin-btn" onclick="signInWithGoogle()">
                        <div class="settings-item-info">
                            <div class="settings-item-icon" style="background: rgba(66, 133, 244, 0.15); color: #4285f4;">
                                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                                    <path fill="#4285f4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                    <path fill="#34a853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                    <path fill="#fbbc05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                    <path fill="#ea4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                </svg>
                            </div>
                            <div class="settings-item-text">
                                <h4>تسجيل الدخول بـ Google</h4>
                                <p>لمزامنة بياناتك تلقائياً</p>
                            </div>
                        </div>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px; color: var(--text-muted);"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </div>
                    
                    <!-- Sync Actions (shown when logged in) -->
                    <div id="sync-actions" style="display: none;">
                        <div class="settings-item" onclick="syncToCloud()">
                            <div class="settings-item-info">
                                <div class="settings-item-icon" style="background: rgba(16, 185, 129, 0.15); color: var(--accent-green);">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                </div>
                                <div class="settings-item-text">
                                    <h4>رفع البيانات</h4>
                                    <p>حفظ بياناتك في السحابة</p>
                                </div>
                            </div>
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px; color: var(--text-muted);"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </div>
                        
                        <div class="settings-item" onclick="syncFromCloud()">
                            <div class="settings-item-info">
                                <div class="settings-item-icon" style="background: rgba(59, 130, 246, 0.15); color: var(--accent-blue);">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path></svg>
                                </div>
                                <div class="settings-item-text">
                                    <h4>استرجاع البيانات</h4>
                                    <p>تحميل بياناتك من السحابة</p>
                                </div>
                            </div>
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px; color: var(--text-muted);"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </div>
                        
                        <div class="settings-item" onclick="signOutFromGoogle()">
                            <div class="settings-item-info">
                                <div class="settings-item-icon" style="background: rgba(239, 68, 68, 0.15); color: var(--accent-red);">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                                </div>
                                <div class="settings-item-text">
                                    <h4>تسجيل الخروج</h4>
                                    <p id="user-email-display">-</p>
                                </div>
                            </div>
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px; color: var(--text-muted);"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Zakat Quick Access -->
            <div class="settings-section">
                <div class="card touch-feedback" style="cursor: pointer; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1)); border-color: rgba(16, 185, 129, 0.3);" onclick="openModal('zakat-info')">
                    <div style="display: flex; align-items: center; gap: 14px;">
                        <div style="width: 50px; height: 50px; border-radius: var(--radius-md); background: rgba(16, 185, 129, 0.2); display: flex; align-items: center; justify-content: center; color: var(--accent-green);">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 26px; height: 26px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                        </div>
                        <div style="flex: 1;">
                            <h3 style="font-size: 1rem; font-weight: 800; color: var(--accent-green);">حاسبة الزكاة</h3>
                            <p style="font-size: 0.8rem; color: var(--text-muted);">احسب زكاة مالك وذهبك</p>
                        </div>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px; color: var(--text-muted);"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="info-box">
                    <svg class="info-box-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <p class="info-box-text">
                        أسعار الذهب وسعر صرف الجنيه <strong>تُدخل يدوياً</strong> - التطبيق لا يتصل بالإنترنت لجلب الأسعار. يمكنك تحديثها من هنا.
                    </p>
                </div>
            </div>
            
            <div class="settings-section">
                <p class="settings-section-title">العملة والتحويل</p>
                <div class="settings-card">
                    <div class="settings-item" style="flex-direction: column; align-items: stretch; gap: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div class="settings-item-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </div>
                            <div style="flex: 1;">
                                <h4 style="font-size: 0.95rem; font-weight: 700;">العملة الأساسية</h4>
                            </div>
                        </div>
                        <div class="currency-toggle-group">
                            <button type="button" class="currency-toggle-btn" id="currency-btn-SAR" onclick="setCurrency('SAR')">
                                <span class="currency-symbol">﷼</span>
                                <span>ريال سعودي</span>
                            </button>
                            <button type="button" class="currency-toggle-btn" id="currency-btn-EGP" onclick="setCurrency('EGP')">
                                <span class="currency-symbol">ج.م</span>
                                <span>جنيه مصري</span>
                            </button>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                            </div>
                            <div class="settings-item-text">
                                <h4>سعر صرف الجنيه</h4>
                                <p id="exchange-rate-label">1 ريال = كام جنيه؟</p>
                            </div>
                        </div>
                        <input type="number" id="exchange-rate" class="form-input settings-input" value="13.2" step="0.1" onchange="saveSettings()">
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <p class="settings-section-title">الميزانية والتنبيهات</p>
                <div class="settings-card">
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                            </div>
                            <div class="settings-item-text">
                                <h4>الحد الشهري للمصاريف</h4>
                                <p>المبلغ الأقصى المسموح</p>
                            </div>
                        </div>
                        <input type="number" id="budget-input" class="form-input settings-input" value="5000" onchange="saveSettings()">
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-icon" style="background: rgba(245, 158, 11, 0.15); color: var(--accent-gold);">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                            </div>
                            <div class="settings-item-text">
                                <h4>نبهني عند الوصول لـ</h4>
                                <p>مبلغ المصروفات</p>
                            </div>
                        </div>
                        <input type="number" id="budget-alert-input" class="form-input settings-input" value="4000" onchange="saveSettings()">
                    </div>
                </div>
                <div class="info-box" style="margin-top: 12px;">
                    <svg class="info-box-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <p class="info-box-text">هيظهر تحذير لما مصروفاتك توصل للمبلغ ده</p>
                </div>
            </div>
            
            <!-- Recurring Transactions Section -->
            <div class="settings-section">
                <p class="settings-section-title">المعاملات المتكررة</p>
                <div class="settings-card">
                    <div id="recurring-list"></div>
                    <button class="btn btn-primary" style="width: 100%; margin-top: 12px;" onclick="openModal('recurring')">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 18px; height: 18px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        إضافة معاملة متكررة
                    </button>
                </div>
                <div class="info-box" style="margin-top: 12px;">
                    <svg class="info-box-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <p class="info-box-text">أضف الراتب أو الفواتير الشهرية وهتتضاف تلقائياً كل شهر</p>
                </div>
            </div>
            
            <!-- Subscriptions Section -->
            <div class="settings-section">
                <p class="settings-section-title">الاشتراكات</p>
                <div class="settings-card">
                    <div id="subscriptions-list"></div>
                    <button class="btn btn-secondary" style="width: 100%; margin-top: 12px;" onclick="openModal('subscription')">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 18px; height: 18px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        إضافة اشتراك
                    </button>
                </div>
                <div class="info-box" style="margin-top: 12px;">
                    <svg class="info-box-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <p class="info-box-text">تتبع اشتراكاتك الشهرية مثل Netflix, Spotify, etc.</p>
                </div>
            </div>
            
            <!-- Savings Challenges Section -->
            <div class="settings-section">
                <p class="settings-section-title">تحديات الادخار</p>
                <div class="settings-card">
                    <div id="challenges-list"></div>
                    <button class="btn btn-gold" style="width: 100%; margin-top: 12px;" onclick="openModal('challenge')">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 18px; height: 18px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        بدء تحدي جديد
                    </button>
                </div>
            </div>
            
            <!-- Ramadan Section -->
            <div class="settings-section">
                <p class="settings-section-title">رمضان</p>
                <div class="ramadan-card">
                    <div class="ramadan-header">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 24px; height: 24px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                        <span>مصروفات رمضان</span>
                    </div>
                    <p class="ramadan-desc">تتبع مصروفات الشهر الكريم بشكل منفصل</p>
                    
                    <div class="ramadan-categories">
                        <button class="ramadan-cat-btn" onclick="addRamadanExpense('iftar')">
                            <span class="cat-icon" style="background: rgba(251, 191, 36, 0.15); color: #fbbf24;">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                            </span>
                            <span>إفطار صائم</span>
                        </button>
                        <button class="ramadan-cat-btn" onclick="addRamadanExpense('zakat_fitr')">
                            <span class="cat-icon" style="background: rgba(34, 197, 94, 0.15); color: #22c55e;">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                            </span>
                            <span>زكاة الفطر</span>
                        </button>
                        <button class="ramadan-cat-btn" onclick="addRamadanExpense('umrah')">
                            <span class="cat-icon" style="background: rgba(14, 165, 233, 0.15); color: #0ea5e9;">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                            </span>
                            <span>عمرة</span>
                        </button>
                        <button class="ramadan-cat-btn" onclick="addRamadanExpense('ramadan_sadaqa')">
                            <span class="cat-icon" style="background: rgba(20, 184, 166, 0.15); color: #14b8a6;">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                            </span>
                            <span>صدقة رمضان</span>
                        </button>
                    </div>
                    
                    <div class="ramadan-summary" id="ramadan-summary"></div>
                </div>
            </div>
            
            <div class="settings-section">
                <p class="settings-section-title">أسعار الذهب (للجرام)</p>
                <div class="settings-card">
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-text"><h4>عيار 24</h4></div>
                        </div>
                        <input type="number" id="gold-price-24-input" class="form-input settings-input" value="295" onchange="saveGoldPrices()">
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-text"><h4>عيار 21</h4></div>
                        </div>
                        <input type="number" id="gold-price-21-input" class="form-input settings-input" value="258" onchange="saveGoldPrices()">
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-text"><h4>عيار 18</h4></div>
                        </div>
                        <input type="number" id="gold-price-18-input" class="form-input settings-input" value="221" onchange="saveGoldPrices()">
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <p class="settings-section-title">البيانات</p>
                <div class="settings-card">
                    <div class="settings-item" style="cursor: pointer;" onclick="exportData()">
                        <div class="settings-item-info">
                            <div class="settings-item-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                            </div>
                            <div class="settings-item-text">
                                <h4>تصدير البيانات</h4>
                                <p>حفظ نسخة احتياطية</p>
                            </div>
                        </div>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px; color: var(--text-muted);"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </div>
                    <div class="settings-item" style="cursor: pointer;" onclick="openModal('reset')">
                        <div class="settings-item-info">
                            <div class="settings-item-icon" style="background: rgba(239, 68, 68, 0.15); color: var(--accent-red);">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </div>
                            <div class="settings-item-text">
                                <h4 style="color: var(--accent-red);">حذف البيانات</h4>
                                <p>اختر البيانات المراد حذفها</p>
                            </div>
                        </div>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px; color: var(--text-muted);"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </div>
                </div>
            </div>
            
            <p style="text-align: center; color: var(--text-muted); font-size: 0.8rem; padding: 24px 16px;">
                المحفظة الذكية الإصدار 4.0
            </p>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item active" onclick="showPage('home', this)">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
            <span>الرئيسية</span>
        </button>
        <button class="nav-item" onclick="showPage('transactions', this)">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
            <span>المعاملات</span>
        </button>
        <button class="nav-item" onclick="showPage('goals', this)">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span>الأهداف</span>
        </button>
        <button class="nav-item" onclick="showPage('debts', this)">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
            <span>ديون وأقساط</span>
        </button>
        <button class="nav-item" onclick="showPage('gold', this)">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span>الذهب</span>
        </button>
        <button class="nav-item" onclick="showPage('reports', this)">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
            <span>التقارير</span>
        </button>
    </nav>

    <!-- Welcome Screen (First Time) -->
    <div class="welcome-screen" id="welcome-screen" style="display: none;">
        <div class="welcome-content">
            <div class="welcome-icon">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 60px; height: 60px; color: var(--accent-green);">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <h2 class="welcome-title">أهلاً بك في محفظتي!</h2>
            <p class="welcome-subtitle">لنبدأ بإدخال رصيدك الافتتاحي</p>
            
            <div class="welcome-form">
                <label class="form-label">الرصيد الافتتاحي</label>
                <input type="number" id="opening-balance" class="form-input" placeholder="0" style="font-size: 1.5rem; text-align: center; font-weight: 800;">
                <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 8px;">أدخل المبلغ الموجود معك حالياً</p>
            </div>
            
            <button class="btn btn-primary" onclick="saveOpeningBalance()" style="width: 100%; margin-top: 20px; padding: 16px;">
                ابدأ الآن
            </button>
            
            <button class="btn btn-secondary" onclick="skipOpeningBalance()" style="width: 100%; margin-top: 10px;">
                تخطي (ابدأ من صفر)
            </button>
        </div>
    </div>

    <!-- Modals -->
    <!-- Income Modal -->
    <div class="modal-overlay" id="modal-income">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">إضافة دخل</h3>
                <button class="modal-close" onclick="closeModal('income')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="amount-input-box">
                    <input type="number" id="income-amount" placeholder="0" inputmode="decimal">
                    <p class="amount-input-currency" id="income-currency-label"></p>
                </div>
                
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <label class="form-label" style="margin: 0;">التصنيف</label>
                        <button type="button" class="add-category-btn" onclick="openModal('custom-category'); customCategoryType='income';">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            جديد
                        </button>
                    </div>
                    <div class="category-grid" id="income-categories"></div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">ملاحظة (اختياري)</label>
                        <input type="text" id="income-note" class="form-input" placeholder="مثال: مرتب شهر يناير">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">الوقت (اختياري)</label>
                        <input type="time" id="income-time" class="form-input" style="text-align: center;">
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-success" onclick="addIncome()">إضافة الدخل</button>
            </div>
        </div>
    </div>

    <!-- Expense Modal -->
    <div class="modal-overlay" id="modal-expense">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">إضافة مصروف</h3>
                <button class="modal-close" onclick="closeModal('expense')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="amount-input-box">
                    <input type="number" id="expense-amount" placeholder="0" inputmode="decimal">
                    <p class="amount-input-currency" id="expense-currency-label"></p>
                </div>
                
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <label class="form-label" style="margin: 0;">التصنيف</label>
                        <button type="button" class="add-category-btn" onclick="openModal('custom-category'); customCategoryType='expense';">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            جديد
                        </button>
                    </div>
                    <div class="category-grid" id="expense-categories"></div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">ملاحظة (اختياري)</label>
                        <input type="text" id="expense-note" class="form-input" placeholder="مثال: فاتورة الكهرباء">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">الوقت (اختياري)</label>
                        <input type="time" id="expense-time" class="form-input" style="text-align: center;">
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="addExpense()">إضافة المصروف</button>
            </div>
        </div>
    </div>

    <!-- Custom Category Modal -->
    <div class="modal-overlay" id="modal-custom-category">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">تصنيف جديد</h3>
                <button class="modal-close" onclick="closeModal('custom-category')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="form-group">
                <label class="form-label">اسم التصنيف</label>
                <input type="text" id="custom-category-name" class="form-input" placeholder="مثال: اشتراكات">
            </div>
            
            <div class="form-group">
                <label class="form-label">اللون</label>
                <div class="color-picker-grid">
                    <button class="color-option active" style="background: #ef4444;" onclick="selectCategoryColor('#ef4444', this)"></button>
                    <button class="color-option" style="background: #f97316;" onclick="selectCategoryColor('#f97316', this)"></button>
                    <button class="color-option" style="background: #f59e0b;" onclick="selectCategoryColor('#f59e0b', this)"></button>
                    <button class="color-option" style="background: #10b981;" onclick="selectCategoryColor('#10b981', this)"></button>
                    <button class="color-option" style="background: #06b6d4;" onclick="selectCategoryColor('#06b6d4', this)"></button>
                    <button class="color-option" style="background: #3b82f6;" onclick="selectCategoryColor('#3b82f6', this)"></button>
                    <button class="color-option" style="background: #8b5cf6;" onclick="selectCategoryColor('#8b5cf6', this)"></button>
                    <button class="color-option" style="background: #ec4899;" onclick="selectCategoryColor('#ec4899', this)"></button>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="addCustomCategory()">إضافة التصنيف</button>
        </div>
    </div>

    <!-- Delete Category Modal -->
    <div class="modal-overlay" id="modal-delete-category">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">حذف التصنيف</h3>
                <button class="modal-close" onclick="closeModal('delete-category')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div id="delete-category-content">
                <!-- Content will be filled dynamically -->
            </div>
        </div>
    </div>

    <!-- Debt Modal -->
    <div class="modal-overlay" id="modal-debt">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">إضافة دين</h3>
                <button class="modal-close" onclick="closeModal('debt')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="toggle-group" style="margin-bottom: 20px;">
                    <button class="toggle-btn active green" id="debt-type-to" onclick="setDebtType('to_me')">لي عند حد</button>
                    <button class="toggle-btn" id="debt-type-from" onclick="setDebtType('from_me')">عليّ لحد</button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">اسم الشخص</label>
                    <input type="text" id="debt-person" class="form-input" placeholder="مثال: أحمد">
                </div>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label">المبلغ</label>
                        <input type="number" id="debt-amount" class="form-input" placeholder="0" inputmode="decimal">
                    </div>
                    <div class="form-group">
                        <label class="form-label">العملة</label>
                        <select id="debt-currency" class="form-select">
                            <option value="SAR">ريال</option>
                            <option value="EGP">جنيه</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">ملاحظة (اختياري)</label>
                    <input type="text" id="debt-note" class="form-input" placeholder="مثال: سلفة">
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="addDebt()">إضافة الدين</button>
            </div>
        </div>
    </div>

    <!-- Pay Modal -->
    <div class="modal-overlay" id="modal-pay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">سداد دين</h3>
                <button class="modal-close" onclick="closeModal('pay')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 16px; font-weight: 600;">المتبقي: <span id="pay-remaining" style="color: var(--text-primary); font-weight: 800;">0</span></p>
                
                <div class="form-group">
                    <label class="form-label">مبلغ السداد</label>
                    <input type="number" id="pay-amount" class="form-input" placeholder="0" inputmode="decimal">
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-outline" style="flex: 1;" onclick="setPayFull()">سداد كامل</button>
                    <button class="btn btn-outline" style="flex: 1;" onclick="setPayHalf()">نصف المبلغ</button>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-success" onclick="payDebt()">تأكيد السداد</button>
            </div>
        </div>
    </div>

    <!-- Installment Modal -->
    <div class="modal-overlay" id="modal-installment">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">إضافة قسط</h3>
                <button class="modal-close" onclick="closeModal('installment')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">اسم القسط / الجهة</label>
                    <input type="text" id="installment-name" class="form-input" placeholder="مثال: قسط السيارة - بنك الراجحي">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label">التصنيف</label>
                        <select id="installment-category" class="form-select">
                            <option value="car">سيارة</option>
                            <option value="property">عقار</option>
                            <option value="device">أجهزة</option>
                            <option value="loan">قرض</option>
                            <option value="furniture">أثاث</option>
                            <option value="other">أخرى</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">العملة</label>
                        <select id="installment-currency" class="form-select">
                            <option value="SAR">ريال</option>
                            <option value="EGP">جنيه</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label">المبلغ الإجمالي</label>
                        <input type="number" id="installment-total" class="form-input" placeholder="90000" inputmode="decimal" oninput="calculateInstallmentMonths()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">قيمة القسط</label>
                        <input type="number" id="installment-amount" class="form-input" placeholder="2500" inputmode="decimal" oninput="calculateInstallmentMonths()">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">عدد الأقساط المتبقية</label>
                    <input type="number" id="installment-remaining" class="form-input" placeholder="36" inputmode="numeric">
                </div>
                
                <div class="form-group">
                    <label class="form-label">يوم السداد الشهري</label>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <label class="toggle-checkbox" style="flex-shrink: 0;">
                            <input type="checkbox" id="installment-has-day" onchange="toggleInstallmentDay()">
                            <span class="toggle-checkbox-slider"></span>
                        </label>
                        <span style="color: var(--text-muted); font-size: 0.85rem;">تحديد يوم</span>
                        <input type="number" id="installment-day" class="form-input" placeholder="1-28" min="1" max="28" style="width: 100px; text-align: center;" disabled>
                    </div>
                </div>
                
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">ملاحظة (اختياري)</label>
                    <input type="text" id="installment-note" class="form-input" placeholder="مثال: ينتهي ديسمبر 2026">
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="addInstallment()">إضافة القسط</button>
            </div>
        </div>
    </div>

    <!-- Pay Installment Modal -->
    <div class="modal-overlay" id="modal-pay-installment">
        <div class="modal-content">
            
            <div class="modal-header">
                <h3 class="modal-title">سداد قسط</h3>
                <button class="modal-close" onclick="closeModal('pay-installment')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <p style="color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">قيمة القسط: <span id="pay-installment-value" style="color: var(--text-primary); font-weight: 800;">0</span></p>
            <p style="color: var(--text-secondary); margin-bottom: 16px; font-weight: 600;">الأقساط المتبقية: <span id="pay-installment-remaining" style="color: var(--accent-blue); font-weight: 800;">0</span></p>
            
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" style="flex: 1;" onclick="payInstallment(1)">سداد قسط واحد</button>
                <button class="btn btn-outline" style="flex: 1;" onclick="payInstallmentCustom()">عدد مخصص</button>
            </div>
        </div>
    </div>

    <!-- Gold Modal -->
    <div class="modal-overlay" id="modal-gold">
        <div class="modal-content">
            
            <div class="modal-header">
                <h3 class="modal-title">إضافة ذهب</h3>
                <button class="modal-close" onclick="closeModal('gold')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="form-group">
                <label class="form-label">نوع الذهب</label>
                <div class="toggle-group">
                    <button class="toggle-btn active" id="gold-type-24" onclick="setGoldType('24')" style="background: var(--accent-gold); color: #000;">عيار 24</button>
                    <button class="toggle-btn" id="gold-type-21" onclick="setGoldType('21')">عيار 21</button>
                    <button class="toggle-btn" id="gold-type-18" onclick="setGoldType('18')">عيار 18</button>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">الوزن (جرام)</label>
                <input type="number" id="gold-weight" class="form-input" placeholder="مثال: 10" step="0.01" oninput="updateGoldPreview()">
            </div>
            
            <div class="form-group">
                <label class="form-label">سعر الشراء للجرام</label>
                <input type="number" id="gold-purchase-price" class="form-input" placeholder="سعر الجرام وقت الشراء" oninput="updateGoldPreview()">
            </div>
            
            <div id="gold-preview" style="display: none; background: rgba(245, 158, 11, 0.1); border: 1px solid var(--accent-gold); border-radius: var(--radius-lg); padding: 16px; text-align: center; margin-bottom: 16px;">
                <p style="color: var(--text-muted); font-size: 0.85rem;">إجمالي المبلغ</p>
                <p style="color: var(--accent-gold); font-size: 1.5rem; font-weight: 900;" id="gold-total-preview">0</p>
            </div>
            
            <button class="btn btn-gold" onclick="addGold()">إضافة الذهب</button>
        </div>
    </div>

    <!-- Sadaqa Modal -->
    <div class="modal-overlay" id="modal-sadaqa">
        <div class="modal-content">
            
            <div class="modal-header">
                <h3 class="modal-title">صدقة جارية</h3>
                <button class="modal-close" onclick="closeModal('sadaqa')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div style="text-align: center; margin-bottom: 24px;">
                <div style="width: 72px; height: 72px; border-radius: 50%; background: linear-gradient(135deg, #ec4899, #f43f5e); display: flex; align-items: center; justify-content: center; margin: 0 auto 12px;">
                    <svg fill="none" stroke="white" viewBox="0 0 24 24" style="width: 36px; height: 36px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                </div>
                <p style="color: var(--text-muted);">"ما نقص مال من صدقة"</p>
            </div>
            
            <div class="form-group">
                <label class="form-label">المبلغ</label>
                <input type="number" id="sadaqa-amount" class="form-input" placeholder="0" inputmode="decimal">
            </div>
            
            <div class="form-group">
                <label class="form-label">ملاحظة (اختياري)</label>
                <input type="text" id="sadaqa-note" class="form-input" placeholder="مثال: صدقة عن والدي">
            </div>
            
            <button class="btn" style="background: linear-gradient(135deg, #ec4899, #f43f5e); color: white;" onclick="addSadaqa()">تسجيل الصدقة</button>
        </div>
    </div>

    <!-- Goal Modal -->
    <div class="modal-overlay" id="modal-goal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">إضافة هدف جديد</h3>
                <button class="modal-close" onclick="closeModal('goal')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="form-group">
                <label class="form-label">اسم الهدف</label>
                <input type="text" id="goal-name" class="form-input" placeholder="مثال: سيارة جديدة">
            </div>
            
            <div class="form-group">
                <label class="form-label">المبلغ المستهدف</label>
                <input type="number" id="goal-target" class="form-input" placeholder="مثال: 50000" inputmode="decimal">
            </div>
            
            <button class="btn btn-primary" onclick="addGoal()">إنشاء الهدف</button>
        </div>
    </div>

    <!-- Add to Goal Modal -->
    <div class="modal-overlay" id="modal-add-to-goal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">إضافة مبلغ للهدف</h3>
                <button class="modal-close" onclick="closeModal('add-to-goal')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div style="background: var(--bg-input); border-radius: var(--radius-md); padding: 14px; margin-bottom: 16px;">
                <p style="font-size: 0.85rem; color: var(--text-muted);">الهدف: <span id="add-goal-name" style="color: var(--text-primary); font-weight: 700;"></span></p>
                <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">المتاح للتوزيع: <span id="add-available" style="color: var(--accent-green); font-weight: 700;"></span></p>
            </div>
            
            <div class="form-group">
                <label class="form-label">المبلغ</label>
                <input type="number" id="add-goal-amount" class="form-input" placeholder="0" inputmode="decimal">
            </div>
            
            <button class="btn btn-primary" onclick="addToGoal()">إضافة</button>
        </div>
    </div>

    <!-- Withdraw from Goal Modal -->
    <div class="modal-overlay" id="modal-withdraw-goal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">سحب من الهدف</h3>
                <button class="modal-close" onclick="closeModal('withdraw-goal')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div style="background: var(--bg-input); border-radius: var(--radius-md); padding: 14px; margin-bottom: 16px;">
                <p style="font-size: 0.85rem; color: var(--text-muted);">الهدف: <span id="withdraw-goal-name" style="color: var(--text-primary); font-weight: 700;"></span></p>
                <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">المخصص حالياً: <span id="withdraw-available" style="color: var(--accent-blue); font-weight: 700;"></span></p>
            </div>
            
            <div class="form-group">
                <label class="form-label">المبلغ المراد سحبه</label>
                <input type="number" id="withdraw-goal-amount" class="form-input" placeholder="0" inputmode="decimal">
            </div>
            
            <button class="btn" style="background: var(--accent-gold); color: #000;" onclick="withdrawFromGoal()">سحب</button>
        </div>
    </div>

    <!-- Zakat Info Modal -->
    <div class="modal-overlay" id="modal-zakat-info">
        <div class="modal-content" style="max-height: 90vh;">
            <div class="modal-header">
                <h3 class="modal-title">حاسبة الزكاة</h3>
                <button class="modal-close" onclick="closeModal('zakat-info')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <!-- Nisab Explanation -->
            <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: var(--radius-md); padding: 14px; margin-bottom: 16px;">
                <p style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.6;">
                    <strong style="color: var(--accent-green);">النصاب</strong> = قيمة 85 جرام ذهب عيار 24. إذا بلغت ثروتك النصاب ومر عليها سنة، تجب الزكاة بنسبة 2.5%
                </p>
            </div>
            
            <div class="stats-grid" style="margin-bottom: 16px;">
                <div class="stat-widget">
                    <div class="stat-widget-right">
                        <span class="stat-widget-title">قيمة النصاب</span>
                    </div>
                    <div class="stat-widget-left">
                        <p class="stat-widget-value green" id="zakat-nisab">0</p>
                    </div>
                </div>
                <div class="stat-widget">
                    <div class="stat-widget-right">
                        <span class="stat-widget-title">سعر جرام 24</span>
                    </div>
                    <div class="stat-widget-left">
                        <p class="stat-widget-value" id="zakat-gold-price">0</p>
                    </div>
                </div>
            </div>
            
            <div class="card" style="margin-bottom: 16px;">
                <h4 style="font-size: 0.9rem; font-weight: 800; margin-bottom: 12px;">ثروتك الخاضعة للزكاة</h4>
                <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                    <span style="color: var(--text-muted);">النقدي</span>
                    <span id="zakat-cash" style="font-weight: 700;">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                    <span style="color: var(--text-muted);">الذهب</span>
                    <span id="zakat-gold" style="font-weight: 700; color: var(--accent-gold);">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 12px 0; font-weight: 800;">
                    <span>الإجمالي</span>
                    <span id="zakat-total" style="color: var(--accent-blue);">0</span>
                </div>
            </div>
            
            <div class="card" id="zakat-result"></div>
            
            <div style="margin-top: 16px;">
                <button class="btn" style="background: linear-gradient(135deg, #ec4899, #f43f5e); color: white;" onclick="closeModal('zakat-info'); openModal('sadaqa');">تبرع بصدقة</button>
            </div>
        </div>
    </div>

    <!-- Converter Modal -->
    <div class="modal-overlay" id="modal-converter">
        <div class="modal-content">
            
            <div class="modal-header">
                <h3 class="modal-title">تحويل العملات</h3>
                <button class="modal-close" onclick="closeModal('converter')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div style="background: var(--bg-input); border-radius: var(--radius-md); padding: 16px; margin-bottom: 20px;">
                <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 4px;">سعر الصرف الحالي</p>
                <p style="font-size: 1rem; font-weight: 700;">1 <span id="conv-from-currency">ريال</span> = <span id="conv-rate" style="color: var(--accent-blue);">13.2</span> جنيه مصري</p>
            </div>
            
            <div class="form-group">
                <label class="form-label">المبلغ بـ<span id="conv-currency-name">الريال</span></label>
                <input type="number" id="converter-amount" class="form-input" placeholder="0" oninput="convertCurrency()">
            </div>
            
            <div class="converter-result-box">
                <p class="converter-result-label">المبلغ بالجنيه المصري</p>
                <p class="converter-result-value" id="converted-amount">0.00 ج.م</p>
            </div>
            
            <div style="margin-top: 16px; text-align: center;">
                <p style="color: var(--text-muted); font-size: 0.8rem;">رصيدك الحالي بالمصري: <span id="balance-in-egp" style="color: var(--accent-green); font-weight: 800;">0</span></p>
            </div>
        </div>
    </div>

    <!-- Reset Data Modal -->
    <div class="modal-overlay" id="modal-reset">
        <div class="modal-content">
            
            <div class="modal-header">
                <h3 class="modal-title">حذف البيانات</h3>
                <button class="modal-close" onclick="closeModal('reset')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <p style="color: var(--text-muted); margin-bottom: 16px; font-size: 0.9rem;">اختر البيانات التي تريد حذفها:</p>
            
            <label class="checkbox-item">
                <input type="checkbox" id="reset-transactions">
                <span class="checkbox-box">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                </span>
                <span class="checkbox-label">المعاملات (الدخل والمصروفات)</span>
            </label>
            
            <label class="checkbox-item">
                <input type="checkbox" id="reset-debts">
                <span class="checkbox-box">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                </span>
                <span class="checkbox-label">الديون</span>
            </label>
            
            <label class="checkbox-item">
                <input type="checkbox" id="reset-gold">
                <span class="checkbox-box">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                </span>
                <span class="checkbox-label">محفظة الذهب</span>
            </label>
            
            <label class="checkbox-item">
                <input type="checkbox" id="reset-goals">
                <span class="checkbox-box">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                </span>
                <span class="checkbox-label">الأهداف</span>
            </label>
            
            <label class="checkbox-item">
                <input type="checkbox" id="reset-settings">
                <span class="checkbox-box">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                </span>
                <span class="checkbox-label">الإعدادات (العملة، الميزانية، أسعار الذهب)</span>
            </label>
            
            <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                <button type="button" class="btn btn-danger" id="confirm-reset-btn">تأكيد الحذف</button>
            </div>
        </div>
    </div>

    <!-- Recurring Transaction Modal -->
    <div class="modal-overlay" id="modal-recurring">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">معاملة متكررة</h3>
                <button class="modal-close" onclick="closeModal('recurring')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="toggle-group" style="margin-bottom: 16px;">
                <button class="toggle-btn active" id="recurring-type-income" onclick="setRecurringType('income')">دخل</button>
                <button class="toggle-btn" id="recurring-type-expense" onclick="setRecurringType('expense')">مصروف</button>
            </div>
            <label class="form-label">الاسم</label>
            <input type="text" id="recurring-name" class="form-input" placeholder="مثال: راتب شهري">
            <label class="form-label">المبلغ</label>
            <input type="number" id="recurring-amount" class="form-input" placeholder="0">
            <label class="form-label">التصنيف</label>
            <select id="recurring-category" class="form-select"></select>
            <label class="form-label">يوم التكرار (من الشهر)</label>
            <input type="number" id="recurring-day" class="form-input" placeholder="1" min="1" max="28" value="1">
            <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" onclick="addRecurring()">إضافة</button>
        </div>
    </div>

    <!-- Subscription Modal -->
    <div class="modal-overlay" id="modal-subscription">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">إضافة اشتراك</h3>
                <button class="modal-close" onclick="closeModal('subscription')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <label class="form-label">اسم الخدمة</label>
            <input type="text" id="subscription-name" class="form-input" placeholder="Netflix, Spotify...">
            <label class="form-label">المبلغ الشهري</label>
            <input type="number" id="subscription-amount" class="form-input" placeholder="0">
            <label class="form-label">يوم التجديد</label>
            <input type="number" id="subscription-day" class="form-input" placeholder="1" min="1" max="28" value="1">
            <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" onclick="addSubscription()">إضافة</button>
        </div>
    </div>

    <!-- Challenge Modal -->
    <div class="modal-overlay" id="modal-challenge">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">تحدي ادخار جديد</h3>
                <button class="modal-close" onclick="closeModal('challenge')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <label class="form-label">اسم التحدي</label>
            <input type="text" id="challenge-name" class="form-input" placeholder="مثال: وفر 500 هذا الأسبوع">
            <label class="form-label">المبلغ المستهدف</label>
            <input type="number" id="challenge-target" class="form-input" placeholder="500">
            <label class="form-label">المدة (بالأيام)</label>
            <input type="number" id="challenge-days" class="form-input" placeholder="7" value="7">
            <button class="btn btn-gold" style="width: 100%; margin-top: 16px;" onclick="addChallenge()">ابدأ التحدي</button>
        </div>
    </div>

    <!-- Ramadan Expense Modal -->
    <div class="modal-overlay" id="modal-ramadan">
        <div class="modal-content ramadan-modal">
            <div class="ramadan-modal-header">
                <div class="ramadan-modal-icon" id="ramadan-modal-icon">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </div>
                <h3 class="ramadan-modal-title" id="ramadan-modal-title">إفطار صائم</h3>
                <button class="modal-close" onclick="closeModal('ramadan')" style="position: absolute; left: 16px; top: 16px;">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div style="padding: 20px;">
                <label class="form-label">المبلغ</label>
                <div class="amount-input-box" style="margin-bottom: 16px;">
                    <input type="number" id="ramadan-amount" placeholder="0" style="font-size: 2rem;">
                </div>
                <label class="form-label">ملاحظة (اختياري)</label>
                <input type="text" id="ramadan-note" class="form-input" placeholder="مثال: إفطار 10 أشخاص" style="margin-bottom: 20px;">
                <button class="btn ramadan-save-btn" onclick="saveRamadanExpense()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    حفظ
                </button>
            </div>
        </div>
    </div>

    <!-- PIN Lock Screen -->
    <div id="pin-lock-screen" class="pin-lock-screen" style="display: none;">
        <div class="pin-lock-content">
            <div class="pin-lock-icon">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 60px; height: 60px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>
            </div>
            <h2 class="pin-lock-title">أدخل رمز PIN</h2>
            <p class="pin-lock-subtitle" id="pin-lock-message">أدخل الرمز المكون من 4 أرقام</p>
            <div class="pin-dots" id="pin-dots">
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
            </div>
            <div class="pin-keypad">
                <button class="pin-key touch-feedback" onclick="enterPin(1)">1</button>
                <button class="pin-key touch-feedback" onclick="enterPin(2)">2</button>
                <button class="pin-key touch-feedback" onclick="enterPin(3)">3</button>
                <button class="pin-key touch-feedback" onclick="enterPin(4)">4</button>
                <button class="pin-key touch-feedback" onclick="enterPin(5)">5</button>
                <button class="pin-key touch-feedback" onclick="enterPin(6)">6</button>
                <button class="pin-key touch-feedback" onclick="enterPin(7)">7</button>
                <button class="pin-key touch-feedback" onclick="enterPin(8)">8</button>
                <button class="pin-key touch-feedback" onclick="enterPin(9)">9</button>
                <button class="pin-key touch-feedback" style="visibility: hidden;"></button>
                <button class="pin-key touch-feedback" onclick="enterPin(0)">0</button>
                <button class="pin-key touch-feedback pin-key-delete" onclick="deletePin()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 24px; height: 24px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M3 12l6.414 6.414a2 2 0 001.414.586H19a2 2 0 002-2V7a2 2 0 00-2-2h-8.172a2 2 0 00-1.414.586L3 12z"></path></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Set PIN Modal -->
    <div class="modal-overlay" id="modal-set-pin">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="set-pin-title">إنشاء رمز PIN</h3>
                <button class="modal-close" onclick="closeSetPinModal()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <p style="color: var(--text-secondary); margin-bottom: 16px; text-align: center;" id="set-pin-message">أدخل رمز مكون من 4 أرقام</p>
            <div class="pin-dots" id="set-pin-dots" style="justify-content: center; margin-bottom: 24px;">
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
            </div>
            <div class="pin-keypad" style="max-width: 280px; margin: 0 auto;">
                <button class="pin-key touch-feedback" onclick="enterSetPin(1)">1</button>
                <button class="pin-key touch-feedback" onclick="enterSetPin(2)">2</button>
                <button class="pin-key touch-feedback" onclick="enterSetPin(3)">3</button>
                <button class="pin-key touch-feedback" onclick="enterSetPin(4)">4</button>
                <button class="pin-key touch-feedback" onclick="enterSetPin(5)">5</button>
                <button class="pin-key touch-feedback" onclick="enterSetPin(6)">6</button>
                <button class="pin-key touch-feedback" onclick="enterSetPin(7)">7</button>
                <button class="pin-key touch-feedback" onclick="enterSetPin(8)">8</button>
                <button class="pin-key touch-feedback" onclick="enterSetPin(9)">9</button>
                <button class="pin-key touch-feedback" style="visibility: hidden;"></button>
                <button class="pin-key touch-feedback" onclick="enterSetPin(0)">0</button>
                <button class="pin-key touch-feedback pin-key-delete" onclick="deleteSetPin()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 24px; height: 24px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M3 12l6.414 6.414a2 2 0 001.414.586H19a2 2 0 002-2V7a2 2 0 00-2-2h-8.172a2 2 0 00-1.414.586L3 12z"></path></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Installment Alert Toast -->
    <div id="installment-alert-toast" class="alert-toast" style="display: none;">
        <div class="alert-toast-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        </div>
        <div class="alert-toast-content">
            <p class="alert-toast-title" id="alert-toast-title">تذكير بالقسط</p>
            <p class="alert-toast-message" id="alert-toast-message"></p>
        </div>
        <button class="alert-toast-close" onclick="closeAlertToast()">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </div>

    <script>
        // Data
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let debts = JSON.parse(localStorage.getItem('debts')) || [];
        let goldHoldings = JSON.parse(localStorage.getItem('goldHoldings')) || [];
        let goals = JSON.parse(localStorage.getItem('goals')) || [];
        let recurringTransactions = JSON.parse(localStorage.getItem('recurringTransactions')) || [];
        let subscriptions = JSON.parse(localStorage.getItem('subscriptions')) || [];
        let challenges = JSON.parse(localStorage.getItem('challenges')) || [];
        let installments = JSON.parse(localStorage.getItem('installments')) || [];
        let currentDebtsPageFilter = 'debts_to_me';
        let currentPayInstallmentId = null;
        let settings = JSON.parse(localStorage.getItem('settings')) || {
            currency: 'SAR',
            exchangeRate: 13.2,
            monthlyBudget: 5000,
            budgetAlert: 4000,
            goldPrices: { '24': 295, '21': 258, '18': 221 }
        };
        // Ensure budgetAlert exists for older data
        if (!settings.budgetAlert) settings.budgetAlert = 4000;
        
        // Currency config
        const currencyData = {
            SAR: { symbol: 'SAR', name: 'ريال', useSVG: true },
            EGP: { symbol: 'ج.م', name: 'جنيه', useSVG: false },
            AED: { symbol: 'د.إ', name: 'درهم', useSVG: false },
            KWD: { symbol: 'د.ك', name: 'دينار', useSVG: false },
            USD: { symbol: '$', name: 'دولار', useSVG: false }
        };
        
        // Categories
        const expenseCategories = [
            { id: 'food', name: 'طعام', color: '#ef4444', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 6c0-1.1.9-2 2-2h12a2 2 0 012 2M4 6v2a2 2 0 002 2h12a2 2 0 002-2V6m-8 4v8m-4-4h8M6 18h12a2 2 0 002-2v-2H4v2a2 2 0 002 2z"></path>' },
            { id: 'transport', name: 'مواصلات', color: '#f97316', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 17h.01M16 17h.01M5 11l1.5-4.5h11L19 11M5 11h14M5 11v6h2m0 0a2 2 0 104 0m-4 0h4m4 0a2 2 0 104 0m-4 0h-4m8 0h2v-6"></path>' },
            { id: 'home', name: 'البيت', color: '#6366f1', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>' },
            { id: 'health', name: 'صحة', color: '#06b6d4', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>' },
            { id: 'bills', name: 'فواتير', color: '#8b5cf6', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>' },
            { id: 'shopping', name: 'تسوق', color: '#ec4899', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>' },
            { id: 'wedding', name: 'الفرح', color: '#f43f5e', icon: '<circle cx="12" cy="14" r="6" stroke-width="2" fill="none"></circle><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 8l3-4 3 4H9z"></path>' },
            { id: 'gifts', name: 'هدايا', color: '#a855f7', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path>' },
            { id: 'fun', name: 'ترفيه', color: '#f59e0b', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>' },
            { id: 'education', name: 'تعليم', color: '#10b981', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>' },
            { id: 'sadaqa', name: 'صدقة', color: '#14b8a6', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11v4m0 0l2-2m-2 2l-2-2"></path>' },
            { id: 'other', name: 'أخرى', color: '#6b7280', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z"></path>' },
        ];
        
        // Ramadan specific categories
        const ramadanCategories = [
            { id: 'iftar', name: 'إفطار صائم', color: '#fbbf24', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>' },
            { id: 'zakat_fitr', name: 'زكاة الفطر', color: '#22c55e', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>' },
            { id: 'umrah', name: 'عمرة', color: '#0ea5e9', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>' },
            { id: 'ramadan_sadaqa', name: 'صدقة رمضان', color: '#14b8a6', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>' },
        ];
        
        const incomeCategories = [
            { id: 'salary', name: 'راتب', color: '#10b981', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>' },
            { id: 'freelance', name: 'عمل حر', color: '#3b82f6', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>' },
            { id: 'gift', name: 'هدية', color: '#ec4899', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path>' },
            { id: 'invest', name: 'استثمار', color: '#f59e0b', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>' },
            { id: 'opening', name: 'رصيد افتتاحي', color: '#8b5cf6', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>' },
            { id: 'other', name: 'أخرى', color: '#6b7280', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z"></path>' },
        ];
        
        // State
        let currentDebtType = 'to_me';
        let currentGoldType = '24';
        let currentDebtFilter = 'to_me';
        let currentTransactionFilter = 'all';
        let currentPayDebtId = null;
        let selectedIncomeCategory = '';
        let selectedExpenseCategory = '';
        let currentGoalId = null;
        let transFromDate = null;
        let transToDate = null;
        let transCalendarCurrentMonth = new Date();
        let activeTransCalendar = null;
        let customCategoryType = 'expense';
        let customCategoryColor = '#ef4444';
        let customExpenseCategories = JSON.parse(localStorage.getItem('customExpenseCategories')) || [];
        let customIncomeCategories = JSON.parse(localStorage.getItem('customIncomeCategories')) || [];
        
        // Format money with symbol on LEFT of number
        function formatMoney(amount, showCurrency = true) {
            const num = new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(Math.abs(amount));
            if (!showCurrency) return num;
            const curr = currencyData[settings.currency];
            if (curr.useSVG) {
                return `<span class="money-display"><svg class="sar-symbol-inline"><use href="#sar-icon"></use></svg> ${num}</span>`;
            }
            return `<span class="money-display">${curr.symbol} ${num}</span>`;
        }
        
        function formatMoneyPlain(amount) {
            return new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(Math.abs(amount));
        }
        
        function formatMoneyWithSymbol(amount) {
            const curr = currencyData[settings.currency];
            const formatted = formatMoneyPlain(amount);
            if (curr.useSVG) {
                return `<span class="money-display"><svg class="sar-symbol-inline"><use href="#sar-icon"></use></svg> ${formatted}</span>`;
            }
            return `<span class="money-display">${curr.symbol} ${formatted}</span>`;
        }
        
        function formatMoneyText(amount) {
            const curr = currencyData[settings.currency];
            const formatted = formatMoneyPlain(amount);
            return `${curr.symbol} ${formatted}`;
        }
        
        function formatEGP(amount) {
            const egp = amount * settings.exchangeRate;
            return `≈ ${new Intl.NumberFormat('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(egp)} ج.م`;
        }
        
        function formatDate(date, showTime = false) {
            const d = new Date(date);
            let result = d.toLocaleDateString('ar-EG', { month: 'short', day: 'numeric' });
            if (showTime) {
                const hours = d.getHours();
                const minutes = d.getMinutes();
                if (hours !== 0 || minutes !== 0) {
                    const period = hours >= 12 ? 'م' : 'ص';
                    const h = hours % 12 || 12;
                    const m = minutes.toString().padStart(2, '0');
                    result += ` • ${h}:${m} ${period}`;
                }
            }
            return result;
        }
        
        function formatDateTime(date) {
            return formatDate(date, true);
        }
        
        function generateId() { return Math.random().toString(36).substr(2, 9); }
        
        function saveData() {
            localStorage.setItem('transactions', JSON.stringify(transactions));
            localStorage.setItem('debts', JSON.stringify(debts));
            localStorage.setItem('goldHoldings', JSON.stringify(goldHoldings));
            localStorage.setItem('goals', JSON.stringify(goals));
            localStorage.setItem('settings', JSON.stringify(settings));
            localStorage.setItem('installments', JSON.stringify(installments));
        }
        
        // Navigation
        function showPage(pageId, btn) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            if (btn) btn.classList.add('active');
            if (pageId === 'reports') initReportDates();
            updateUI();
        }
        
        function openModal(type) {
            document.getElementById('modal-' + type).classList.add('active');
            if (type === 'converter') updateConverterModal();
            if (type === 'gold') document.getElementById('gold-purchase-price').value = settings.goldPrices[currentGoldType];
            if (type === 'recurring') populateRecurringCategories();
        }
        
        function closeModal(type) { 
            document.getElementById('modal-' + type).classList.remove('active');
            if (type === 'recurring') resetRecurringModal();
            if (type === 'subscription') resetSubscriptionModal();
        }
        
        // Categories
        function initCategories() {
            const incomeContainer = document.getElementById('income-categories');
            const expenseContainer = document.getElementById('expense-categories');
            
            // Clear containers
            incomeContainer.innerHTML = '';
            expenseContainer.innerHTML = '';
            
            // Add built-in income categories
            incomeCategories.forEach(cat => {
                incomeContainer.innerHTML += `
                    <div class="category-item" onclick="selectIncomeCategory('${cat.id}', this)">
                        <div class="category-icon" style="background: ${cat.color}20; color: ${cat.color};">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">${cat.icon}</svg>
                        </div>
                        <span class="category-name">${cat.name}</span>
                    </div>
                `;
            });
            
            // Add custom income categories with delete button
            customIncomeCategories.forEach(cat => {
                incomeContainer.innerHTML += `
                    <div class="category-item custom-category" onclick="selectIncomeCategory('${cat.id}', this)">
                        <button class="category-delete-btn" onclick="event.stopPropagation(); openDeleteCategoryModal('${cat.id}', 'income')">×</button>
                        <div class="category-icon" style="background: ${cat.color}20; color: ${cat.color};">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="4" fill="currentColor"/></svg>
                        </div>
                        <span class="category-name">${cat.name}</span>
                    </div>
                `;
            });
            
            // Add built-in expense categories
            expenseCategories.forEach(cat => {
                expenseContainer.innerHTML += `
                    <div class="category-item" onclick="selectExpenseCategory('${cat.id}', this)">
                        <div class="category-icon" style="background: ${cat.color}20; color: ${cat.color};">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">${cat.icon}</svg>
                        </div>
                        <span class="category-name">${cat.name}</span>
                    </div>
                `;
            });
            
            // Add custom expense categories with delete button
            customExpenseCategories.forEach(cat => {
                expenseContainer.innerHTML += `
                    <div class="category-item custom-category" onclick="selectExpenseCategory('${cat.id}', this)">
                        <button class="category-delete-btn" onclick="event.stopPropagation(); openDeleteCategoryModal('${cat.id}', 'expense')">×</button>
                        <div class="category-icon" style="background: ${cat.color}20; color: ${cat.color};">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="4" fill="currentColor"/></svg>
                        </div>
                        <span class="category-name">${cat.name}</span>
                    </div>
                `;
            });
        }
        
        function selectCategoryColor(color, el) {
            document.querySelectorAll('.color-option').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            customCategoryColor = color;
        }
        
        function addCustomCategory() {
            const name = document.getElementById('custom-category-name').value.trim();
            if (!name) {
                alert('أدخل اسم التصنيف');
                return;
            }
            
            const newCat = {
                id: 'custom_' + Date.now(),
                name: name,
                color: customCategoryColor
            };
            
            if (customCategoryType === 'income') {
                customIncomeCategories.push(newCat);
                localStorage.setItem('customIncomeCategories', JSON.stringify(customIncomeCategories));
            } else {
                customExpenseCategories.push(newCat);
                localStorage.setItem('customExpenseCategories', JSON.stringify(customExpenseCategories));
            }
            
            // Refresh categories
            initCategories();
            
            // Close modal and reset
            closeModal('custom-category');
            document.getElementById('custom-category-name').value = '';
        }
        
        let deletingCategoryId = null;
        let deletingCategoryType = null;
        
        function openDeleteCategoryModal(catId, catType) {
            deletingCategoryId = catId;
            deletingCategoryType = catType;
            
            // Find the category
            const catList = catType === 'income' ? customIncomeCategories : customExpenseCategories;
            const cat = catList.find(c => c.id === catId);
            if (!cat) return;
            
            // Count transactions in this category
            const transType = catType === 'income' ? 'income' : 'expense';
            const transInCat = transactions.filter(t => t.category === catId && t.type === transType);
            
            const content = document.getElementById('delete-category-content');
            
            if (transInCat.length === 0) {
                // No transactions, can delete directly
                content.innerHTML = `
                    <p style="margin-bottom: 16px; color: var(--text-secondary);">
                        هل تريد حذف تصنيف "<strong>${cat.name}</strong>"؟
                    </p>
                    <p style="margin-bottom: 20px; color: var(--text-muted); font-size: 0.85rem;">
                        لا توجد معاملات في هذا التصنيف.
                    </p>
                    <button class="btn btn-danger" onclick="confirmDeleteCategory()">تأكيد الحذف</button>
                `;
            } else {
                // Has transactions, need to choose replacement
                const builtInCats = catType === 'income' ? incomeCategories : expenseCategories;
                const customCats = (catType === 'income' ? customIncomeCategories : customExpenseCategories).filter(c => c.id !== catId);
                const allCats = [...builtInCats, ...customCats];
                
                const options = allCats.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                
                content.innerHTML = `
                    <p style="margin-bottom: 16px; color: var(--text-secondary);">
                        تصنيف "<strong>${cat.name}</strong>" يحتوي على <strong style="color: var(--accent-red);">${transInCat.length}</strong> معاملة.
                    </p>
                    <div class="form-group">
                        <label class="form-label">انقل المعاملات لتصنيف:</label>
                        <select id="replacement-category" class="form-select">
                            ${options}
                        </select>
                    </div>
                    <button class="btn btn-danger" onclick="confirmDeleteCategory()">نقل المعاملات وحذف التصنيف</button>
                `;
            }
            
            openModal('delete-category');
        }
        
        function confirmDeleteCategory() {
            if (!deletingCategoryId || !deletingCategoryType) return;
            
            const transType = deletingCategoryType === 'income' ? 'income' : 'expense';
            const transInCat = transactions.filter(t => t.category === deletingCategoryId && t.type === transType);
            
            // Move transactions if needed
            if (transInCat.length > 0) {
                const newCatId = document.getElementById('replacement-category').value;
                transactions.forEach(t => {
                    if (t.category === deletingCategoryId && t.type === transType) {
                        t.category = newCatId;
                    }
                });
                localStorage.setItem('transactions', JSON.stringify(transactions));
            }
            
            // Remove the category
            if (deletingCategoryType === 'income') {
                customIncomeCategories = customIncomeCategories.filter(c => c.id !== deletingCategoryId);
                localStorage.setItem('customIncomeCategories', JSON.stringify(customIncomeCategories));
            } else {
                customExpenseCategories = customExpenseCategories.filter(c => c.id !== deletingCategoryId);
                localStorage.setItem('customExpenseCategories', JSON.stringify(customExpenseCategories));
            }
            
            // Refresh
            initCategories();
            updateUI();
            closeModal('delete-category');
            
            deletingCategoryId = null;
            deletingCategoryType = null;
        }
        
        function selectIncomeCategory(id, el) {
            document.querySelectorAll('#income-categories .category-item').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            selectedIncomeCategory = id;
        }
        
        function selectExpenseCategory(id, el) {
            document.querySelectorAll('#expense-categories .category-item').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            selectedExpenseCategory = id;
        }
        
        // Transactions
        function addIncome() {
            const amount = parseFloat(document.getElementById('income-amount').value);
            const note = document.getElementById('income-note').value;
            const time = document.getElementById('income-time').value || null;
            if (!amount || !selectedIncomeCategory) { alert('أدخل المبلغ واختر التصنيف'); return; }
            
            let transDate = new Date();
            if (time) {
                const [hours, minutes] = time.split(':');
                transDate.setHours(parseInt(hours), parseInt(minutes), 0);
            }
            
            transactions.unshift({ id: generateId(), type: 'income', amount, category: selectedIncomeCategory, note, time, date: transDate.toISOString() });
            saveData(); updateUI(); closeModal('income');
            document.getElementById('income-amount').value = '';
            document.getElementById('income-note').value = '';
            document.getElementById('income-time').value = '';
            document.querySelectorAll('#income-categories .category-item').forEach(c => c.classList.remove('active'));
            selectedIncomeCategory = '';
        }
        
        function addExpense() {
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const note = document.getElementById('expense-note').value;
            const time = document.getElementById('expense-time').value || null;
            if (!amount || !selectedExpenseCategory) { alert('أدخل المبلغ واختر التصنيف'); return; }
            
            let transDate = new Date();
            if (time) {
                const [hours, minutes] = time.split(':');
                transDate.setHours(parseInt(hours), parseInt(minutes), 0);
            }
            
            transactions.unshift({ id: generateId(), type: 'expense', amount, category: selectedExpenseCategory, note, time, date: transDate.toISOString() });
            saveData(); updateUI(); closeModal('expense');
            document.getElementById('expense-amount').value = '';
            document.getElementById('expense-note').value = '';
            document.getElementById('expense-time').value = '';
            document.querySelectorAll('#expense-categories .category-item').forEach(c => c.classList.remove('active'));
            selectedExpenseCategory = '';
        }
        
        function deleteTransaction(id) {
            if (confirm('حذف هذه المعاملة؟')) {
                transactions = transactions.filter(t => t.id !== id);
                saveData(); updateUI();
            }
        }
        
        function filterTransactions(type, btn) {
            currentTransactionFilter = type;
            document.querySelectorAll('#page-transactions .toggle-btn').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            renderTransactions();
        }
        
        // Search function
        let searchQuery = '';
        let categoryFilter = 'all';
        
        function searchTransactions() {
            searchQuery = document.getElementById('transaction-search').value.toLowerCase();
            renderTransactions();
        }
        
        function filterByCategory() {
            categoryFilter = document.getElementById('category-filter').value;
            renderTransactions();
        }
        
        function clearAllFilters() {
            document.getElementById('transaction-search').value = '';
            document.getElementById('category-filter').value = 'all';
            searchQuery = '';
            categoryFilter = 'all';
            transFromDate = null;
            transToDate = null;
            document.getElementById('trans-date-from-display').textContent = 'كل الفترات';
            document.getElementById('trans-date-to-display').textContent = 'اليوم';
            renderTransactions();
        }
        
        function populateCategoryFilter() {
            const select = document.getElementById('category-filter');
            if (!select) return;
            
            const allCats = [...expenseCategories, ...incomeCategories, ...ramadanCategories, ...customExpenseCategories, ...customIncomeCategories];
            let options = '<option value="all">كل التصنيفات</option>';
            options += '<optgroup label="المصروفات">';
            [...expenseCategories, ...ramadanCategories, ...customExpenseCategories].forEach(cat => {
                options += `<option value="${cat.id}">${cat.name}</option>`;
            });
            options += '</optgroup>';
            options += '<optgroup label="الدخل">';
            [...incomeCategories, ...customIncomeCategories].forEach(cat => {
                options += `<option value="${cat.id}">${cat.name}</option>`;
            });
            options += '</optgroup>';
            select.innerHTML = options;
        }
        
        // Transaction Date Filter Calendar
        function toggleTransCalendar(type) {
            const popup = document.getElementById('trans-calendar-' + type);
            const overlay = document.getElementById('calendar-overlay');
            const isActive = popup.classList.contains('active');
            
            document.querySelectorAll('.calendar-popup').forEach(p => p.classList.remove('active'));
            
            if (!isActive) {
                activeTransCalendar = type;
                transCalendarCurrentMonth = new Date(type === 'from' && transFromDate ? transFromDate : (type === 'to' && transToDate ? transToDate : new Date()));
                renderTransCalendar(type);
                popup.classList.add('active');
                if (overlay) overlay.classList.add('active');
            } else {
                activeTransCalendar = null;
                if (overlay) overlay.classList.remove('active');
            }
        }
        
        function renderTransCalendar(type) {
            const popup = document.getElementById('trans-calendar-' + type);
            const year = transCalendarCurrentMonth.getFullYear();
            const month = transCalendarCurrentMonth.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            
            const selectedDate = type === 'from' ? transFromDate : transToDate;
            const today = new Date();
            
            let monthOptions = arabicMonths.map((m, i) => 
                `<option value="${i}" ${i === month ? 'selected' : ''}>${m}</option>`
            ).join('');
            
            let yearOptions = '';
            for (let y = year - 5; y <= year + 2; y++) {
                yearOptions += `<option value="${y}" ${y === year ? 'selected' : ''}>${y}</option>`;
            }
            
            let daysHTML = '';
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            for (let i = startDayOfWeek - 1; i >= 0; i--) {
                const day = prevMonthLastDay - i;
                daysHTML += `<button type="button" class="calendar-day other-month" onclick="selectTransCalendarDay(${year}, ${month - 1}, ${day}, '${type}')">${day}</button>`;
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = today.getDate() === day && today.getMonth() === month && today.getFullYear() === year;
                const isSelected = selectedDate && selectedDate.getDate() === day && selectedDate.getMonth() === month && selectedDate.getFullYear() === year;
                let classes = 'calendar-day';
                if (isToday) classes += ' today';
                if (isSelected) classes += ' selected';
                daysHTML += `<button type="button" class="${classes}" onclick="selectTransCalendarDay(${year}, ${month}, ${day}, '${type}')">${day}</button>`;
            }
            
            const totalCells = startDayOfWeek + daysInMonth;
            const remainingDays = totalCells <= 35 ? 35 - totalCells : 42 - totalCells;
            for (let day = 1; day <= remainingDays; day++) {
                daysHTML += `<button type="button" class="calendar-day other-month" onclick="selectTransCalendarDay(${year}, ${month + 1}, ${day}, '${type}')">${day}</button>`;
            }
            
            popup.innerHTML = `
                <div class="calendar-header">
                    <button type="button" class="calendar-nav" data-action="prev" data-type="${type}" data-calendar="trans">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                    <div class="calendar-selects">
                        <select class="calendar-select" onchange="changeTransCalendarMonthDirect(this.value, '${type}')">${monthOptions}</select>
                        <select class="calendar-select" onchange="changeTransCalendarYearDirect(this.value, '${type}')">${yearOptions}</select>
                    </div>
                    <button type="button" class="calendar-nav" data-action="next" data-type="${type}" data-calendar="trans">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                </div>
                <div class="calendar-weekdays">
                    <span class="calendar-weekday">أحد</span>
                    <span class="calendar-weekday">إثن</span>
                    <span class="calendar-weekday">ثلا</span>
                    <span class="calendar-weekday">أرب</span>
                    <span class="calendar-weekday">خمي</span>
                    <span class="calendar-weekday">جمع</span>
                    <span class="calendar-weekday">سبت</span>
                </div>
                <div class="calendar-days">${daysHTML}</div>
            `;
            
            // Add event listeners for nav buttons
            popup.querySelectorAll('.calendar-nav').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const action = this.dataset.action;
                    const calType = this.dataset.type;
                    if (action === 'prev') {
                        changeTransCalendarMonth(-1, calType);
                    } else if (action === 'next') {
                        changeTransCalendarMonth(1, calType);
                    }
                });
            });
        }
        
        function changeTransCalendarMonth(delta, type) {
            transCalendarCurrentMonth.setMonth(transCalendarCurrentMonth.getMonth() + delta);
            renderTransCalendar(type);
        }
        
        function changeTransCalendarMonthDirect(month, type) {
            transCalendarCurrentMonth.setMonth(parseInt(month));
            renderTransCalendar(type);
        }
        
        function changeTransCalendarYearDirect(year, type) {
            transCalendarCurrentMonth.setFullYear(parseInt(year));
            renderTransCalendar(type);
        }
        
        function selectTransCalendarDay(year, month, day, type) {
            const newDate = new Date(year, month, day);
            if (type === 'from') {
                transFromDate = newDate;
                document.getElementById('trans-date-from-display').textContent = formatDateArabic(newDate);
            } else {
                transToDate = newDate;
                document.getElementById('trans-date-to-display').textContent = formatDateArabic(newDate);
            }
            document.getElementById('trans-calendar-' + type).classList.remove('active');
            activeTransCalendar = null;
            renderTransactions();
        }
        
        function clearTransDateFilter() {
            transFromDate = null;
            transToDate = null;
            document.getElementById('trans-date-from-display').textContent = 'كل الفترات';
            document.getElementById('trans-date-to-display').textContent = 'اليوم';
            renderTransactions();
        }
        
        // Debts
        function setDebtType(type) {
            currentDebtType = type;
            document.getElementById('debt-type-to').className = 'toggle-btn' + (type === 'to_me' ? ' active green' : '');
            document.getElementById('debt-type-from').className = 'toggle-btn' + (type === 'from_me' ? ' active red' : '');
        }
        
        function addDebt() {
            const person = document.getElementById('debt-person').value;
            const amount = parseFloat(document.getElementById('debt-amount').value);
            const currency = document.getElementById('debt-currency').value;
            const note = document.getElementById('debt-note').value;
            if (!person || !amount) { alert('أدخل الاسم والمبلغ'); return; }
            debts.unshift({ id: generateId(), type: currentDebtType, person, amount, remaining: amount, currency, note, date: new Date().toISOString() });
            saveData(); updateUI(); closeModal('debt');
            document.getElementById('debt-person').value = '';
            document.getElementById('debt-amount').value = '';
            document.getElementById('debt-currency').value = 'SAR';
            document.getElementById('debt-note').value = '';
        }
        
        function filterDebts(type) {
            currentDebtFilter = type;
            document.getElementById('tab-to-me').className = 'toggle-btn' + (type === 'to_me' ? ' active' : '');
            document.getElementById('tab-from-me').className = 'toggle-btn' + (type === 'from_me' ? ' active' : '');
            renderDebts();
        }
        
        function openPayModal(debtId) {
            currentPayDebtId = debtId;
            const debt = debts.find(d => d.id === debtId);
            document.getElementById('pay-remaining').innerHTML = formatMoney(debt.remaining);
            document.getElementById('pay-amount').value = debt.remaining;
            openModal('pay');
        }
        
        function setPayFull() { const debt = debts.find(d => d.id === currentPayDebtId); document.getElementById('pay-amount').value = debt.remaining; }
        function setPayHalf() { const debt = debts.find(d => d.id === currentPayDebtId); document.getElementById('pay-amount').value = (debt.remaining / 2).toFixed(2); }
        
        function payDebt() {
            const amount = parseFloat(document.getElementById('pay-amount').value);
            const debt = debts.find(d => d.id === currentPayDebtId);
            if (!amount || amount <= 0 || amount > debt.remaining) { alert('مبلغ غير صحيح'); return; }
            debt.remaining -= amount;
            transactions.unshift({ id: generateId(), type: debt.type === 'to_me' ? 'income' : 'expense', amount, category: 'other', note: debt.type === 'to_me' ? `سداد من ${debt.person}` : `سداد لـ ${debt.person}`, date: new Date().toISOString() });
            saveData(); updateUI(); closeModal('pay');
        }
        
        function deleteDebt(id) { if (confirm('حذف هذا الدين؟')) { debts = debts.filter(d => d.id !== id); saveData(); updateUI(); } }
        
        // Installments
        function addInstallment() {
            const name = document.getElementById('installment-name').value;
            const category = document.getElementById('installment-category').value;
            const currency = document.getElementById('installment-currency').value;
            const total = parseFloat(document.getElementById('installment-total').value);
            const amount = parseFloat(document.getElementById('installment-amount').value);
            const remaining = parseInt(document.getElementById('installment-remaining').value);
            const hasDay = document.getElementById('installment-has-day').checked;
            const day = hasDay ? parseInt(document.getElementById('installment-day').value) : null;
            const note = document.getElementById('installment-note').value;
            
            if (!name || !total || !amount || !remaining) { alert('أكمل جميع الحقول المطلوبة'); return; }
            if (hasDay && (!day || day < 1 || day > 28)) { alert('أدخل يوم صحيح (1-28)'); return; }
            
            installments.unshift({
                id: generateId(),
                name,
                category,
                currency,
                total,
                amount,
                totalInstallments: remaining,
                remaining,
                day: day,
                note,
                date: new Date().toISOString()
            });
            
            saveData(); updateUI(); closeModal('installment');
            document.getElementById('installment-name').value = '';
            document.getElementById('installment-category').value = 'car';
            document.getElementById('installment-currency').value = 'SAR';
            document.getElementById('installment-total').value = '';
            document.getElementById('installment-amount').value = '';
            document.getElementById('installment-remaining').value = '';
            document.getElementById('installment-has-day').checked = false;
            document.getElementById('installment-day').value = '';
            document.getElementById('installment-day').disabled = true;
            document.getElementById('installment-note').value = '';
        }
        
        function calculateInstallmentMonths() {
            const total = parseFloat(document.getElementById('installment-total').value) || 0;
            const amount = parseFloat(document.getElementById('installment-amount').value) || 0;
            if (total > 0 && amount > 0) {
                document.getElementById('installment-remaining').value = Math.ceil(total / amount);
            }
        }
        
        function toggleInstallmentDay() {
            const checkbox = document.getElementById('installment-has-day');
            const dayInput = document.getElementById('installment-day');
            dayInput.disabled = !checkbox.checked;
            if (!checkbox.checked) dayInput.value = '';
        }
        
        function filterDebtsPage(type) {
            currentDebtsPageFilter = type;
            document.getElementById('tab-debts-to-me').className = 'toggle-btn' + (type === 'debts_to_me' ? ' active' : '');
            document.getElementById('tab-debts-from-me').className = 'toggle-btn' + (type === 'debts_from_me' ? ' active' : '');
            document.getElementById('tab-installments').className = 'toggle-btn' + (type === 'installments' ? ' active' : '');
            renderDebts();
        }
        
        function openPayInstallmentModal(installmentId) {
            currentPayInstallmentId = installmentId;
            const inst = installments.find(i => i.id === installmentId);
            document.getElementById('pay-installment-value').innerHTML = formatMoney(inst.amount);
            document.getElementById('pay-installment-remaining').textContent = inst.remaining + ' قسط';
            openModal('pay-installment');
        }
        
        function payInstallment(count) {
            const inst = installments.find(i => i.id === currentPayInstallmentId);
            if (!inst || count > inst.remaining) { alert('عدد غير صحيح'); return; }
            
            inst.remaining -= count;
            const totalPaid = inst.amount * count;
            
            // Add as expense transaction
            transactions.unshift({
                id: generateId(),
                type: 'expense',
                amount: totalPaid,
                category: 'bills',
                note: `سداد ${count > 1 ? count + ' أقساط' : 'قسط'} - ${inst.name}`,
                date: new Date().toISOString()
            });
            
            saveData(); updateUI(); closeModal('pay-installment');
        }
        
        function payInstallmentCustom() {
            const count = prompt('كم قسط تريد سداده؟');
            if (count && !isNaN(count) && parseInt(count) > 0) {
                payInstallment(parseInt(count));
            }
        }
        
        function deleteInstallment(id) {
            if (confirm('حذف هذا القسط؟')) {
                installments = installments.filter(i => i.id !== id);
                saveData(); updateUI();
            }
        }
        
        // Gold
        function setGoldType(type) {
            currentGoldType = type;
            document.querySelectorAll('#modal-gold .toggle-btn').forEach(b => { b.className = 'toggle-btn'; b.style = ''; });
            const btn = document.getElementById('gold-type-' + type);
            btn.className = 'toggle-btn active';
            btn.style.background = 'var(--accent-gold)';
            btn.style.color = '#000';
            document.getElementById('gold-purchase-price').value = settings.goldPrices[type];
            updateGoldPreview();
        }
        
        function updateGoldPreview() {
            const weight = parseFloat(document.getElementById('gold-weight').value) || 0;
            const price = parseFloat(document.getElementById('gold-purchase-price').value) || 0;
            if (weight > 0 && price > 0) {
                document.getElementById('gold-preview').style.display = 'block';
                document.getElementById('gold-total-preview').innerHTML = formatMoney(weight * price);
            } else {
                document.getElementById('gold-preview').style.display = 'none';
            }
        }
        
        function addGold() {
            const weight = parseFloat(document.getElementById('gold-weight').value);
            const price = parseFloat(document.getElementById('gold-purchase-price').value);
            if (!weight || !price) { alert('أدخل الوزن والسعر'); return; }
            goldHoldings.unshift({ id: generateId(), type: currentGoldType, weight, purchasePrice: price, date: new Date().toISOString() });
            transactions.unshift({ id: generateId(), type: 'expense', amount: weight * price, category: 'other', note: `شراء ذهب عيار ${currentGoldType}`, date: new Date().toISOString() });
            saveData(); updateUI(); closeModal('gold');
            document.getElementById('gold-weight').value = '';
            document.getElementById('gold-preview').style.display = 'none';
        }
        
        function sellGold(id) {
            if (!confirm('بيع هذا الذهب؟')) return;
            const gold = goldHoldings.find(g => g.id === id);
            const saleValue = gold.weight * settings.goldPrices[gold.type];
            transactions.unshift({ id: generateId(), type: 'income', amount: saleValue, category: 'invest', note: `بيع ذهب عيار ${gold.type}`, date: new Date().toISOString() });
            goldHoldings = goldHoldings.filter(g => g.id !== id);
            saveData(); updateUI();
        }
        
        function addSadaqa() {
            const amount = parseFloat(document.getElementById('sadaqa-amount').value);
            const note = document.getElementById('sadaqa-note').value || 'صدقة';
            if (!amount) { alert('أدخل المبلغ'); return; }
            transactions.unshift({ id: generateId(), type: 'expense', amount, category: 'sadaqa', note, date: new Date().toISOString() });
            saveData(); updateUI(); closeModal('sadaqa');
            document.getElementById('sadaqa-amount').value = '';
            document.getElementById('sadaqa-note').value = '';
        }
        
        // Recurring Transactions
        let currentRecurringType = 'income';
        
        function setRecurringType(type) {
            currentRecurringType = type;
            document.getElementById('recurring-type-income').classList.toggle('active', type === 'income');
            document.getElementById('recurring-type-expense').classList.toggle('active', type === 'expense');
            populateRecurringCategories();
        }
        
        function populateRecurringCategories() {
            const select = document.getElementById('recurring-category');
            const cats = currentRecurringType === 'income' ? [...incomeCategories, ...customIncomeCategories] : [...expenseCategories, ...ramadanCategories, ...customExpenseCategories];
            select.innerHTML = cats.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }
        
        function addRecurring() {
            const name = document.getElementById('recurring-name').value;
            const amount = parseFloat(document.getElementById('recurring-amount').value);
            const category = document.getElementById('recurring-category').value;
            const day = parseInt(document.getElementById('recurring-day').value) || 1;
            
            if (!name || !amount) { alert('أدخل الاسم والمبلغ'); return; }
            
            recurringTransactions.push({
                id: generateId(),
                name,
                type: currentRecurringType,
                amount,
                category,
                day: Math.min(Math.max(day, 1), 28),
                lastAdded: null
            });
            
            localStorage.setItem('recurringTransactions', JSON.stringify(recurringTransactions));
            renderRecurringList();
            closeModal('recurring');
            document.getElementById('recurring-name').value = '';
            document.getElementById('recurring-amount').value = '';
            showToast(' تم إضافة المعاملة المتكررة');
        }
        
        function deleteRecurring(id) {
            recurringTransactions = recurringTransactions.filter(r => r.id !== id);
            localStorage.setItem('recurringTransactions', JSON.stringify(recurringTransactions));
            renderRecurringList();
            showToast(' تم الحذف');
        }
        
        function renderRecurringList() {
            const container = document.getElementById('recurring-list');
            if (!container) return;
            
            if (recurringTransactions.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 16px;">لا توجد معاملات متكررة</p>';
                return;
            }
            
            const curr = currencyData[settings.currency];
            
            container.innerHTML = recurringTransactions.map(r => `
                <div class="list-item-card">
                    <div class="list-item-icon" style="background: ${r.type === 'income' ? 'rgba(16, 185, 129, 0.15)' : 'rgba(239, 68, 68, 0.15)'}; color: ${r.type === 'income' ? 'var(--accent-green)' : 'var(--accent-red)'};">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    </div>
                    <div class="list-item-info">
                        <h4>${r.name}</h4>
                        <p>يوم ${r.day} من كل شهر</p>
                    </div>
                    <div class="list-item-amount-box ${r.type}">
                        <span class="amount-main">${curr.symbol} ${formatMoneyPlain(r.amount)}</span>
                        ${settings.currency !== 'EGP' ? `<span class="amount-sub">${formatEGP(r.amount)}</span>` : ''}
                    </div>
                    <div class="action-icon-buttons">
                        <button class="action-icon-btn edit" onclick="editRecurring('${r.id}')" title="تعديل">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        </button>
                        <button class="action-icon-btn delete" onclick="deleteRecurring('${r.id}')" title="حذف">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        let editingRecurringId = null;
        
        function editRecurring(id) {
            const r = recurringTransactions.find(x => x.id === id);
            if (!r) return;
            
            editingRecurringId = id;
            setRecurringType(r.type);
            document.getElementById('recurring-name').value = r.name;
            document.getElementById('recurring-amount').value = r.amount;
            document.getElementById('recurring-day').value = r.day;
            
            // Change modal title and button
            document.querySelector('#modal-recurring .modal-title').textContent = 'تعديل معاملة متكررة';
            document.querySelector('#modal-recurring .btn-primary').textContent = 'حفظ التعديلات';
            document.querySelector('#modal-recurring .btn-primary').onclick = saveRecurringEdit;
            
            openModal('recurring');
            
            // Set category after opening
            setTimeout(() => {
                document.getElementById('recurring-category').value = r.category;
            }, 100);
        }
        
        function saveRecurringEdit() {
            const r = recurringTransactions.find(x => x.id === editingRecurringId);
            if (!r) return;
            
            r.name = document.getElementById('recurring-name').value;
            r.amount = parseFloat(document.getElementById('recurring-amount').value);
            r.category = document.getElementById('recurring-category').value;
            r.day = parseInt(document.getElementById('recurring-day').value) || 1;
            r.type = currentRecurringType;
            
            localStorage.setItem('recurringTransactions', JSON.stringify(recurringTransactions));
            renderRecurringList();
            closeModal('recurring');
            resetRecurringModal();
            showToast('تم حفظ التعديلات');
        }
        
        function resetRecurringModal() {
            editingRecurringId = null;
            document.getElementById('recurring-name').value = '';
            document.getElementById('recurring-amount').value = '';
            document.getElementById('recurring-day').value = '1';
            document.querySelector('#modal-recurring .modal-title').textContent = 'معاملة متكررة';
            document.querySelector('#modal-recurring .btn-primary').textContent = 'إضافة';
            document.querySelector('#modal-recurring .btn-primary').onclick = addRecurring;
        }
        
        function checkRecurringTransactions() {
            const now = new Date();
            const currentDay = now.getDate();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            recurringTransactions.forEach(r => {
                const lastAdded = r.lastAdded ? new Date(r.lastAdded) : null;
                const shouldAdd = !lastAdded || 
                    (lastAdded.getMonth() !== currentMonth || lastAdded.getFullYear() !== currentYear);
                
                if (shouldAdd && currentDay >= r.day) {
                    transactions.unshift({
                        id: generateId(),
                        type: r.type,
                        amount: r.amount,
                        category: r.category,
                        note: r.name + ' (تلقائي)',
                        date: new Date().toISOString()
                    });
                    r.lastAdded = now.toISOString();
                }
            });
            
            localStorage.setItem('recurringTransactions', JSON.stringify(recurringTransactions));
            saveData();
        }
        
        // Subscriptions
        function addSubscription() {
            const name = document.getElementById('subscription-name').value;
            const amount = parseFloat(document.getElementById('subscription-amount').value);
            const day = parseInt(document.getElementById('subscription-day').value) || 1;
            
            if (!name || !amount) { alert('أدخل اسم الخدمة والمبلغ'); return; }
            
            subscriptions.push({
                id: generateId(),
                name,
                amount,
                day: Math.min(Math.max(day, 1), 28),
                active: true
            });
            
            localStorage.setItem('subscriptions', JSON.stringify(subscriptions));
            renderSubscriptionsList();
            closeModal('subscription');
            document.getElementById('subscription-name').value = '';
            document.getElementById('subscription-amount').value = '';
            showToast(' تم إضافة الاشتراك');
        }
        
        function deleteSubscription(id) {
            subscriptions = subscriptions.filter(s => s.id !== id);
            localStorage.setItem('subscriptions', JSON.stringify(subscriptions));
            renderSubscriptionsList();
            showToast(' تم الحذف');
        }
        
        function renderSubscriptionsList() {
            const container = document.getElementById('subscriptions-list');
            if (!container) return;
            
            if (subscriptions.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 16px;">لا توجد اشتراكات</p>';
                return;
            }
            
            const totalMonthly = subscriptions.reduce((acc, s) => acc + s.amount, 0);
            const curr = currencyData[settings.currency];
            
            container.innerHTML = `
                <div style="background: var(--bg-hover); padding: 10px; border-radius: var(--radius-md); margin-bottom: 12px; text-align: center;">
                    <span style="color: var(--text-muted); font-size: 0.8rem;">إجمالي الاشتراكات الشهرية: </span>
                    <span style="color: var(--accent-red); font-weight: 800;">${curr.symbol} ${formatMoneyPlain(totalMonthly)}</span>
                    ${settings.currency !== 'EGP' ? `<span style="color: var(--text-muted); font-size: 0.7rem; margin-right: 4px;">(${formatEGP(totalMonthly)})</span>` : ''}
                </div>
                ${subscriptions.map(s => `
                    <div class="list-item-card">
                        <div class="list-item-icon" style="background: rgba(139, 92, 246, 0.15); color: var(--accent-purple);">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        </div>
                        <div class="list-item-info">
                            <h4>${s.name}</h4>
                            <p>يوم ${s.day} من كل شهر</p>
                        </div>
                        <div class="list-item-amount-box expense">
                            <span class="amount-main">${curr.symbol} ${formatMoneyPlain(s.amount)}</span>
                            ${settings.currency !== 'EGP' ? `<span class="amount-sub">${formatEGP(s.amount)}</span>` : ''}
                        </div>
                        <div class="action-icon-buttons">
                            <button class="action-icon-btn edit" onclick="editSubscription('${s.id}')" title="تعديل">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            </button>
                            <button class="action-icon-btn delete" onclick="deleteSubscription('${s.id}')" title="حذف">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>
                `).join('')}
            `;
        }
        
        // Edit Subscription
        let editingSubscriptionId = null;
        
        function editSubscription(id) {
            const s = subscriptions.find(x => x.id === id);
            if (!s) return;
            
            editingSubscriptionId = id;
            document.getElementById('subscription-name').value = s.name;
            document.getElementById('subscription-amount').value = s.amount;
            document.getElementById('subscription-day').value = s.day;
            
            document.querySelector('#modal-subscription .modal-title').textContent = 'تعديل اشتراك';
            document.querySelector('#modal-subscription .btn-primary').textContent = 'حفظ التعديلات';
            document.querySelector('#modal-subscription .btn-primary').onclick = saveSubscriptionEdit;
            
            openModal('subscription');
        }
        
        function saveSubscriptionEdit() {
            const s = subscriptions.find(x => x.id === editingSubscriptionId);
            if (!s) return;
            
            s.name = document.getElementById('subscription-name').value;
            s.amount = parseFloat(document.getElementById('subscription-amount').value);
            s.day = parseInt(document.getElementById('subscription-day').value) || 1;
            
            localStorage.setItem('subscriptions', JSON.stringify(subscriptions));
            renderSubscriptionsList();
            closeModal('subscription');
            resetSubscriptionModal();
            showToast('تم حفظ التعديلات');
        }
        
        function resetSubscriptionModal() {
            editingSubscriptionId = null;
            document.getElementById('subscription-name').value = '';
            document.getElementById('subscription-amount').value = '';
            document.getElementById('subscription-day').value = '1';
            document.querySelector('#modal-subscription .modal-title').textContent = 'إضافة اشتراك';
            document.querySelector('#modal-subscription .btn-primary').textContent = 'إضافة';
            document.querySelector('#modal-subscription .btn-primary').onclick = addSubscription;
        }
        
        // Savings Challenges
        function addChallenge() {
            const name = document.getElementById('challenge-name').value;
            const target = parseFloat(document.getElementById('challenge-target').value);
            const days = parseInt(document.getElementById('challenge-days').value) || 7;
            
            if (!name || !target) { alert('أدخل اسم التحدي والمبلغ المستهدف'); return; }
            
            const startDate = new Date();
            const endDate = new Date();
            endDate.setDate(endDate.getDate() + days);
            
            challenges.push({
                id: generateId(),
                name,
                target,
                startDate: startDate.toISOString(),
                endDate: endDate.toISOString(),
                startBalance: getBalance(),
                completed: false
            });
            
            localStorage.setItem('challenges', JSON.stringify(challenges));
            renderChallengesList();
            closeModal('challenge');
            document.getElementById('challenge-name').value = '';
            document.getElementById('challenge-target').value = '';
            showToast(' التحدي بدأ! حظاً موفقاً');
        }
        
        function getBalance() {
            return transactions.reduce((acc, t) => t.type === 'income' ? acc + t.amount : acc - t.amount, 0);
        }
        
        function deleteChallenge(id) {
            challenges = challenges.filter(c => c.id !== id);
            localStorage.setItem('challenges', JSON.stringify(challenges));
            renderChallengesList();
        }
        
        function renderChallengesList() {
            const container = document.getElementById('challenges-list');
            const homeContainer = document.getElementById('home-challenges');
            
            // Remove expired challenges
            const now = new Date();
            challenges = challenges.filter(c => {
                const endDate = new Date(c.endDate);
                return endDate >= now;
            });
            localStorage.setItem('challenges', JSON.stringify(challenges));
            
            if (challenges.length === 0) {
                if (container) container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 16px;">لا توجد تحديات نشطة</p>';
                if (homeContainer) homeContainer.style.display = 'none';
                return;
            }
            
            const curr = currencyData[settings.currency];
            
            const challengeHTML = challenges.map(c => {
                const currentBalance = getBalance();
                const saved = currentBalance - c.startBalance;
                const progress = Math.min(100, Math.max(0, (saved / c.target) * 100));
                const endDate = new Date(c.endDate);
                const daysLeft = Math.max(0, Math.ceil((endDate - now) / (1000 * 60 * 60 * 24)));
                const isCompleted = saved >= c.target;
                
                return `
                    <div class="list-item-card" style="flex-direction: column; align-items: stretch;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <div class="list-item-icon" style="background: ${isCompleted ? 'rgba(16, 185, 129, 0.15)' : 'rgba(245, 158, 11, 0.15)'}; color: ${isCompleted ? 'var(--accent-green)' : 'var(--accent-gold)'};">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </div>
                            <div class="list-item-info">
                                <h4>${c.name}</h4>
                                <p>متبقي ${daysLeft} يوم</p>
                            </div>
                            <button class="icon-btn small danger" onclick="deleteChallenge('${c.id}')" title="حذف">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                        <div class="progress-bar" style="height: 6px; margin-bottom: 6px;">
                            <div class="progress-fill" style="width: ${progress}%; background: ${isCompleted ? 'var(--accent-green)' : 'var(--accent-gold)'};"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.75rem;">
                            <span style="color: ${saved >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">
                                وفرت: ${curr.symbol} ${formatMoneyPlain(saved)}
                                ${settings.currency !== 'EGP' ? `<span style="color: var(--text-muted); font-size: 0.65rem;">(${formatEGP(saved)})</span>` : ''}
                            </span>
                            <span style="color: var(--text-muted);">
                                الهدف: ${curr.symbol} ${formatMoneyPlain(c.target)}
                                ${settings.currency !== 'EGP' ? `<span style="font-size: 0.65rem;">(${formatEGP(c.target)})</span>` : ''}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
            
            if (container) container.innerHTML = challengeHTML;
            if (homeContainer) {
                homeContainer.style.display = 'block';
                homeContainer.querySelector('.challenges-content').innerHTML = challengeHTML;
            }
        }
        
        // Smart Alerts
        // Ramadan Functions
        let currentRamadanCategory = 'iftar';
        
        function addRamadanExpense(category) {
            currentRamadanCategory = category;
            const cat = ramadanCategories.find(c => c.id === category);
            document.getElementById('ramadan-modal-title').textContent = cat ? cat.name : 'مصروف رمضان';
            document.getElementById('ramadan-modal-icon').innerHTML = cat ? `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24">${cat.icon}</svg>` : '';
            document.getElementById('ramadan-amount').value = '';
            document.getElementById('ramadan-note').value = '';
            openModal('ramadan');
        }
        
        function saveRamadanExpense() {
            const amount = parseFloat(document.getElementById('ramadan-amount').value);
            const note = document.getElementById('ramadan-note').value;
            
            if (!amount) { alert('أدخل المبلغ'); return; }
            
            const cat = ramadanCategories.find(c => c.id === currentRamadanCategory);
            
            transactions.unshift({
                id: generateId(),
                type: 'expense',
                amount: amount,
                category: currentRamadanCategory,
                note: note || cat.name,
                date: new Date().toISOString(),
                isRamadan: true
            });
            
            saveData();
            updateUI();
            closeModal('ramadan');
            showToast('تم حفظ مصروف رمضان');
        }
        
        function updateRamadanSummary() {
            const container = document.getElementById('ramadan-summary');
            if (!container) return;
            
            const ramadanTransactions = transactions.filter(t => 
                ramadanCategories.some(rc => rc.id === t.category)
            );
            
            if (ramadanTransactions.length === 0) {
                container.innerHTML = '<p class="ramadan-summary-empty">لم تسجل أي مصروفات رمضانية بعد</p>';
                return;
            }
            
            const totals = {};
            ramadanTransactions.forEach(t => {
                totals[t.category] = (totals[t.category] || 0) + t.amount;
            });
            
            const grandTotal = Object.values(totals).reduce((a, b) => a + b, 0);
            const curr = currencyData[settings.currency];
            const currSymbol = curr.useSVG ? '<svg class="sar-symbol-inline" style="width:12px;height:12px;"><use href="#sar-icon"></use></svg>' : curr.symbol;
            
            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color);">
                    <span style="font-weight: 700; color: #fbbf24;">إجمالي مصروفات رمضان</span>
                    <span style="font-weight: 800; color: var(--text-primary);" class="money-display">${currSymbol} ${formatMoneyPlain(grandTotal)}</span>
                </div>
                ${Object.entries(totals).map(([catId, amount]) => {
                    const cat = ramadanCategories.find(c => c.id === catId);
                    return `
                        <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 0.8rem;">
                            <span style="color: var(--text-muted);">${cat ? cat.name : catId}</span>
                            <span style="color: var(--text-secondary);" class="money-display">${currSymbol} ${formatMoneyPlain(amount)}</span>
                        </div>
                    `;
                }).join('')}
            `;
        }
        
        // Smart Alerts
        function checkSmartAlerts() {
            const now = new Date();
            const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            
            // Get this month's expenses by category
            const monthExpenses = transactions.filter(t => {
                const d = new Date(t.date);
                return t.type === 'expense' && d >= thisMonthStart && d <= now;
            });
            
            const categoryTotals = monthExpenses.reduce((acc, t) => {
                acc[t.category] = (acc[t.category] || 0) + t.amount;
                return acc;
            }, {});
            
            // Get last month's expenses by category for comparison
            const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
            
            const lastMonthExpenses = transactions.filter(t => {
                const d = new Date(t.date);
                return t.type === 'expense' && d >= lastMonthStart && d <= lastMonthEnd;
            });
            
            const lastMonthTotals = lastMonthExpenses.reduce((acc, t) => {
                acc[t.category] = (acc[t.category] || 0) + t.amount;
                return acc;
            }, {});
            
            // Check for unusual spending
            const alerts = [];
            Object.entries(categoryTotals).forEach(([cat, amount]) => {
                const lastMonth = lastMonthTotals[cat] || 0;
                if (lastMonth > 0 && amount > lastMonth * 1.5) {
                    const allCats = [...expenseCategories, ...ramadanCategories, ...customExpenseCategories];
                    const catInfo = allCats.find(c => c.id === cat) || { name: cat };
                    alerts.push(`تنبيه: صرفت على ${catInfo.name} أكثر من الشهر الماضي بـ ${Math.round((amount/lastMonth - 1) * 100)}%`);
                }
            });
            
            return alerts;
        }
        
        // Settings
        function setCurrency(curr) {
            settings.currency = curr;
            saveData(); 
            updateUI(); 
            updateCurrencyLabels();
            updateCurrencyToggleUI();
        }
        
        function updateCurrencyToggleUI() {
            const sarBtn = document.getElementById('currency-btn-SAR');
            const egpBtn = document.getElementById('currency-btn-EGP');
            if (sarBtn && egpBtn) {
                sarBtn.classList.toggle('active', settings.currency === 'SAR');
                egpBtn.classList.toggle('active', settings.currency === 'EGP');
            }
        }
        
        function changeCurrency() {
            // Fallback for old select (if exists)
            const select = document.getElementById('currency-select');
            if (select) {
                settings.currency = select.value;
                saveData(); updateUI(); updateCurrencyLabels();
            }
        }
        
        function updateCurrencyLabels() {
            const curr = currencyData[settings.currency];
            // Modal currency labels
            ['income', 'expense'].forEach(type => {
                const label = document.getElementById(type + '-currency-label');
                if (curr.useSVG) {
                    label.innerHTML = '<svg class="sar-symbol" style="width:16px;height:16px;"><use href="#sar-icon"></use></svg> ' + curr.name;
                } else {
                    label.textContent = curr.symbol + ' ' + curr.name;
                }
            });
            // Converter labels
            document.getElementById('conv-from-currency').textContent = curr.name;
            document.getElementById('conv-currency-name').textContent = curr.name;
            document.getElementById('exchange-rate-label').textContent = `1 ${curr.name} = كام جنيه؟`;
        }
        
        function saveSettings() {
            settings.exchangeRate = parseFloat(document.getElementById('exchange-rate').value) || 13.2;
            settings.monthlyBudget = parseFloat(document.getElementById('budget-input').value) || 5000;
            settings.budgetAlert = parseFloat(document.getElementById('budget-alert-input').value) || 4000;
            saveData(); updateUI();
        }
        
        function saveGoldPrices() {
            settings.goldPrices = {
                '24': parseFloat(document.getElementById('gold-price-24-input').value) || 295,
                '21': parseFloat(document.getElementById('gold-price-21-input').value) || 258,
                '18': parseFloat(document.getElementById('gold-price-18-input').value) || 221
            };
            saveData(); updateUI();
        }
        
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast' + (isError ? ' error' : '');
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        function confirmReset() {
            console.log('confirmReset called');
            const resetTrans = document.getElementById('reset-transactions').checked;
            const resetDebts = document.getElementById('reset-debts').checked;
            const resetGold = document.getElementById('reset-gold').checked;
            const resetGoals = document.getElementById('reset-goals').checked;
            const resetSettings = document.getElementById('reset-settings').checked;
            
            console.log('Checkboxes:', {resetTrans, resetDebts, resetGold, resetGoals, resetSettings});
            
            if (!resetTrans && !resetDebts && !resetGold && !resetGoals && !resetSettings) {
                showToast('اختر عنصر واحد على الأقل للحذف', true);
                return;
            }
            
            let items = [];
            if (resetTrans) items.push('المعاملات');
            if (resetDebts) items.push('الديون');
            if (resetGold) items.push('محفظة الذهب');
            if (resetGoals) items.push('الأهداف');
            if (resetSettings) items.push('الإعدادات');
            
            // Delete directly without confirm dialog
            if (resetTrans) {
                transactions = [];
                localStorage.setItem('transactions', JSON.stringify([]));
                // Reset appInitialized to show welcome screen again
                localStorage.removeItem('appInitialized');
            }
            if (resetDebts) {
                debts = [];
                localStorage.setItem('debts', JSON.stringify([]));
            }
            if (resetGold) {
                goldHoldings = [];
                localStorage.setItem('goldHoldings', JSON.stringify([]));
            }
            if (resetGoals) {
                goals = [];
                localStorage.setItem('goals', JSON.stringify([]));
            }
            if (resetSettings) {
                settings = {
                    currency: 'SAR',
                    exchangeRate: 13.2,
                    monthlyBudget: 5000,
                    budgetAlert: 4000,
                    goldPrices: { '24': 295, '21': 258, '18': 221 }
                };
                localStorage.setItem('settings', JSON.stringify(settings));
            }
            
            // Close modal
            closeModal('reset');
            
            // Uncheck all
            document.getElementById('reset-transactions').checked = false;
            document.getElementById('reset-debts').checked = false;
            document.getElementById('reset-gold').checked = false;
            document.getElementById('reset-goals').checked = false;
            document.getElementById('reset-settings').checked = false;
            
            // Update UI
            updateUI();
            updateSettingsUI();
            
            // Show welcome screen if transactions were reset
            if (resetTrans) {
                document.getElementById('welcome-screen').style.display = 'flex';
            } else {
                // Show toast
                showToast(' تم حذف ' + items.join(' و ') + ' بنجاح');
            }
        }
        
        function exportData() {
            const data = { transactions, debts, goldHoldings, settings };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'wallet-backup.json'; a.click();
        }
        
        // Converter
        function updateConverterModal() {
            document.getElementById('conv-rate').textContent = settings.exchangeRate;
            const balance = transactions.reduce((acc, t) => t.type === 'income' ? acc + t.amount : acc - t.amount, 0);
            document.getElementById('balance-in-egp').textContent = formatEGP(balance);
        }
        
        function convertCurrency() {
            const amount = parseFloat(document.getElementById('converter-amount').value) || 0;
            const egp = amount * settings.exchangeRate;
            document.getElementById('converted-amount').textContent = new Intl.NumberFormat('en-US', { minimumFractionDigits: 2 }).format(egp) + ' ج.م';
        }
        
        // Reports - Custom Calendar
        let reportFromDate = new Date();
        let reportToDate = new Date();
        let reportPeriodType = 'month'; // 'week', 'month', 'year'
        let calendarCurrentMonth = new Date();
        let activeCalendar = null;
        
        const arabicMonths = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
        const arabicDays = ['أحد', 'إثنين', 'ثلاثاء', 'أربعاء', 'خميس', 'جمعة', 'سبت'];
        
        function initReportDates() {
            const now = new Date();
            reportFromDate = new Date(now.getFullYear(), now.getMonth(), 1);
            reportToDate = new Date(now);
            updateDateDisplays();
            updateCustomReport();
        }
        
        function updateDateDisplays() {
            document.getElementById('date-from-display').textContent = formatDateArabic(reportFromDate);
            document.getElementById('date-to-display').textContent = formatDateArabic(reportToDate);
        }
        
        function formatDateArabic(date) {
            return `${date.getDate()} ${arabicMonths[date.getMonth()]} ${date.getFullYear()}`;
        }
        
        function toggleCalendar(type) {
            const popup = document.getElementById('calendar-' + type);
            const overlay = document.getElementById('calendar-overlay');
            const isActive = popup.classList.contains('active');
            
            // Close all calendars
            document.querySelectorAll('.calendar-popup').forEach(p => p.classList.remove('active'));
            
            if (!isActive) {
                activeCalendar = type;
                calendarCurrentMonth = new Date(type === 'from' ? reportFromDate : reportToDate);
                renderCalendar(type);
                popup.classList.add('active');
                if (overlay) overlay.classList.add('active');
            } else {
                activeCalendar = null;
                if (overlay) overlay.classList.remove('active');
            }
        }
        
        function closeAllCalendars() {
            document.querySelectorAll('.calendar-popup').forEach(p => p.classList.remove('active'));
            const overlay = document.getElementById('calendar-overlay');
            if (overlay) overlay.classList.remove('active');
            activeCalendar = null;
        }
        
        function renderCalendar(type) {
            const popup = document.getElementById('calendar-' + type);
            const year = calendarCurrentMonth.getFullYear();
            const month = calendarCurrentMonth.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            
            const selectedDate = type === 'from' ? reportFromDate : reportToDate;
            const today = new Date();
            
            // Month options
            let monthOptions = arabicMonths.map((m, i) => 
                `<option value="${i}" ${i === month ? 'selected' : ''}>${m}</option>`
            ).join('');
            
            // Year options (5 years back, 2 years forward)
            let yearOptions = '';
            for (let y = year - 5; y <= year + 2; y++) {
                yearOptions += `<option value="${y}" ${y === year ? 'selected' : ''}>${y}</option>`;
            }
            
            let daysHTML = '';
            
            // Previous month days
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            for (let i = startDayOfWeek - 1; i >= 0; i--) {
                const day = prevMonthLastDay - i;
                daysHTML += `<button class="calendar-day other-month" onclick="selectCalendarDay(${year}, ${month - 1}, ${day}, '${type}')">${day}</button>`;
            }
            
            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = today.getDate() === day && today.getMonth() === month && today.getFullYear() === year;
                const isSelected = selectedDate.getDate() === day && selectedDate.getMonth() === month && selectedDate.getFullYear() === year;
                let classes = 'calendar-day';
                if (isToday) classes += ' today';
                if (isSelected) classes += ' selected';
                daysHTML += `<button class="${classes}" onclick="selectCalendarDay(${year}, ${month}, ${day}, '${type}')">${day}</button>`;
            }
            
            // Next month days (fill to 35 cells max)
            const totalCells = startDayOfWeek + daysInMonth;
            const remainingDays = totalCells <= 35 ? 35 - totalCells : 42 - totalCells;
            for (let day = 1; day <= remainingDays; day++) {
                daysHTML += `<button class="calendar-day other-month" onclick="selectCalendarDay(${year}, ${month + 1}, ${day}, '${type}')">${day}</button>`;
            }
            
            popup.innerHTML = `
                <div class="calendar-header">
                    <button type="button" class="calendar-nav" data-action="prev" data-type="${type}">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                    <div class="calendar-selects">
                        <select class="calendar-select" onchange="changeCalendarMonthDirect(this.value, '${type}')">${monthOptions}</select>
                        <select class="calendar-select" onchange="changeCalendarYearDirect(this.value, '${type}')">${yearOptions}</select>
                    </div>
                    <button type="button" class="calendar-nav" data-action="next" data-type="${type}">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                </div>
                <div class="calendar-weekdays">
                    <span class="calendar-weekday">أحد</span>
                    <span class="calendar-weekday">إثن</span>
                    <span class="calendar-weekday">ثلا</span>
                    <span class="calendar-weekday">أرب</span>
                    <span class="calendar-weekday">خمي</span>
                    <span class="calendar-weekday">جمع</span>
                    <span class="calendar-weekday">سبت</span>
                </div>
                <div class="calendar-days">${daysHTML}</div>
                <div class="calendar-quick-btns">
                    <button type="button" class="calendar-quick-btn" onclick="selectToday('${type}')">اليوم</button>
                    <button type="button" class="calendar-quick-btn" onclick="selectStartOfMonth('${type}')">أول الشهر</button>
                </div>
            `;
            
            // Add event listeners for nav buttons
            popup.querySelectorAll('.calendar-nav').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const action = this.dataset.action;
                    const calType = this.dataset.type;
                    if (action === 'prev') {
                        changeCalendarMonth(-1, calType);
                    } else if (action === 'next') {
                        changeCalendarMonth(1, calType);
                    }
                });
            });
        }
        
        function changeCalendarMonthDirect(month, type) {
            calendarCurrentMonth.setMonth(parseInt(month));
            renderCalendar(type);
        }
        
        function changeCalendarYearDirect(year, type) {
            calendarCurrentMonth.setFullYear(parseInt(year));
            renderCalendar(type);
        }
        
        function changeCalendarMonth(delta, type) {
            calendarCurrentMonth.setMonth(calendarCurrentMonth.getMonth() + delta);
            renderCalendar(type);
        }
        
        function selectCalendarDay(year, month, day, type) {
            const newDate = new Date(year, month, day);
            if (type === 'from') {
                reportFromDate = newDate;
            } else {
                reportToDate = newDate;
            }
            updateDateDisplays();
            closeAllCalendars();
            updateCustomReport();
        }
        
        function selectToday(type) {
            selectCalendarDay(new Date().getFullYear(), new Date().getMonth(), new Date().getDate(), type);
        }
        
        function selectStartOfMonth(type) {
            const now = new Date();
            selectCalendarDay(now.getFullYear(), now.getMonth(), 1, type);
        }
        
        function setQuickRange(period, btn) {
            document.querySelectorAll('.date-range-picker .toggle-btn').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            
            reportPeriodType = period;
            const now = new Date();
            
            if (period === 'week') {
                reportFromDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            } else if (period === 'month') {
                reportFromDate = new Date(now.getFullYear(), now.getMonth(), 1);
            } else {
                reportFromDate = new Date(now.getFullYear(), 0, 1);
            }
            
            reportToDate = new Date(now);
            updateDateDisplays();
            updateCustomReport();
        }
        
        function updateCustomReport() {
            const fromDate = reportFromDate;
            const toDate = new Date(reportToDate);
            toDate.setHours(23, 59, 59);
            
            const filtered = transactions.filter(t => {
                const d = new Date(t.date);
                return d >= fromDate && d <= toDate;
            });
            
            const income = filtered.filter(t => t.type === 'income').reduce((acc, t) => acc + t.amount, 0);
            const expense = filtered.filter(t => t.type === 'expense').reduce((acc, t) => acc + t.amount, 0);
            const net = income - expense;
            
            // Comparison Chart (Income vs Expense)
            const comparisonContainer = document.getElementById('comparison-chart');
            const maxValue = Math.max(income, expense, 1);
            const spendingPercent = income > 0 ? ((expense / income) * 100).toFixed(0) : 0;
            const savingPercent = income > 0 ? (100 - spendingPercent) : 0;
            const curr = currencyData[settings.currency];
            const currSymbol = curr.useSVG ? '<svg class="sar-symbol-inline"><use href="#sar-icon"></use></svg>' : curr.symbol;
            
            comparisonContainer.innerHTML = `
                <div class="comparison-chart">
                    <div class="comparison-bar">
                        <div class="comparison-bar-label">الدخل</div>
                        <div class="comparison-bar-value" style="color: var(--accent-green);"><span class="money-display">${currSymbol} ${formatMoneyPlain(income)}</span></div>
                        <div class="comparison-bar-visual">
                            <div class="comparison-bar-fill" style="width: ${(income / maxValue) * 100}%; background: var(--accent-green);"></div>
                        </div>
                    </div>
                    <div class="comparison-bar">
                        <div class="comparison-bar-label">المصروفات</div>
                        <div class="comparison-bar-value" style="color: var(--accent-red);"><span class="money-display">${currSymbol} ${formatMoneyPlain(expense)}</span> <small style="color: var(--text-muted); font-weight: 500;">(${spendingPercent}%)</small></div>
                        <div class="comparison-bar-visual">
                            <div class="comparison-bar-fill" style="width: ${(expense / maxValue) * 100}%; background: var(--accent-red);"></div>
                        </div>
                    </div>
                </div>
                <div class="comparison-summary">
                    <div class="comparison-stat">
                        <span class="comparison-stat-label">نسبة الصرف</span>
                        <span class="comparison-stat-value" style="color: ${spendingPercent > 80 ? 'var(--accent-red)' : spendingPercent > 60 ? 'var(--accent-gold)' : 'var(--accent-green)'};">${spendingPercent}%</span>
                    </div>
                    <div class="comparison-stat">
                        <span class="comparison-stat-label">نسبة التوفير</span>
                        <span class="comparison-stat-value" style="color: ${savingPercent < 20 ? 'var(--accent-red)' : savingPercent < 40 ? 'var(--accent-gold)' : 'var(--accent-green)'};">${savingPercent}%</span>
                    </div>
                    <div class="comparison-stat">
                        <span class="comparison-stat-label">الصافي</span>
                        <span class="comparison-stat-value" style="color: ${net >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">${net >= 0 ? '+' : ''}<span class="money-display">${currSymbol} ${formatMoneyPlain(net)}</span></span>
                    </div>
                </div>
            `;
            
            // Group expenses by category
            const expenses = filtered.filter(t => t.type === 'expense');
            const grouped = expenses.reduce((acc, t) => { acc[t.category] = (acc[t.category] || 0) + t.amount; return acc; }, {});
            const allExpenseCats = [...expenseCategories, ...ramadanCategories, ...customExpenseCategories];
            const chartData = Object.entries(grouped).map(([category, amount]) => {
                const cat = allExpenseCats.find(c => c.id === category) || { name: 'أخرى', color: '#6b7280' };
                // Calculate percent of INCOME not expense
                const percentOfIncome = income > 0 ? (amount / income * 100).toFixed(1) : 0;
                return { id: category, name: cat.name, amount, color: cat.color, percent: percentOfIncome };
            }).sort((a, b) => b.amount - a.amount);
            
            // Pie Chart
            const pieContainer = document.getElementById('pie-chart');
            const detailsContainer = document.getElementById('expense-details-list');
            
            if (chartData.length === 0) {
                pieContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">لا توجد مصروفات</div>';
                if (detailsContainer) detailsContainer.innerHTML = '';
                return;
            }
            
            // Create conic gradient for pie chart
            let gradientParts = [];
            let currentAngle = 0;
            chartData.forEach(d => {
                const angle = (d.amount / expense) * 360;
                gradientParts.push(`${d.color} ${currentAngle}deg ${currentAngle + angle}deg`);
                currentAngle += angle;
            });
            
            // Pie chart only (no legend)
            pieContainer.innerHTML = `
                <div class="pie-chart-simple">
                    <div class="pie-chart-donut" style="background: conic-gradient(${gradientParts.join(', ')});">
                        <div class="pie-chart-donut-center">
                            <span class="donut-total">${curr.useSVG ? '<svg class="sar-symbol-inline"><use href="#sar-icon"></use></svg>' : curr.symbol} ${formatMoneyPlain(expense)}</span>
                        </div>
                    </div>
                </div>
            `;
            
            // Details list (categories + amounts + percentages)
            if (detailsContainer) {
                detailsContainer.innerHTML = chartData.map(d => `
                    <div class="expense-detail-item">
                        <div class="expense-detail-color" style="background: ${d.color};"></div>
                        <div class="expense-detail-name">${d.name}</div>
                        <div class="expense-detail-amount">${curr.useSVG ? '<svg class="sar-symbol-inline" style="width:10px;height:10px;"><use href="#sar-icon"></use></svg>' : curr.symbol} ${formatMoneyPlain(d.amount)}</div>
                        <div class="expense-detail-percent">${d.percent}%</div>
                    </div>
                `).join('');
            }
            
            // Update Top Expense Category
            const topExpenseNameEl = document.getElementById('top-expense-name');
            const topExpenseAmountEl = document.getElementById('top-expense-amount');
            const topExpensePercentLabelEl = document.getElementById('top-expense-percent-label');
            const topExpenseIconEl = document.getElementById('top-expense-icon');
            
            if (chartData.length > 0 && topExpenseNameEl) {
                const topCat = chartData[0];
                topExpenseNameEl.textContent = topCat.name;
                topExpenseAmountEl.innerHTML = `${curr.useSVG ? '<svg class="sar-symbol-inline" style="width:14px;height:14px;"><use href="#sar-icon"></use></svg>' : curr.symbol} ${formatMoneyPlain(topCat.amount)}`;
                if (topExpensePercentLabelEl) topExpensePercentLabelEl.textContent = `${topCat.percent}% من إجمالي المصروفات`;
                topExpenseIconEl.style.background = topCat.color;
                topExpenseIconEl.innerHTML = `<svg fill="none" stroke="white" viewBox="0 0 24 24" style="width: 24px; height: 24px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>`;
            } else if (topExpenseNameEl) {
                topExpenseNameEl.textContent = 'لا توجد مصروفات';
                topExpenseAmountEl.textContent = '-';
                if (topExpensePercentLabelEl) topExpensePercentLabelEl.textContent = '-';
            }
            
            // Month Comparison
            updateMonthComparison();
        }
        
        function updateMonthComparison() {
            const container = document.getElementById('month-comparison');
            const titleEl = document.getElementById('period-chart-title');
            if (!container) return;
            
            let periodsData = [];
            let periodTitle = 'تحليل الفترة';
            const now = new Date();
            const todayIndex = now.getDay();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            // Full Arabic names
            const dayNames = ['السبت', 'الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة'];
            const monthNames = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
            
            if (reportPeriodType === 'week') {
                periodTitle = 'تحليل الأسبوع';
                const satBasedToday = todayIndex === 0 ? 1 : (todayIndex === 6 ? 0 : todayIndex + 1);
                
                for (let i = 0; i < 7; i++) {
                    const daysFromToday = i - satBasedToday;
                    const date = new Date(now.getTime() + daysFromToday * 24 * 60 * 60 * 1000);
                    const dayStart = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                    const dayEnd = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 23, 59, 59);
                    
                    const isFuture = daysFromToday > 0;
                    periodsData.push({
                        label: dayNames[i],
                        income: isFuture ? 0 : getIncomeForPeriod(dayStart, dayEnd),
                        expense: isFuture ? 0 : getExpenseForPeriod(dayStart, dayEnd),
                        isFuture: isFuture
                    });
                }
            } else if (reportPeriodType === 'month') {
                periodTitle = 'تحليل الشهور';
                
                for (let i = 0; i < 12; i++) {
                    const monthStart = new Date(currentYear, i, 1);
                    const monthEnd = new Date(currentYear, i + 1, 0, 23, 59, 59);
                    
                    const isFuture = i > currentMonth;
                    periodsData.push({
                        label: monthNames[i],
                        income: isFuture ? 0 : getIncomeForPeriod(monthStart, monthEnd),
                        expense: isFuture ? 0 : getExpenseForPeriod(monthStart, monthEnd),
                        isFuture: isFuture
                    });
                }
            } else {
                periodTitle = 'تحليل السنوات';
                
                for (let i = -3; i <= 3; i++) {
                    const year = currentYear + i;
                    const yearStart = new Date(year, 0, 1);
                    const yearEnd = new Date(year, 11, 31, 23, 59, 59);
                    
                    const isFuture = i > 0;
                    periodsData.push({
                        label: year.toString(),
                        income: isFuture ? 0 : getIncomeForPeriod(yearStart, yearEnd),
                        expense: isFuture ? 0 : getExpenseForPeriod(yearStart, yearEnd),
                        isFuture: isFuture
                    });
                }
            }
            
            if (titleEl) titleEl.textContent = periodTitle;
            
            const maxVal = Math.max(...periodsData.filter(p => !p.isFuture).map(p => Math.max(p.income, p.expense)), 100);
            
            // Format with K and M (English)
            function fmtY(v) {
                if (v >= 1000000) return (v/1000000).toFixed(1) + 'M';
                if (v >= 1000) return (v/1000).toFixed(0) + 'K';
                return Math.round(v).toString();
            }
            
            const n = periodsData.length;
            const W = 340, H = 115;
            const padL = 30, padR = 30;
            const T = 12, B = 22;
            const cH = H - T - B;
            const chartW = W - padL - padR;
            
            // Points with padding
            let incPts = [], expPts = [];
            
            periodsData.forEach((p, i) => {
                const x = padL + (n > 1 ? (chartW * i / (n - 1)) : chartW / 2);
                const yInc = T + cH - (p.income / maxVal) * cH;
                const yExp = T + cH - (p.expense / maxVal) * cH;
                incPts.push({x, y: Math.max(T, Math.min(T + cH, yInc)), v: p.income, l: p.label, future: p.isFuture});
                expPts.push({x, y: Math.max(T, Math.min(T + cH, yExp)), v: p.expense, l: p.label, future: p.isFuture});
            });
            
            const pastIncPts = incPts.filter(p => !p.future);
            const pastExpPts = expPts.filter(p => !p.future);
            
            const incPath = pastIncPts.map((p, i) => `${i === 0 ? 'M' : 'L'}${p.x.toFixed(1)},${p.y.toFixed(1)}`).join(' ');
            const expPath = pastExpPts.map((p, i) => `${i === 0 ? 'M' : 'L'}${p.x.toFixed(1)},${p.y.toFixed(1)}`).join(' ');
            
            const incArea = pastIncPts.length > 1 ? incPath + ` L${pastIncPts[pastIncPts.length-1].x},${T+cH} L${pastIncPts[0].x},${T+cH} Z` : '';
            const expArea = pastExpPts.length > 1 ? expPath + ` L${pastExpPts[pastExpPts.length-1].x},${T+cH} L${pastExpPts[0].x},${T+cH} Z` : '';
            
            // 6 Y-axis levels
            const yLevels = [0, 0.2, 0.4, 0.6, 0.8, 1].map(r => ({
                y: T + cH * (1 - r), 
                v: fmtY(maxVal * r)
            }));
            
            const uid = 'c' + Date.now();
            
            container.innerHTML = `
                <div style="position:relative;">
                    <svg viewBox="0 0 ${W} ${H}" preserveAspectRatio="none" style="width:100%;height:auto;display:block;direction:ltr;">
                        <defs>
                            <linearGradient id="${uid}a" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="0%" stop-color="#10b981" stop-opacity="0.2"/>
                                <stop offset="100%" stop-color="#10b981" stop-opacity="0"/>
                            </linearGradient>
                            <linearGradient id="${uid}b" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="0%" stop-color="#ef4444" stop-opacity="0.2"/>
                                <stop offset="100%" stop-color="#ef4444" stop-opacity="0"/>
                            </linearGradient>
                        </defs>
                        
                        <!-- Horizontal grid lines - FULL WIDTH -->
                        ${yLevels.map(l => `
                            <line x1="0" y1="${l.y}" x2="${W}" y2="${l.y}" stroke="var(--border-color)" stroke-width="0.5" opacity="0.3"/>
                        `).join('')}
                        
                        <!-- Y-axis labels - aligned with grid lines -->
                        ${yLevels.map(l => `
                            <text x="3" y="${l.y - 4}" font-size="7" fill="var(--text-muted)" text-anchor="start" font-family="system-ui">${l.v}</text>
                        `).join('')}
                        
                        <!-- Area fills -->
                        ${incArea ? `<path d="${incArea}" fill="url(#${uid}a)"/>` : ''}
                        ${expArea ? `<path d="${expArea}" fill="url(#${uid}b)"/>` : ''}
                        
                        <!-- Lines -->
                        ${incPath ? `<path d="${incPath}" fill="none" stroke="#10b981" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>` : ''}
                        ${expPath ? `<path d="${expPath}" fill="none" stroke="#ef4444" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>` : ''}
                        
                        <!-- Interactive Income points - smaller -->
                        ${pastIncPts.map(p => `
                            <circle cx="${p.x}" cy="${p.y}" r="3" fill="#10b981" style="cursor:pointer" 
                                onmouseenter="showTip(evt, '${p.l}', 'الدخل', ${p.v})" 
                                onmouseleave="hideTip()"
                                ontouchstart="showTip(evt, '${p.l}', 'الدخل', ${p.v})"/>
                        `).join('')}
                        
                        <!-- Interactive Expense points - smaller -->
                        ${pastExpPts.map(p => `
                            <circle cx="${p.x}" cy="${p.y}" r="3" fill="#ef4444" style="cursor:pointer"
                                onmouseenter="showTip(evt, '${p.l}', 'المصروفات', ${p.v})" 
                                onmouseleave="hideTip()"
                                ontouchstart="showTip(evt, '${p.l}', 'المصروفات', ${p.v})"/>
                        `).join('')}
                        
                        <!-- X-axis labels -->
                        ${periodsData.map((p, i) => {
                            const x = padL + (n > 1 ? (chartW * i / (n - 1)) : chartW / 2);
                            const opacity = p.isFuture ? '0.3' : '1';
                            return `<text x="${x}" y="${H - 5}" font-size="7" fill="var(--text-muted)" text-anchor="middle" font-family="Tajawal" opacity="${opacity}">${p.label}</text>`;
                        }).join('')}
                    </svg>
                    
                    <!-- Tooltip -->
                    <div id="chartTip" style="display:none;position:absolute;background:var(--bg-card);border:1px solid var(--border-color);border-radius:8px;padding:8px 12px;font-size:12px;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:100;pointer-events:none;text-align:center;"></div>
                </div>
                
                <div style="display:flex;justify-content:center;gap:20px;margin-top:24px;">
                    <span style="display:flex;align-items:center;gap:5px;font-size:0.75rem;color:var(--text-muted);font-weight:600;">
                        <span style="width:6px;height:6px;border-radius:50%;background:#10b981;"></span>الدخل
                    </span>
                    <span style="display:flex;align-items:center;gap:5px;font-size:0.75rem;color:var(--text-muted);font-weight:600;">
                        <span style="width:6px;height:6px;border-radius:50%;background:#ef4444;"></span>المصروفات
                    </span>
                </div>
            `;
        }
        
        // Tooltip functions
        function showTip(evt, label, type, value) {
            const tip = document.getElementById('chartTip');
            if (!tip) return;
            const color = type === 'الدخل' ? '#10b981' : '#ef4444';
            tip.innerHTML = `<div style="color:var(--text-muted);font-size:10px;margin-bottom:3px;">${label}</div><div style="color:${color};font-weight:700;">${type}: ${formatMoneyPlain(value)}</div>`;
            tip.style.display = 'block';
            
            const container = tip.parentElement;
            const rect = container.getBoundingClientRect();
            const x = evt.clientX - rect.left;
            const y = evt.clientY - rect.top;
            
            tip.style.left = Math.max(5, Math.min(x - 50, rect.width - 110)) + 'px';
            tip.style.top = Math.max(5, y - 55) + 'px';
        }
        
        function hideTip() {
            const tip = document.getElementById('chartTip');
            if (tip) tip.style.display = 'none';
        }
        
        function getIncomeForPeriod(startDate, endDate) {
            return transactions.filter(t => {
                const d = new Date(t.date);
                return d >= startDate && d <= endDate && t.type === 'income';
            }).reduce((acc, t) => acc + t.amount, 0);
        }
        
        function getExpenseForPeriod(startDate, endDate) {
            return transactions.filter(t => {
                const d = new Date(t.date);
                return d >= startDate && d <= endDate && t.type === 'expense';
            }).reduce((acc, t) => acc + t.amount, 0);
        }
        
        function getNetForPeriod(startDate, endDate) {
            return transactions.filter(t => {
                const d = new Date(t.date);
                return d >= startDate && d <= endDate;
            }).reduce((acc, t) => t.type === 'income' ? acc + t.amount : acc - t.amount, 0);
        }
        
        function updatePeriodSummaries() {
            const now = new Date();
            
            // This month
            const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const thisMonthIncome = getIncomeForPeriod(thisMonthStart, now);
            const thisMonthNet = getNetForPeriod(thisMonthStart, now);
            
            // Last month
            const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59);
            const lastMonthIncome = getIncomeForPeriod(lastMonthStart, lastMonthEnd);
            const lastMonthNet = getNetForPeriod(lastMonthStart, lastMonthEnd);
            
            // This year
            const thisYearStart = new Date(now.getFullYear(), 0, 1);
            const thisYearNet = getNetForPeriod(thisYearStart, now);
            
            // Update home page - This Month (show NET big, income small below)
            const thisMonthEl = document.getElementById('summary-this-month');
            thisMonthEl.innerHTML = formatMoney(thisMonthNet);
            thisMonthEl.style.color = thisMonthNet >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            
            const thisMonthIncomeEl = document.getElementById('summary-this-month-income');
            if (thisMonthIncomeEl) {
                thisMonthIncomeEl.innerHTML = `دخل: ${formatMoneyPlain(thisMonthIncome)}`;
            }
            
            // Update home page - Last Month (show NET big, income small below)
            const lastMonthEl = document.getElementById('summary-last-month');
            lastMonthEl.innerHTML = formatMoney(lastMonthNet);
            lastMonthEl.style.color = lastMonthNet >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            
            const lastMonthIncomeEl = document.getElementById('summary-last-month-income');
            if (lastMonthIncomeEl) {
                lastMonthIncomeEl.innerHTML = `دخل: ${formatMoneyPlain(lastMonthIncome)}`;
            }
            
            // Update home page - This Year (show net savings)
            const thisYearEl = document.getElementById('summary-this-year');
            thisYearEl.innerHTML = formatMoney(thisYearNet);
            thisYearEl.style.color = thisYearNet >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
        }
        
        // Goals Functions
        function getAvailableSavings() {
            const balance = transactions.reduce((acc, t) => t.type === 'income' ? acc + t.amount : acc - t.amount, 0);
            const totalAllocated = goals.reduce((acc, g) => acc + g.current, 0);
            return balance - totalAllocated;
        }
        
        function updateGoals() {
            const available = getAvailableSavings();
            const totalAllocated = goals.reduce((acc, g) => acc + g.current, 0);
            const curr = currencyData[settings.currency];
            const currSymbol = curr.useSVG ? '<svg class="sar-symbol-inline"><use href="#sar-icon"></use></svg>' : curr.symbol;
            
            // Update header
            const headerEl = document.getElementById('goals-header');
            const availableEl = document.getElementById('available-savings');
            availableEl.innerHTML = '<span class="money-display">' + currSymbol + ' ' + formatMoneyPlain(available) + '</span>';
            
            if (available < 0) {
                headerEl.classList.add('negative');
                document.getElementById('overspent-alert').style.display = 'flex';
                document.getElementById('overspent-amount').textContent = `صرفت ${formatMoneyPlain(Math.abs(available))} من مدخراتك المخصصة`;
            } else {
                headerEl.classList.remove('negative');
                document.getElementById('overspent-alert').style.display = 'none';
            }
            
            // Update summary
            document.getElementById('total-allocated').innerHTML = formatMoney(totalAllocated);
            document.getElementById('goals-count').textContent = goals.length;
        }
        
        function renderGoals() {
            const container = document.getElementById('goals-list');
            if (goals.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <h3>لا توجد أهداف</h3>
                        <p>ابدأ بإنشاء هدف لتوزيع مدخراتك</p>
                    </div>
                `;
                return;
            }
            
            const curr = currencyData[settings.currency];
            const currSymbol = curr.useSVG ? '<svg class="sar-symbol-inline" style="width:12px;height:12px;"><use href="#sar-icon"></use></svg>' : curr.symbol;
            
            container.innerHTML = goals.map(g => {
                const percent = g.target > 0 ? Math.min((g.current / g.target) * 100, 100) : 0;
                const remaining = g.target - g.current;
                const isComplete = g.current >= g.target;
                return `
                    <div class="goal-card">
                        <div class="goal-header">
                            <div style="flex: 1;">
                                <div class="goal-name">${g.name}</div>
                                <div class="goal-remaining">${isComplete ? 'تم تحقيق الهدف' : `باقي <span class="money-display">${currSymbol} ${formatMoneyPlain(remaining)}</span> لتحقيق الهدف`}</div>
                            </div>
                            <div class="goal-amount-display">
                                <span class="goal-current-amount"><span class="money-display">${currSymbol} ${formatMoneyPlain(g.current)}</span></span>
                                <span class="goal-target-amount">من <span class="money-display">${currSymbol} ${formatMoneyPlain(g.target)}</span></span>
                            </div>
                        </div>
                        <div class="goal-progress">
                            <div class="goal-progress-bar">
                                <div class="goal-progress-fill" style="width: ${percent}%;${isComplete ? ' background: var(--accent-green);' : ''}"></div>
                            </div>
                            <div class="goal-progress-text">
                                <span class="goal-progress-percent">${percent.toFixed(0)}%</span>
                            </div>
                        </div>
                        <div class="goal-actions">
                            <button class="goal-btn add" onclick="openAddToGoalModal('${g.id}')">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                إضافة
                            </button>
                            <button class="goal-btn withdraw" onclick="openWithdrawGoalModal('${g.id}')">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg>
                                سحب
                            </button>
                            <button class="goal-btn delete" onclick="deleteGoal('${g.id}')">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function addGoal() {
            const name = document.getElementById('goal-name').value.trim();
            const target = parseFloat(document.getElementById('goal-target').value);
            
            if (!name || !target || target <= 0) {
                alert('أدخل اسم الهدف والمبلغ المستهدف');
                return;
            }
            
            goals.push({
                id: generateId(),
                name,
                target,
                current: 0,
                date: new Date().toISOString()
            });
            
            saveData();
            updateUI();
            closeModal('goal');
            document.getElementById('goal-name').value = '';
            document.getElementById('goal-target').value = '';
        }
        
        function openAddToGoalModal(goalId) {
            currentGoalId = goalId;
            const goal = goals.find(g => g.id === goalId);
            const available = getAvailableSavings();
            
            document.getElementById('add-goal-name').textContent = goal.name;
            document.getElementById('add-available').textContent = formatMoneyPlain(Math.max(0, available));
            document.getElementById('add-goal-amount').value = '';
            
            openModal('add-to-goal');
        }
        
        function addToGoal() {
            const amount = parseFloat(document.getElementById('add-goal-amount').value);
            const available = getAvailableSavings();
            
            if (!amount || amount <= 0) {
                alert('أدخل مبلغ صحيح');
                return;
            }
            
            if (amount > available) {
                alert('المبلغ أكبر من المتاح للتوزيع');
                return;
            }
            
            const goal = goals.find(g => g.id === currentGoalId);
            goal.current += amount;
            
            saveData();
            updateUI();
            closeModal('add-to-goal');
        }
        
        function openWithdrawGoalModal(goalId) {
            currentGoalId = goalId;
            const goal = goals.find(g => g.id === goalId);
            
            document.getElementById('withdraw-goal-name').textContent = goal.name;
            document.getElementById('withdraw-available').textContent = formatMoneyPlain(goal.current);
            document.getElementById('withdraw-goal-amount').value = '';
            
            openModal('withdraw-goal');
        }
        
        function withdrawFromGoal() {
            const amount = parseFloat(document.getElementById('withdraw-goal-amount').value);
            const goal = goals.find(g => g.id === currentGoalId);
            
            if (!amount || amount <= 0) {
                alert('أدخل مبلغ صحيح');
                return;
            }
            
            if (amount > goal.current) {
                alert('المبلغ أكبر من المخصص للهدف');
                return;
            }
            
            goal.current -= amount;
            
            saveData();
            updateUI();
            closeModal('withdraw-goal');
        }
        
        function deleteGoal(goalId) {
            if (confirm('حذف هذا الهدف؟')) {
                goals = goals.filter(g => g.id !== goalId);
                saveData();
                updateUI();
            }
        }
        
        // UI Update
        function updateUI() {
            updateBalance();
            updateBudget();
            updateDebtsSummary();
            updateGoldSummary();
            updateZakat();
            updateGoals();
            updatePeriodSummaries();
            renderRecentTransactions();
            renderTransactions();
            renderDebts();
            renderGoldHoldings();
            renderGoals();
            updateCustomReport();
            updateSettingsUI();
            renderRecurringList();
            renderSubscriptionsList();
            renderChallengesList();
            displaySmartAlerts();
            updateRamadanSummary();
        }
        
        function displaySmartAlerts() {
            const alerts = checkSmartAlerts();
            const container = document.getElementById('smart-alerts');
            if (!container) return;
            
            if (alerts.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            container.innerHTML = alerts.map(a => `
                <div class="smart-alert-item">${a}</div>
            `).join('');
        }
        
        function updateBalance() {
            const balance = transactions.reduce((acc, t) => t.type === 'income' ? acc + t.amount : acc - t.amount, 0);
            const curr = currencyData[settings.currency];
            
            const balanceDisplay = document.getElementById('balance-display');
            if (curr.useSVG) {
                balanceDisplay.innerHTML = `<svg class="sar-symbol"><use href="#sar-icon"></use></svg> ${formatMoneyPlain(balance)}`;
            } else {
                balanceDisplay.innerHTML = `${curr.symbol} ${formatMoneyPlain(balance)}`;
            }
            
            if (settings.currency !== 'EGP') {
                document.getElementById('balance-egp').textContent = formatEGP(balance);
                document.getElementById('balance-egp').style.display = 'block';
                document.getElementById('balance-egp-label').style.display = 'block';
            } else {
                document.getElementById('balance-egp').style.display = 'none';
                document.getElementById('balance-egp-label').style.display = 'none';
            }
        }
        
        function updateBudget() {
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthlyExpenses = transactions.filter(t => t.type === 'expense' && new Date(t.date) >= startOfMonth).reduce((acc, t) => acc + t.amount, 0);
            const percentage = Math.min((monthlyExpenses / settings.monthlyBudget) * 100, 100);
            const remaining = settings.monthlyBudget - monthlyExpenses;
            
            // Update header amount
            document.getElementById('budget-spent-header').innerHTML = formatMoney(monthlyExpenses);
            document.getElementById('budget-limit').innerHTML = formatMoney(settings.monthlyBudget);
            
            const badge = document.getElementById('budget-badge');
            const isAlert = monthlyExpenses >= settings.budgetAlert;
            const isOver = monthlyExpenses >= settings.monthlyBudget;
            
            badge.textContent = Math.round(percentage) + '%';
            badge.style.color = isOver ? 'var(--accent-red)' : isAlert ? 'var(--accent-gold)' : 'var(--accent-green)';
            
            // Update header amount color
            const headerAmount = document.getElementById('budget-spent-header');
            headerAmount.style.color = isOver ? 'var(--accent-red)' : isAlert ? 'var(--accent-gold)' : 'var(--text-primary)';
            
            const fill = document.getElementById('budget-fill');
            fill.style.width = percentage + '%';
            fill.style.background = isOver ? 'var(--accent-red)' : isAlert ? 'var(--accent-gold)' : 'var(--accent-green)';
            
            // Show alert banner if reached alert threshold
            const alertBanner = document.getElementById('budget-alert-banner');
            if (alertBanner) {
                if (isAlert && !isOver) {
                    alertBanner.style.display = 'flex';
                    alertBanner.innerHTML = `
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        <span> انتبه! وصلت لـ ${formatMoneyPlain(monthlyExpenses)} من حد التنبيه (${formatMoneyPlain(settings.budgetAlert)})</span>
                    `;
                } else if (isOver) {
                    alertBanner.style.display = 'flex';
                    alertBanner.innerHTML = `
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span>🚫 تجاوزت الميزانية بـ ${formatMoneyPlain(Math.abs(remaining))}</span>
                    `;
                } else {
                    alertBanner.style.display = 'none';
                }
            }
        }
        
        function updateDebtsSummary() {
            const toMe = debts.filter(d => d.type === 'to_me' && d.remaining > 0).reduce((acc, d) => acc + d.remaining, 0);
            const fromMe = debts.filter(d => d.type === 'from_me' && d.remaining > 0).reduce((acc, d) => acc + d.remaining, 0);
            const monthlyInstallments = installments.filter(i => i.remaining > 0).reduce((acc, i) => acc + i.amount, 0);
            
            document.getElementById('debts-to-me').innerHTML = formatMoney(toMe);
            document.getElementById('debts-from-me').innerHTML = formatMoney(fromMe);
            document.getElementById('debts-to-me-2').innerHTML = formatMoney(toMe);
            document.getElementById('debts-from-me-2').innerHTML = formatMoney(fromMe);
            
            const monthlyEl = document.getElementById('monthly-installments');
            if (monthlyEl) monthlyEl.innerHTML = formatMoney(monthlyInstallments);
            
            if (settings.currency !== 'EGP') {
                document.getElementById('debts-to-me-egp').textContent = formatEGP(toMe);
                document.getElementById('debts-from-me-egp').textContent = formatEGP(fromMe);
            }
        }
        
        function updateGoldSummary() {
            const totalValue = goldHoldings.reduce((acc, g) => acc + (g.weight * settings.goldPrices[g.type]), 0);
            const totalProfit = goldHoldings.reduce((acc, g) => acc + ((g.weight * settings.goldPrices[g.type]) - (g.weight * g.purchasePrice)), 0);
            
            // Convert to EGP
            const totalEGP = totalValue * settings.exchangeRate;
            const profitEGP = totalProfit * settings.exchangeRate;
            
            // SAR symbol
            const sarSymbol = '<svg class="sar-symbol-inline" style="width:12px;height:12px;"><use href="#sar-icon"></use></svg>';
            
            // Home page widgets (in primary currency)
            document.getElementById('gold-value').innerHTML = formatMoney(totalValue);
            const profitEl = document.getElementById('gold-profit');
            profitEl.innerHTML = (totalProfit >= 0 ? '+' : '') + formatMoney(totalProfit);
            profitEl.style.color = totalProfit >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            
            if (settings.currency !== 'EGP') {
                document.getElementById('gold-value-egp').textContent = formatEGP(totalValue);
                document.getElementById('gold-profit-egp').textContent = formatEGP(totalProfit);
            }
            
            // Gold page - show in EGP with SAR equivalent
            document.getElementById('gold-total-egp').textContent = formatMoneyPlain(totalEGP) + ' ج.م';
            document.getElementById('gold-total-sar').innerHTML = '≈ ' + sarSymbol + ' ' + formatMoneyPlain(totalValue);
            
            const profitEgpEl = document.getElementById('gold-profit-egp');
            profitEgpEl.textContent = (totalProfit >= 0 ? '+' : '') + formatMoneyPlain(profitEGP) + ' ج.م';
            profitEgpEl.style.color = totalProfit >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            document.getElementById('gold-profit-sar').innerHTML = '≈ ' + (totalProfit >= 0 ? '+' : '') + sarSymbol + ' ' + formatMoneyPlain(totalProfit);
            
            // Gold prices in EGP with SAR
            document.getElementById('price-24-egp').textContent = formatMoneyPlain(settings.goldPrices['24'] * settings.exchangeRate) + ' ج.م';
            document.getElementById('price-24-sar').innerHTML = '≈ ' + sarSymbol + ' ' + formatMoneyPlain(settings.goldPrices['24']);
            document.getElementById('price-21-egp').textContent = formatMoneyPlain(settings.goldPrices['21'] * settings.exchangeRate) + ' ج.م';
            document.getElementById('price-21-sar').innerHTML = '≈ ' + sarSymbol + ' ' + formatMoneyPlain(settings.goldPrices['21']);
            document.getElementById('price-18-egp').textContent = formatMoneyPlain(settings.goldPrices['18'] * settings.exchangeRate) + ' ج.م';
            document.getElementById('price-18-sar').innerHTML = '≈ ' + sarSymbol + ' ' + formatMoneyPlain(settings.goldPrices['18']);
        }
        
        function updateZakat() {
            const balance = transactions.reduce((acc, t) => t.type === 'income' ? acc + t.amount : acc - t.amount, 0);
            const goldValue = goldHoldings.reduce((acc, g) => acc + (g.weight * settings.goldPrices[g.type]), 0);
            const nisabValue = settings.goldPrices['24'] * 85;
            const zakatableAmount = balance + goldValue;
            const isZakatDue = zakatableAmount >= nisabValue;
            const zakatAmount = isZakatDue ? zakatableAmount * 0.025 : 0;
            
            // Update zakat modal
            const nisabEl = document.getElementById('zakat-nisab');
            const goldPriceEl = document.getElementById('zakat-gold-price');
            const cashEl = document.getElementById('zakat-cash');
            const goldEl = document.getElementById('zakat-gold');
            const totalEl = document.getElementById('zakat-total');
            const resultEl = document.getElementById('zakat-result');
            
            if (nisabEl) nisabEl.innerHTML = formatMoney(nisabValue);
            if (goldPriceEl) goldPriceEl.innerHTML = formatMoney(settings.goldPrices['24']);
            if (cashEl) cashEl.innerHTML = formatMoney(balance);
            if (goldEl) goldEl.innerHTML = formatMoney(goldValue);
            if (totalEl) totalEl.innerHTML = formatMoney(zakatableAmount);
            
            if (resultEl) {
                if (isZakatDue) {
                    resultEl.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div style="width: 44px; height: 44px; border-radius: var(--radius-md); background: rgba(16, 185, 129, 0.15); display: flex; align-items: center; justify-content: center; color: var(--accent-green);">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 22px; height: 22px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            </div>
                            <div>
                                <h4 style="color: var(--accent-green); font-weight: 800;">الزكاة واجبة</h4>
                                <p style="font-size: 0.8rem; color: var(--text-muted);">ثروتك بلغت النصاب</p>
                            </div>
                        </div>
                        <div style="background: rgba(16, 185, 129, 0.1); border-radius: var(--radius-md); padding: 14px; text-align: center;">
                            <p style="color: var(--text-muted); font-size: 0.85rem;">مقدار الزكاة (2.5%)</p>
                            <p style="font-size: 1.3rem; font-weight: 900; color: var(--accent-green);">${formatMoneyPlain(zakatAmount)}</p>
                        </div>
                    `;
                } else {
                    resultEl.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 44px; height: 44px; border-radius: var(--radius-md); background: var(--bg-input); display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 22px; height: 22px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </div>
                            <div>
                                <h4 style="font-weight: 800;">الزكاة غير واجبة</h4>
                                <p style="font-size: 0.8rem; color: var(--text-muted);">ينقصك ${formatMoneyPlain(nisabValue - zakatableAmount)} لبلوغ النصاب</p>
                            </div>
                        </div>
                    `;
                }
            }
        }
        
        function renderRecentTransactions() {
            const container = document.getElementById('recent-transactions');
            const recent = transactions.slice(0, 5);
            
            if (recent.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg></div><h3>لا توجد معاملات</h3><p>ابدأ بإضافة دخل أو مصروف</p></div>`;
                return;
            }
            
            container.innerHTML = recent.map(t => {
                const allCats = [...expenseCategories, ...incomeCategories, ...ramadanCategories, ...customExpenseCategories, ...customIncomeCategories];
                const cat = allCats.find(c => c.id === t.category) || { name: 'أخرى', color: '#6b7280', icon: '<circle cx="12" cy="12" r="3"/>' };
                return `
                    <div class="transaction-item">
                        <div class="transaction-icon ${t.type}">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">${cat.icon}</svg>
                        </div>
                        <div class="transaction-details">
                            <div class="transaction-name">${t.note || cat.name}</div>
                            <div class="transaction-date">${formatDateTime(t.date)}</div>
                        </div>
                        <div class="transaction-amounts">
                            <div class="transaction-amount ${t.type}">${t.type === 'income' ? '+' : '-'}${formatMoney(t.amount)}</div>
                            ${settings.currency !== 'EGP' ? `<div class="transaction-converted">${formatEGP(t.amount)}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderTransactions() {
            const container = document.getElementById('all-transactions');
            let filtered = currentTransactionFilter === 'all' ? [...transactions] : transactions.filter(t => t.type === currentTransactionFilter);
            
            // Apply date filter
            if (transFromDate && transToDate) {
                const from = transFromDate;
                const to = new Date(transToDate);
                to.setHours(23, 59, 59);
                filtered = filtered.filter(t => {
                    const d = new Date(t.date);
                    return d >= from && d <= to;
                });
            }
            
            // Apply search filter
            if (searchQuery) {
                filtered = filtered.filter(t => {
                    const allCats = [...expenseCategories, ...incomeCategories, ...ramadanCategories, ...customExpenseCategories, ...customIncomeCategories];
                    const cat = allCats.find(c => c.id === t.category) || { name: 'أخرى' };
                    const note = (t.note || '').toLowerCase();
                    const catName = cat.name.toLowerCase();
                    const amount = t.amount.toString();
                    return note.includes(searchQuery) || catName.includes(searchQuery) || amount.includes(searchQuery);
                });
            }
            
            // Apply category filter
            if (categoryFilter !== 'all') {
                filtered = filtered.filter(t => t.category === categoryFilter);
            }
            
            if (filtered.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg></div><h3>لا توجد معاملات</h3></div>`;
                return;
            }
            
            container.innerHTML = filtered.map(t => {
                const allCats = [...expenseCategories, ...incomeCategories, ...ramadanCategories, ...customExpenseCategories, ...customIncomeCategories];
                const cat = allCats.find(c => c.id === t.category) || { name: 'أخرى', color: '#6b7280', icon: '<circle cx="12" cy="12" r="3"/>' };
                return `
                    <div class="transaction-item">
                        <div class="transaction-icon ${t.type}">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">${cat.icon}</svg>
                        </div>
                        <div class="transaction-details">
                            <div class="transaction-name">${t.note || cat.name}</div>
                            <div class="transaction-date">${formatDateTime(t.date)}</div>
                        </div>
                        <div class="transaction-amounts">
                            <div class="transaction-amount ${t.type}">${t.type === 'income' ? '+' : '-'}${formatMoney(t.amount)}</div>
                            ${settings.currency !== 'EGP' ? `<div class="transaction-converted">${formatEGP(t.amount)}</div>` : ''}
                        </div>
                        <button class="delete-btn" onclick="deleteTransaction('${t.id}')">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        function renderDebts() {
            const container = document.getElementById('debts-list');
            
            // Helper function to get currency symbol
            function getCurrSymbol(currCode) {
                const curr = currencyData[currCode || settings.currency];
                return curr.useSVG ? '<svg class="sar-symbol-inline" style="width:12px;height:12px;"><use href="#sar-icon"></use></svg>' : curr.symbol;
            }
            
            // Installment category SVG icons
            const installmentIcons = {
                car: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px;height:24px;color:var(--accent-blue);"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 17h.01M16 17h.01M5 11l1.5-4.5h11L19 11M5 11h14M5 11v6h2m0 0a2 2 0 104 0m-4 0h4m4 0a2 2 0 104 0m-4 0h-4m8 0h2v-6"></path></svg>',
                property: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px;height:24px;color:var(--accent-blue);"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>',
                device: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px;height:24px;color:var(--accent-blue);"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>',
                loan: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px;height:24px;color:var(--accent-blue);"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>',
                furniture: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px;height:24px;color:var(--accent-blue);"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>',
                other: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px;height:24px;color:var(--accent-blue);"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>'
            };
            
            // Person icon for debts
            const personIcon = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px;height:24px;color:var(--text-muted);"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>';
            
            if (currentDebtsPageFilter === 'installments') {
                // Show installments
                const activeInstallments = installments.filter(i => i.remaining > 0);
                
                if (activeInstallments.length === 0) {
                    container.innerHTML = `<div class="empty-state"><div class="empty-state-icon"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg></div><h3>لا توجد أقساط</h3><p>أضف قسط جديد لمتابعته</p></div>`;
                    return;
                }
                
                container.innerHTML = activeInstallments.map(inst => {
                    const paidCount = inst.totalInstallments - inst.remaining;
                    const progress = (paidCount / inst.totalInstallments) * 100;
                    const remainingTotal = inst.remaining * inst.amount;
                    const currSymbol = getCurrSymbol(inst.currency);
                    const currLabel = inst.currency === 'EGP' ? 'ج.م' : 'ر.س';
                    
                    return `
                        <div class="debt-card installment-card">
                            <div class="debt-header">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div class="debt-icon-box">${installmentIcons[inst.category] || installmentIcons.other}</div>
                                    <div>
                                        <div class="debt-person">${inst.name} <span style="font-size: 0.7rem; color: var(--text-muted); font-weight: 500;">(${currLabel})</span></div>
                                        <div class="debt-date">${inst.day ? 'يوم ' + inst.day + ' من كل شهر' : 'بدون موعد محدد'}${inst.note ? ' • ' + inst.note : ''}</div>
                                    </div>
                                </div>
                                <div class="action-icon-buttons">
                                    <button class="action-icon-btn pay" onclick="openPayInstallmentModal('${inst.id}')" title="سداد">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                    </button>
                                    <button class="action-icon-btn delete" onclick="deleteInstallment('${inst.id}')" title="حذف">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                </div>
                            </div>
                            <div class="installment-progress">
                                <div class="installment-progress-bar">
                                    <div class="installment-progress-fill" style="width: ${progress}%;"></div>
                                </div>
                                <div class="installment-progress-text">${paidCount} من ${inst.totalInstallments} قسط</div>
                            </div>
                            <div class="debt-footer" style="margin-top: 10px;">
                                <div class="debt-amount">
                                    <span style="color: var(--text-muted);">القسط:</span> 
                                    <strong class="money-display">${currSymbol} ${formatMoneyPlain(inst.amount)}</strong>
                                </div>
                                <div class="debt-amount">
                                    <span style="color: var(--text-muted);">المتبقي:</span> 
                                    <strong class="money-display" style="color: var(--accent-red);">${currSymbol} ${formatMoneyPlain(remainingTotal)}</strong>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                // Show debts
                const debtType = currentDebtsPageFilter === 'debts_to_me' ? 'to_me' : 'from_me';
                const filtered = debts.filter(d => d.type === debtType && d.remaining > 0);
                
                if (filtered.length === 0) {
                    const emptyMsg = debtType === 'to_me' ? 'لا توجد ديون لك عند الناس' : 'لا توجد ديون عليك للناس';
                    container.innerHTML = `<div class="empty-state"><div class="empty-state-icon"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></div><h3>${emptyMsg}</h3></div>`;
                    return;
                }
                
                container.innerHTML = filtered.map(d => {
                    const progress = ((d.amount - d.remaining) / d.amount) * 100;
                    const currSymbol = getCurrSymbol(d.currency);
                    const currLabel = d.currency === 'EGP' ? 'ج.م' : 'ر.س';
                    return `
                        <div class="debt-card ${d.type === 'to_me' ? 'to-me' : 'from-me'}">
                            <div class="debt-header">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div class="debt-icon-box">${personIcon}</div>
                                    <div>
                                        <div class="debt-person">${d.person} <span style="font-size: 0.7rem; color: var(--text-muted); font-weight: 500;">(${currLabel})</span></div>
                                        <div class="debt-date">${formatDate(d.date)}${d.note ? ' • ' + d.note : ''}</div>
                                    </div>
                                </div>
                                <div class="action-icon-buttons">
                                    <button class="action-icon-btn pay" onclick="openPayModal('${d.id}')" title="سداد">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                    </button>
                                    <button class="action-icon-btn delete" onclick="deleteDebt('${d.id}')" title="حذف">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                </div>
                            </div>
                            ${progress > 0 ? `
                            <div class="installment-progress" style="margin: 10px 0;">
                                <div class="installment-progress-bar">
                                    <div class="installment-progress-fill" style="width: ${progress}%; background: ${d.type === 'to_me' ? 'var(--accent-green)' : 'var(--accent-red)'};"></div>
                                </div>
                                <div class="installment-progress-text">${progress.toFixed(0)}% مسدد</div>
                            </div>
                            ` : ''}
                            <div class="debt-footer">
                                <div class="debt-amount">
                                    <span style="color: var(--text-muted);">المتبقي:</span> 
                                    <strong class="money-display">${currSymbol} ${formatMoneyPlain(d.remaining)}</strong>
                                    <small>من <span class="money-display">${currSymbol} ${formatMoneyPlain(d.amount)}</span></small>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }
        
        function renderGoldHoldings() {
            const container = document.getElementById('gold-holdings');
            if (goldHoldings.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div><h3>لا يوجد ذهب</h3></div>`;
                return;
            }
            
            const sarSymbol = '<svg class="sar-symbol-inline" style="width:10px;height:10px;"><use href="#sar-icon"></use></svg>';
            const typeNames = { '24': 'عيار 24', '21': 'عيار 21', '18': 'عيار 18' };
            container.innerHTML = goldHoldings.map(g => {
                const currentValue = g.weight * settings.goldPrices[g.type];
                const purchaseValue = g.weight * g.purchasePrice;
                const profit = currentValue - purchaseValue;
                // Convert to EGP
                const currentEGP = currentValue * settings.exchangeRate;
                const purchaseEGP = purchaseValue * settings.exchangeRate;
                const profitEGP = profit * settings.exchangeRate;
                return `
                    <div class="card" style="margin-bottom: 12px; padding: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 14px;">
                            <div>
                                <div style="font-weight: 800; font-size: 1rem;">${typeNames[g.type]}</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">${g.weight} جرام</div>
                            </div>
                            <button class="btn btn-small btn-gold" onclick="sellGold('${g.id}')">بيع</button>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center;">
                            <div style="background: var(--bg-input); padding: 10px; border-radius: var(--radius-md);">
                                <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600; margin-bottom: 4px;">الشراء</div>
                                <div style="font-size: 0.95rem; font-weight: 800; color: var(--text-primary);">${formatMoneyPlain(purchaseEGP)} ج.م</div>
                                <div style="font-size: 0.65rem; color: var(--text-muted);">≈ ${sarSymbol} ${formatMoneyPlain(purchaseValue)}</div>
                            </div>
                            <div style="background: var(--bg-input); padding: 10px; border-radius: var(--radius-md);">
                                <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600; margin-bottom: 4px;">الحالي</div>
                                <div style="font-size: 0.95rem; font-weight: 800; color: var(--accent-gold);">${formatMoneyPlain(currentEGP)} ج.م</div>
                                <div style="font-size: 0.65rem; color: var(--text-muted);">≈ ${sarSymbol} ${formatMoneyPlain(currentValue)}</div>
                            </div>
                            <div style="background: var(--bg-input); padding: 10px; border-radius: var(--radius-md);">
                                <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600; margin-bottom: 4px;">الربح</div>
                                <div style="font-size: 0.95rem; font-weight: 800; color: ${profit >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">${profit >= 0 ? '+' : ''}${formatMoneyPlain(profitEGP)} ج.م</div>
                                <div style="font-size: 0.65rem; color: var(--text-muted);">≈ ${profit >= 0 ? '+' : ''}${sarSymbol} ${formatMoneyPlain(profit)}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateSettingsUI() {
            // Update currency toggle buttons
            updateCurrencyToggleUI();
            document.getElementById('exchange-rate').value = settings.exchangeRate;
            document.getElementById('budget-input').value = settings.monthlyBudget;
            document.getElementById('gold-price-24-input').value = settings.goldPrices['24'];
            document.getElementById('gold-price-21-input').value = settings.goldPrices['21'];
            document.getElementById('gold-price-18-input').value = settings.goldPrices['18'];
        }
        
        // Close modal on overlay click
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('active'); });
        });
        
        // Close calendar on outside click
        document.addEventListener('click', e => {
            if (activeCalendar && !e.target.closest('.custom-date-picker')) {
                document.querySelectorAll('.calendar-popup').forEach(p => p.classList.remove('active'));
                activeCalendar = null;
            }
        });
        
        // Welcome Screen Functions
        function checkFirstTime() {
            const isFirstTime = !localStorage.getItem('appInitialized');
            if (isFirstTime) {
                document.getElementById('welcome-screen').style.display = 'flex';
            }
        }
        
        function saveOpeningBalance() {
            const amount = parseFloat(document.getElementById('opening-balance').value) || 0;
            if (amount > 0) {
                // Add opening balance as income
                transactions.unshift({
                    id: generateId(),
                    type: 'income',
                    amount: amount,
                    category: 'opening',
                    description: 'رصيد افتتاحي',
                    date: new Date().toISOString()
                });
                saveData();
            }
            
            localStorage.setItem('appInitialized', 'true');
            document.getElementById('welcome-screen').style.display = 'none';
            updateUI();
            showToast(' تم حفظ الرصيد الافتتاحي');
        }
        
        function skipOpeningBalance() {
            localStorage.setItem('appInitialized', 'true');
            document.getElementById('welcome-screen').style.display = 'none';
        }
        
        // ========== FIREBASE CLOUD SYNC ==========
        // Firebase Configuration - Replace with your own config
        const firebaseConfig = {
            apiKey: "AIzaSyDQIiG_5FlWTsOZOn0_Vlu_jWWTKaFsS7I",
            authDomain: "my-wallet-app-8b8aa.firebaseapp.com",
            projectId: "my-wallet-app-8b8aa",
            storageBucket: "my-wallet-app-8b8aa.firebasestorage.app",
            messagingSenderId: "62795905124",
            appId: "1:62795905124:web:16a7143d907141a0a84771",
            measurementId: "G-869CK9Q0JZ"
        };
        
        // Initialize Firebase (only if SDK is loaded)
        let firebaseApp = null;
        let firebaseAuth = null;
        let firebaseDb = null;
        
        function initFirebase() {
            if (typeof firebase !== 'undefined') {
                try {
                    firebaseApp = firebase.initializeApp(firebaseConfig);
                    firebaseAuth = firebase.auth();
                    firebaseDb = firebase.firestore();
                    
                    // Listen for auth state changes
                    firebaseAuth.onAuthStateChanged((user) => {
                        updateSyncUI(user);
                    });
                    
                    console.log('Firebase initialized successfully');
                } catch (error) {
                    console.log('Firebase init error:', error.message);
                }
            }
        }
        
        // Sign in with Google
        async function signInWithGoogle() {
            if (!firebaseAuth) {
                showToast('خدمة المزامنة غير متاحة حالياً');
                return;
            }
            
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' });
            
            try {
                const result = await firebaseAuth.signInWithPopup(provider);
                showToast('تم تسجيل الدخول بنجاح');
                triggerHaptic('success');
            } catch (error) {
                console.error('Sign in error:', error);
                if (error.code === 'auth/popup-closed-by-user') {
                    showToast('تم إلغاء تسجيل الدخول');
                } else if (error.code === 'auth/unauthorized-domain') {
                    showToast('يجب إضافة هذا الموقع في إعدادات Firebase');
                } else {
                    showToast('فشل تسجيل الدخول: ' + error.message);
                }
            }
        }
        
        // Sign out
        async function signOutFromGoogle() {
            if (!firebaseAuth) return;
            
            try {
                await firebaseAuth.signOut();
                showToast('تم تسجيل الخروج');
                triggerHaptic('light');
            } catch (error) {
                console.error('Sign out error:', error);
            }
        }
        
        // Upload data to cloud
        async function syncToCloud() {
            if (!firebaseAuth || !firebaseDb) {
                showToast('يجب تسجيل الدخول أولاً');
                return;
            }
            
            const user = firebaseAuth.currentUser;
            if (!user) {
                showToast('يجب تسجيل الدخول أولاً');
                return;
            }
            
            try {
                const data = {
                    transactions: transactions,
                    debts: debts,
                    goldHoldings: goldHoldings,
                    goals: goals,
                    installments: installments,
                    recurringTransactions: recurringTransactions,
                    subscriptions: subscriptions,
                    challenges: challenges,
                    settings: settings,
                    updatedAt: new Date().toISOString(),
                    deviceInfo: navigator.userAgent
                };
                
                await firebaseDb.collection('users').doc(user.uid).set(data);
                
                localStorage.setItem('lastSyncTime', new Date().toISOString());
                updateSyncUI(user);
                showToast('تم رفع البيانات بنجاح ✓');
                triggerHaptic('success');
            } catch (error) {
                console.error('Sync to cloud error:', error);
                showToast('فشل رفع البيانات: ' + error.message);
            }
        }
        
        // Download data from cloud
        async function syncFromCloud() {
            if (!firebaseAuth || !firebaseDb) {
                showToast('يجب تسجيل الدخول أولاً');
                return;
            }
            
            const user = firebaseAuth.currentUser;
            if (!user) {
                showToast('يجب تسجيل الدخول أولاً');
                return;
            }
            
            try {
                const doc = await firebaseDb.collection('users').doc(user.uid).get();
                
                if (doc.exists) {
                    const data = doc.data();
                    
                    // Confirm before overwriting
                    if (!confirm('سيتم استبدال البيانات الحالية بالبيانات المحفوظة في السحابة. هل تريد المتابعة؟')) {
                        return;
                    }
                    
                    // Restore data
                    transactions = data.transactions || [];
                    debts = data.debts || [];
                    goldHoldings = data.goldHoldings || [];
                    goals = data.goals || [];
                    installments = data.installments || [];
                    recurringTransactions = data.recurringTransactions || [];
                    subscriptions = data.subscriptions || [];
                    challenges = data.challenges || [];
                    if (data.settings) settings = data.settings;
                    
                    saveData();
                    updateUI();
                    
                    localStorage.setItem('lastSyncTime', new Date().toISOString());
                    updateSyncUI(user);
                    showToast('تم استرجاع البيانات بنجاح ✓');
                    triggerHaptic('success');
                } else {
                    showToast('لا توجد بيانات محفوظة في السحابة');
                }
            } catch (error) {
                console.error('Sync from cloud error:', error);
                showToast('فشل استرجاع البيانات: ' + error.message);
            }
        }
        
        // Update sync UI based on auth state
        function updateSyncUI(user) {
            const signInBtn = document.getElementById('google-signin-btn');
            const syncActions = document.getElementById('sync-actions');
            const statusIcon = document.getElementById('sync-status-icon');
            const statusTitle = document.getElementById('sync-status-title');
            const statusDesc = document.getElementById('sync-status-desc');
            const userEmailDisplay = document.getElementById('user-email-display');
            
            if (user) {
                // User is signed in
                if (signInBtn) signInBtn.style.display = 'none';
                if (syncActions) syncActions.style.display = 'block';
                if (userEmailDisplay) userEmailDisplay.textContent = user.email;
                
                const lastSync = localStorage.getItem('lastSyncTime');
                if (statusIcon) {
                    statusIcon.classList.remove('not-synced');
                    statusIcon.classList.add('synced');
                    statusIcon.innerHTML = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
                }
                if (statusTitle) statusTitle.textContent = 'مرتبط بـ Google';
                if (statusDesc) {
                    if (lastSync) {
                        const syncDate = new Date(lastSync);
                        statusDesc.textContent = 'آخر مزامنة: ' + syncDate.toLocaleDateString('ar-EG') + ' ' + syncDate.toLocaleTimeString('ar-EG', {hour: '2-digit', minute: '2-digit'});
                    } else {
                        statusDesc.textContent = user.email;
                    }
                }
            } else {
                // User is signed out
                if (signInBtn) signInBtn.style.display = 'flex';
                if (syncActions) syncActions.style.display = 'none';
                
                if (statusIcon) {
                    statusIcon.classList.remove('synced');
                    statusIcon.classList.add('not-synced');
                    statusIcon.innerHTML = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>';
                }
                if (statusTitle) statusTitle.textContent = 'غير مرتبط';
                if (statusDesc) statusDesc.textContent = 'سجّل دخولك لمزامنة بياناتك';
            }
        }
        
        // ========== THEME TOGGLE ==========
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Update meta theme color
            const metaThemeColor = document.getElementById('theme-color-meta');
            metaThemeColor.content = newTheme === 'dark' ? '#0a0f1a' : '#f1f5f9';
            
            // Update UI
            updateThemeUI(newTheme);
            
            // Haptic feedback
            triggerHaptic('light');
        }
        
        function updateThemeUI(theme) {
            const toggle = document.getElementById('theme-toggle');
            const label = document.getElementById('theme-label');
            const icon = document.getElementById('theme-icon');
            
            if (toggle) toggle.checked = theme === 'light';
            if (label) label.textContent = theme === 'dark' ? 'داكن' : 'فاتح';
            if (icon) {
                icon.innerHTML = theme === 'dark' 
                    ? '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>'
                    : '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>';
            }
        }
        
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeUI(savedTheme);
        }
        
        // ========== PIN LOCK ==========
        let enteredPin = '';
        let setPinStep = 'new'; // 'new', 'confirm'
        let newPinTemp = '';
        let setPinEntry = '';
        
        function isPinEnabled() {
            return localStorage.getItem('pinEnabled') === 'true';
        }
        
        function getStoredPin() {
            return localStorage.getItem('appPin');
        }
        
        function showPinLockScreen() {
            const lockScreen = document.getElementById('pin-lock-screen');
            if (lockScreen) {
                lockScreen.style.display = 'flex';
                enteredPin = '';
                updatePinDots('pin-dots', 0);
            }
        }
        
        function hidePinLockScreen() {
            const lockScreen = document.getElementById('pin-lock-screen');
            if (lockScreen) {
                lockScreen.style.display = 'none';
            }
        }
        
        function enterPin(digit) {
            if (enteredPin.length >= 4) return;
            
            enteredPin += digit;
            updatePinDots('pin-dots', enteredPin.length);
            triggerHaptic('light');
            
            if (enteredPin.length === 4) {
                setTimeout(() => verifyPin(), 150);
            }
        }
        
        function deletePin() {
            if (enteredPin.length > 0) {
                enteredPin = enteredPin.slice(0, -1);
                updatePinDots('pin-dots', enteredPin.length);
                triggerHaptic('light');
            }
        }
        
        function updatePinDots(containerId, filledCount) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const dots = container.querySelectorAll('.pin-dot');
            dots.forEach((dot, index) => {
                dot.classList.remove('filled', 'error');
                if (index < filledCount) {
                    dot.classList.add('filled');
                }
            });
        }
        
        function verifyPin() {
            const storedPin = getStoredPin();
            if (enteredPin === storedPin) {
                triggerHaptic('success');
                
                // Check if we're disabling PIN
                if (window.pinVerifyAction === 'disable') {
                    window.pinVerifyAction = null;
                    localStorage.removeItem('pinEnabled');
                    localStorage.removeItem('appPin');
                    hidePinLockScreen();
                    updatePinSettingsUI();
                    showToast('تم إلغاء قفل PIN');
                } else {
                    hidePinLockScreen();
                }
            } else {
                triggerHaptic('error');
                showPinError();
                enteredPin = '';
            }
        }
        
        function showPinError() {
            const dots = document.querySelectorAll('#pin-dots .pin-dot');
            dots.forEach(dot => {
                dot.classList.add('error');
            });
            document.getElementById('pin-lock-message').textContent = 'رمز خاطئ، حاول مرة أخرى';
            
            setTimeout(() => {
                updatePinDots('pin-dots', 0);
                document.getElementById('pin-lock-message').textContent = window.pinVerifyAction === 'disable' ? 'أدخل الرمز لإلغاء القفل' : 'أدخل الرمز المكون من 4 أرقام';
            }, 600);
        }
        
        function togglePinSetting() {
            const toggle = document.getElementById('pin-toggle');
            if (toggle.checked) {
                // Enable PIN - show set PIN modal
                openSetPinModal();
            } else {
                // Disable PIN - require PIN entry first
                toggle.checked = true; // Keep it checked until verified
                showDisablePinModal();
            }
        }
        
        function showDisablePinModal() {
            // Use the PIN lock screen to verify before disabling
            const lockScreen = document.getElementById('pin-lock-screen');
            document.getElementById('pin-lock-message').textContent = 'أدخل الرمز لإلغاء القفل';
            enteredPin = '';
            updatePinDots('pin-dots', 0);
            lockScreen.style.display = 'flex';
            window.pinVerifyAction = 'disable'; // Flag to know we're disabling
        }
        
        function openSetPinModal() {
            setPinStep = 'new';
            newPinTemp = '';
            setPinEntry = '';
            document.getElementById('set-pin-title').textContent = 'إنشاء رمز PIN';
            document.getElementById('set-pin-message').textContent = 'أدخل رمز مكون من 4 أرقام';
            updatePinDots('set-pin-dots', 0);
            openModal('set-pin');
        }
        
        function openChangePinModal() {
            openSetPinModal();
        }
        
        function closeSetPinModal() {
            closeModal('set-pin');
            // Reset toggle if PIN wasn't set
            if (!isPinEnabled()) {
                document.getElementById('pin-toggle').checked = false;
            }
        }
        
        function enterSetPin(digit) {
            if (setPinEntry.length >= 4) return;
            
            setPinEntry += digit;
            updatePinDots('set-pin-dots', setPinEntry.length);
            triggerHaptic('light');
            
            if (setPinEntry.length === 4) {
                setTimeout(() => processSetPin(), 150);
            }
        }
        
        function deleteSetPin() {
            if (setPinEntry.length > 0) {
                setPinEntry = setPinEntry.slice(0, -1);
                updatePinDots('set-pin-dots', setPinEntry.length);
                triggerHaptic('light');
            }
        }
        
        function processSetPin() {
            if (setPinStep === 'new') {
                newPinTemp = setPinEntry;
                setPinEntry = '';
                setPinStep = 'confirm';
                document.getElementById('set-pin-title').textContent = 'تأكيد رمز PIN';
                document.getElementById('set-pin-message').textContent = 'أدخل الرمز مرة أخرى للتأكيد';
                updatePinDots('set-pin-dots', 0);
            } else {
                if (setPinEntry === newPinTemp) {
                    // PINs match - save
                    localStorage.setItem('appPin', newPinTemp);
                    localStorage.setItem('pinEnabled', 'true');
                    triggerHaptic('success');
                    closeModal('set-pin');
                    updatePinSettingsUI();
                    showToast('تم تفعيل قفل PIN بنجاح');
                } else {
                    // PINs don't match
                    triggerHaptic('error');
                    document.getElementById('set-pin-message').textContent = 'الرمز غير متطابق، حاول مرة أخرى';
                    document.getElementById('set-pin-message').style.color = 'var(--accent-red)';
                    
                    setTimeout(() => {
                        setPinStep = 'new';
                        newPinTemp = '';
                        setPinEntry = '';
                        document.getElementById('set-pin-title').textContent = 'إنشاء رمز PIN';
                        document.getElementById('set-pin-message').textContent = 'أدخل رمز مكون من 4 أرقام';
                        document.getElementById('set-pin-message').style.color = '';
                        updatePinDots('set-pin-dots', 0);
                    }, 1500);
                }
            }
        }
        
        function updatePinSettingsUI() {
            const enabled = isPinEnabled();
            const toggle = document.getElementById('pin-toggle');
            const status = document.getElementById('pin-status');
            const changeItem = document.getElementById('change-pin-item');
            
            if (toggle) toggle.checked = enabled;
            if (status) status.textContent = enabled ? 'مفعّل' : 'غير مفعّل';
            if (changeItem) changeItem.style.display = enabled ? 'flex' : 'none';
        }
        
        // ========== HAPTIC FEEDBACK ==========
        function triggerHaptic(type = 'light') {
            if ('vibrate' in navigator) {
                switch(type) {
                    case 'light':
                        navigator.vibrate(10);
                        break;
                    case 'medium':
                        navigator.vibrate(20);
                        break;
                    case 'success':
                        navigator.vibrate([10, 50, 10]);
                        break;
                    case 'error':
                        navigator.vibrate([50, 30, 50]);
                        break;
                }
            }
        }
        
        // ========== INSTALLMENT ALERTS ==========
        function checkInstallmentAlerts() {
            const today = new Date();
            const currentDay = today.getDate();
            
            installments.forEach(inst => {
                if (inst.remaining > 0 && inst.day) {
                    const daysUntilDue = inst.day - currentDay;
                    
                    // Alert 3 days before or on the day
                    if (daysUntilDue >= 0 && daysUntilDue <= 3) {
                        let message = '';
                        if (daysUntilDue === 0) {
                            message = `قسط "${inst.name}" مستحق اليوم! المبلغ: ${formatMoneyPlain(inst.amount)}`;
                        } else if (daysUntilDue === 1) {
                            message = `قسط "${inst.name}" مستحق غداً. المبلغ: ${formatMoneyPlain(inst.amount)}`;
                        } else {
                            message = `قسط "${inst.name}" مستحق بعد ${daysUntilDue} أيام. المبلغ: ${formatMoneyPlain(inst.amount)}`;
                        }
                        
                        // Check if we already showed this alert today
                        const alertKey = `installment_alert_${inst.id}_${today.toDateString()}`;
                        if (!localStorage.getItem(alertKey)) {
                            showInstallmentAlert(message);
                            localStorage.setItem(alertKey, 'true');
                        }
                    }
                }
            });
        }
        
        function showInstallmentAlert(message) {
            const toast = document.getElementById('installment-alert-toast');
            const messageEl = document.getElementById('alert-toast-message');
            
            if (toast && messageEl) {
                messageEl.textContent = message;
                toast.style.display = 'flex';
                
                // Auto hide after 8 seconds
                setTimeout(() => {
                    closeAlertToast();
                }, 8000);
            }
        }
        
        function closeAlertToast() {
            const toast = document.getElementById('installment-alert-toast');
            if (toast) {
                toast.style.display = 'none';
            }
        }
        
        // ========== PULL TO REFRESH ==========
        let pullStartY = 0;
        let isPulling = false;
        
        function initPullToRefresh() {
            const mainContent = document.body;
            
            mainContent.addEventListener('touchstart', (e) => {
                if (window.scrollY === 0) {
                    pullStartY = e.touches[0].clientY;
                    isPulling = true;
                }
            }, { passive: true });
            
            mainContent.addEventListener('touchmove', (e) => {
                if (!isPulling) return;
                
                const pullDistance = e.touches[0].clientY - pullStartY;
                if (pullDistance > 60 && window.scrollY === 0) {
                    showPullIndicator();
                }
            }, { passive: true });
            
            mainContent.addEventListener('touchend', () => {
                if (isPulling) {
                    isPulling = false;
                    const indicator = document.querySelector('.pull-indicator');
                    if (indicator && indicator.classList.contains('visible')) {
                        // Refresh
                        triggerHaptic('medium');
                        updateUI();
                        
                        setTimeout(() => {
                            hidePullIndicator();
                        }, 500);
                    }
                }
            });
        }
        
        function showPullIndicator() {
            let indicator = document.querySelector('.pull-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.className = 'pull-indicator';
                indicator.innerHTML = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg><span>جاري التحديث...</span>';
                document.body.appendChild(indicator);
            }
            indicator.classList.add('visible');
        }
        
        function hidePullIndicator() {
            const indicator = document.querySelector('.pull-indicator');
            if (indicator) {
                indicator.classList.remove('visible');
            }
        }

        // Init
        loadTheme();
        updatePinSettingsUI();
        
        // Check PIN on load
        if (isPinEnabled()) {
            showPinLockScreen();
        }
        
        initCategories();
        initReportDates();
        updateCurrencyLabels();
        populateCategoryFilter();
        updateUI();
        updateSettingsUI();
        checkFirstTime();
        checkRecurringTransactions();
        checkInstallmentAlerts();
        initPullToRefresh();
        
        // Initialize Firebase for cloud sync
        setTimeout(() => {
            initFirebase();
        }, 500);
        
        // Add event listener for reset button
        document.getElementById('confirm-reset-btn').addEventListener('click', function() {
            confirmReset();
        });
    </script>
    
    <!-- Calendar Overlay -->
    <div id="calendar-overlay" class="calendar-overlay" onclick="closeAllCalendars()"></div>
    
    <!-- Global Calendar Popups -->
    <div class="calendar-popup" id="trans-calendar-from"></div>
    <div class="calendar-popup" id="trans-calendar-to"></div>
    <div class="calendar-popup" id="calendar-from"></div>
    <div class="calendar-popup" id="calendar-to"></div>
    
    <!-- Toast notification -->
    <div id="toast" class="toast"></div>
</body>
</html>
